

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta content="Learn how to build software with cloud native devops and modern build patterns using Docker and Kubernetes." name="description" />
<meta content="devops, Matthew Giassa, Giassa, IAXES, cloud native, cloud, kubernetes, docker, build patterns, containers" name="keywords" />
<meta content="Matthew Giassa" name="author" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>DevOps Build Patterns &mdash; Cloud Native DevOps: Migrating from Monoliths to Microservices 0.0.2 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  
    <link rel="canonical" href="https://iaxes.github.io/pronk8s/sections/build_patterns.html" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Architecture Design Patterns" href="architecture.html" />
    <link rel="prev" title="Configuration Management &amp; Infrastructure as Code" href="config_mgmt.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Cloud Native DevOps: Migrating from Monoliths to Microservices
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="intro.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#donations-and-ethics-disclaimer">Donations and Ethics Disclaimer</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#why-pronk8s">Why PronK8S</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#dedication">Dedication</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#license">License</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cicd.html">Continous Integration &amp; Continuous Delivery</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cicd.html#version-control-and-branching-strategies">Version Control and Branching Strategies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#anarchy-one-branch-to-rule-them-all">Anarchy: One Branch to Rule Them All</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#developer-branches">Developer Branches</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#feature-branches">Feature Branches</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#release-branches">Release Branches</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cicd.html#platforms">Platforms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#github-github-actions">GitHub &amp; GitHub Actions</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#gitlab">GitLab</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#jenkins">Jenkins</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#circle-ci">Circle CI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cicd.html#automation-test-driven-development">Automation &amp; Test Driven Development</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#pipelines">Pipelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#caching-artifacts">Caching Artifacts</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#triggering-downstream-jobs">Triggering Downstream Jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#nightly-weekend-automation-tests">Nightly/weekend automation tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cicd.html#security-concerns-don-t-leak-credentials">Security Concerns: Don’t Leak Credentials</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#run-time-variables">Run-time Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="cicd.html#keyword-masking-and-script-filtering">Keyword Masking and Script Filtering</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="config_mgmt.html">Configuration Management &amp; Infrastructure as Code</a><ul>
<li class="toctree-l2"><a class="reference internal" href="config_mgmt.html#declarative-versus-imperative-models">Declarative Versus Imperative Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="config_mgmt.html#gitops-and-versioning-infrastructure-changes">GitOps and Versioning Infrastructure Changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="config_mgmt.html#rolling-upgrades">Rolling Upgrades</a></li>
<li class="toctree-l2"><a class="reference internal" href="config_mgmt.html#backup-and-restore-operations">Backup and Restore Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="config_mgmt.html#panic-button">Panic Button</a></li>
<li class="toctree-l2"><a class="reference internal" href="config_mgmt.html#tooling">Tooling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="config_mgmt.html#ansible">Ansible</a></li>
<li class="toctree-l3"><a class="reference internal" href="config_mgmt.html#terraform">Terraform</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DevOps Build Patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#bare-metal">Bare Metal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#virtual-machines">Virtual Machines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#history-and-hypervisors">History and Hypervisors</a></li>
<li class="toctree-l3"><a class="reference internal" href="#single-vm-with-vagrant">Single VM with Vagrant</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#containers">Containers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#single-container-with-docker">Single Container with Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-containers-with-docker">Multiple Containers with Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nested-containers-with-docker-in-docker">Nested Containers with Docker-in-Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#advanced-example-single-container-with-docker">Advanced Example: Single Container with Docker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cluster-orchestration-with-kubernetes-k8s">Cluster Orchestration with Kubernetes (K8S)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#kubernetes-in-docker-kind">Kubernetes in Docker (KIND)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#best-practises-security-concerns">Best Practises &amp; Security Concerns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#privileged-containers-rootless-containers">Privileged Containers &amp; Rootless Containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-dockerignore-for-security-and-image-size-reduction">Using dockerignore for Security and Image Size Reduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reducing-image-size-and-number-of-layers-with-apt">Reducing Image Size and Number of Layers with apt</a></li>
<li class="toctree-l3"><a class="reference internal" href="#credential-leaks-don-t-embed-credentials">Credential Leaks - Don’t Embed Credentials</a></li>
<li class="toctree-l3"><a class="reference internal" href="#verify-downloaded-packages-via-checksums">Verify Downloaded Packages via Checksums</a></li>
<li class="toctree-l3"><a class="reference internal" href="#additional-reading">Additional Reading</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture Design Patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#general-structure">General Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#ipc">IPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#storage">Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#logging">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#sidecars">Sidecars</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#debugging-core-dumps-etc">Debugging, Core Dumps, etc.</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing Strategies</a><ul>
<li class="toctree-l2"><a class="reference internal" href="testing.html#pre-amble-containers-clusters">Pre-amble: Containers &amp; Clusters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="testing.html#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#api-tests">API Tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="testing.html#internal-apis-and-unit-testing">Internal APIs and Unit Testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="testing.html#public-facing-api-testing">Public-Facing API Testing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#feature-tests">Feature Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#regression-tests">Regression Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#fuzz-tests">Fuzz Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#negative-testing">Negative Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#mocks-and-simulated-tests">Mocks and Simulated Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#chaos-testing-break-everything-to-improve-your-app">Chaos Testing: Break Everything to Improve your App</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#testing-in-production">Testing in Production</a><ul>
<li class="toctree-l4"><a class="reference internal" href="testing.html#the-historical-joke">The Historical Joke</a></li>
<li class="toctree-l4"><a class="reference internal" href="testing.html#the-reality-of-cicd-and-cloud-environments">The Reality of CICD and Cloud Environments</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="testing.html#regression-tests-statistics">Regression Tests &amp; Statistics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="testing.html#quick-tests-gate-keeping-code-reviews">Quick Tests &amp; Gate Keeping Code Reviews</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#hypothetical-builds-for-downstream-projects">Hypothetical Builds for Downstream Projects</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#soak-tests-finding-obscure-bugs">Soak Tests: Finding Obscure Bugs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="testing.html#end-to-end-tests">End-to-End Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html#testing-in-production-a-misnomer">Testing in Production: a Misnomer?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="testing.html#the-necessity-of-gitops">The Necessity of GitOps</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html#rolling-upgrades-recovery">Rolling Upgrades &amp; Recovery</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="doc.html">Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="doc.html#overview-keeping-documentation-current">Overview: Keeping Documentation Current</a></li>
<li class="toctree-l2"><a class="reference internal" href="doc.html#markup-based-approaches">Markup-based Approaches</a><ul>
<li class="toctree-l3"><a class="reference internal" href="doc.html#read-the-docs-rst-sphinx">Read the Docs: rST + Sphinx</a></li>
<li class="toctree-l3"><a class="reference internal" href="doc.html#markdown">Markdown</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="doc.html#diagrams">Diagrams</a><ul>
<li class="toctree-l3"><a class="reference internal" href="doc.html#plantuml-puml">PlantUML/PUML</a></li>
<li class="toctree-l3"><a class="reference internal" href="doc.html#mermaid-mmd">Mermaid/MMD</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="doc.html#graphical-and-wysiwyg-editors">Graphical and WYSIWYG Editors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="doc.html#bridging-the-gap-guis-for-markup-languages">Bridging the Gap: GUIs for Markup Languages</a></li>
<li class="toctree-l3"><a class="reference internal" href="doc.html#google-docs">Google docs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="sec.html">Security</a><ul>
<li class="toctree-l2"><a class="reference internal" href="sec.html#container-scanning">Container Scanning</a></li>
<li class="toctree-l2"><a class="reference internal" href="sec.html#dependencies-and-supply-chain-attacks">Dependencies and Supply Chain Attacks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="sec.html#poetry">Poetry</a></li>
<li class="toctree-l3"><a class="reference internal" href="sec.html#snyk">Snyk</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sec.html#common-vulnerabilities-and-exposures-cves">Common Vulnerabilities and Exposures (CVEs)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="sec.html#reporting">Reporting</a></li>
<li class="toctree-l3"><a class="reference internal" href="sec.html#documenting">Documenting</a></li>
<li class="toctree-l3"><a class="reference internal" href="sec.html#automatic-testing">Automatic Testing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="project.html">Practical Project: Raspberry Pi DevOps Cluster</a><ul>
<li class="toctree-l2"><a class="reference internal" href="project.html#build-pattern-implementations-language-specific-boilerplate-examples">Build Pattern Implementations: Language-specific Boilerplate Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="project.html#python-3-x">Python 3.x</a></li>
<li class="toctree-l3"><a class="reference internal" href="project.html#go-golang">Go/Golang</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="outro.html">Conclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cloud Native DevOps: Migrating from Monoliths to Microservices</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>DevOps Build Patterns</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="devops-build-patterns">
<span id="sec-build-patterns"></span><h1>DevOps Build Patterns<a class="headerlink" href="#devops-build-patterns" title="Permalink to this headline">¶</a></h1>
<div class="figure align-center" id="fig-wordcloud-build-patterns">
<img alt="../_images/wordcloud_build_patterns.png" src="../_images/wordcloud_build_patterns.png" />
</div>
<p>This chapter will cover what the author refers to as “DevOps build patterns”.
These are effectively common sets of scripts and methods for building software
(i.e.  artifacts, documentation, etc.), with particular emphasis on how
repeatable, reliable, maintainable, and scalable (our four “build pattern
viability metrics”), these approaches are. After going over numerous specific
cases, we will conclude the chapter with examples for re-creating many of these
use cases in a “real world” scenario.</p>
<div class="section" id="bare-metal">
<h2>Bare Metal<a class="headerlink" href="#bare-metal" title="Permalink to this headline">¶</a></h2>
<p>A “bare metal” build pattern is the most simple to initially configure: one
provisions a physical device (i.e. <a class="reference internal" href="glossary.html#term-PC"><span class="xref std std-term">PC</span></a>, development board, Raspberry Pi
hobby kit, etc.) with an operating system, and build tool chain (i.e. compilers,
script interpreters, etc.) to produce build artifacts via some manner of
build/compilation process (e.g. compiling <code class="docutils literal notranslate"><span class="pre">.c</span></code> files with <code class="docutils literal notranslate"><span class="pre">gcc</span></code>, generating
plots with Python scripts, producing documents from <code class="docutils literal notranslate"><span class="pre">.rst</span></code> files with
<code class="docutils literal notranslate"><span class="pre">sphinx</span></code>, etc.).</p>
<p>While initially provisioning such a setup is typically straightforward (e.g.
“install Linux to a new laptop for an engineer/developer”), the end result
leaves much to be desired in terms of our viability metrics. For example, this
approach may be used to provision <a class="reference internal" href="glossary.html#term-PC"><span class="xref std std-term">PCs</span></a> or laptops for individual
developers in one particular manner, and centralized build infrastructure (i.e.
“build servers for production-worthy artifacts”) are provisioned in another
manner. This often gives rise to the age old statement “but it worked on my
machine!”. The software load-out on individual <a class="reference internal" href="glossary.html#term-PC"><span class="xref std std-term">PCs</span></a> may differ from
that on build servers (e.g. due to <a class="reference internal" href="glossary.html#term-IT"><span class="xref std std-term">IT</span></a> security/company policies), or
individual <a class="reference internal" href="glossary.html#term-PC"><span class="xref std std-term">PCs</span></a> may differ among teams (i.e. depending on what
machines were purchased and when, what security updates and system packages
have been installed and if they are kept current/up-to-date, etc.).</p>
<p>This approach is reasonable for new teams and projects, but due to the
potential for variance in builds (i.e. developer <a class="reference internal" href="glossary.html#term-PC"><span class="xref std std-term">PCs</span></a> versus
centralized build servers, or even variances from one developer <a class="reference internal" href="glossary.html#term-PC"><span class="xref std std-term">PC</span></a> to
another), this approach can burn up a lot of engineering time and effort to
maintain long-term. Additionally, without the use of configuration management,
it becomes horrible to maintain and completely unscalable. As soon as the
opportunity arises, seriously consider migrating to something more modern (such
as the examples in the following sections).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Build pattern viability metrics.</p>
<p>Repeatable: yes, but manual and repetetive.</p>
<p>Reliable: yes.</p>
<p>Maintainable: yes, but only via configuration managament or an inordinate
amount of time and resources will have to be invested in maintaining such a
deployment.</p>
<p>Scalable: no. Requires configuration management to be viable, and variance
in hosts/machines leads to additional maintenance requirements.</p>
</div>
</div>
<div class="section" id="virtual-machines">
<h2>Virtual Machines<a class="headerlink" href="#virtual-machines" title="Permalink to this headline">¶</a></h2>
<p>Virtualization, in a simple sense, is an abstraction of real (i.e. typically
physical) resources. For example, virtual machines are abstractions of “real”
machines which can run an entire operating system plus system applications,
with the system being under the impression it’s running on real/physical
hardware, when in reality, it is communicating with virtual hardware (that
eventually communicates, through layers of abstraction/translation, to the
actual underlying physical/real hardware).</p>
<p>This allows, for example, someone running Ubuntu Linux for a 64-bit Intel
processor (i.e. a “real <a class="reference internal" href="glossary.html#term-PC"><span class="xref std std-term">PC</span></a>”, running what is referred to as the “host
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>”), to run a virtualized instance of the Windows XP operating system
(i.e. a “virtual <a class="reference internal" href="glossary.html#term-PC"><span class="xref std std-term">PC</span></a>”, running what is referred to as the “guest
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>) as if it were just another application. Such setups are extremely
useful, as it allows a host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> to run applications for a completely
different <a class="reference internal" href="glossary.html#term-CPU"><span class="xref std std-term">CPU</span></a>/architecture and/or <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>, without requiring the
actual hardware (which may no longer be available due to production ceasing) to
run the guest <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> and the applications it supports. This typically comes
with a cost: virtualization is expensive in terms of <a class="reference internal" href="glossary.html#term-CPU"><span class="xref std std-term">CPU</span></a> and memory
overhead. Provided that the virtualization software itself is maintained, one
could run an old legacy application for a long-dead architecture years after
hardware is no longer available (though, ideally, one would not allow a
critical business element to rely on end-of-life unsupported software
long-term).</p>
<div class="section" id="history-and-hypervisors">
<h3>History and Hypervisors<a class="headerlink" href="#history-and-hypervisors" title="Permalink to this headline">¶</a></h3>
<p>While virtualization in the field of computer science has been around for a
long time (e.g. the evolution of the IBM CP-40 into the CP-67 in the 1960s,
allowing for multiple concurrent application execution <span id="id1">[<a class="reference internal" href="references.html#id3" title="Shashank Mohan Jain. Linux Containers and Virtualization. Apress, India, 2020.">1</a>]</span>), we will
focus primarily on a cursory analysis of more recent developments, particularly
in the context of <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a> and containers.</p>
<p>With this in mind, we introduce the concept of a hypervisor (also referred to
as a virtual machine monitor, or <a class="reference internal" href="glossary.html#term-VMM"><span class="xref std std-term">VMM</span></a>): specialized software used to
virtualize (i.e. abstract) an <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>. The primary responsibilities of the
hypervisor are to provide (for the guest <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>) abstractions of hardware
(i.e. virtual hardware that eventually maps to real hardware), and to handle or
“trap” system calls (<a class="reference internal" href="glossary.html#term-API"><span class="xref std std-term">APIs</span></a> provided by an operating system for
requesting specific, usually privileged, functionality from the kernel;
<span id="id2">[<a class="reference internal" href="references.html#id4" title="Andrew Tanenbaum, Herbert Bos. Modern Operating Systems, Fourth Edition. Pearson, India, 2014.">2</a>]</span>).</p>
<p>Diving further into hypervisors, there are two types of hypervisor (well,
three, but two of relevance to this chapter): “type 1” and “type 2”
hypervisors. First, with type 2 hypervisors, a simplified summary would be that
type 2 hypervisors require various operations to be delegated or otherwise
translated by the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> on behalf of the guest <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>. This
results in a “true virtualization” of the guest <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>, at the expense of
increased overhead (and by extension, decreased performance by the guest
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>). If we consider <a class="reference internal" href="#protection-rings-0"><span class="std std-numref">Fig. 2</span></a> <span id="id3">[<a class="reference internal" href="references.html#id5" title="Intel Corporation. Intel® 64 and IA-32 Architectures Software Developer’s Manual Volume 3A: System Programming Guide, Part 1. \url https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.pdf, accessed 2021-07-24.">3</a>]</span>, the
guest <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> will run (typically, not always the case) in ring 3, and
operations such as system calls and hardware access are trapped by the host
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> (whose kernel is the sole software entity with access to ring 0).</p>
<div class="figure align-center" id="protection-rings-0">
<img alt="../_images/protection_rings_0.png" src="../_images/protection_rings_0.png" />
<p class="caption"><span class="caption-number">Fig. 2 </span><span class="caption-text">Protection rings on Intel architecture.</span><a class="headerlink" href="#protection-rings-0" title="Permalink to this image">¶</a></p>
</div>
<p>In the case of a type 1 hypervisor, additional hardware support in the
<a class="reference internal" href="glossary.html#term-CPU"><span class="xref std std-term">CPU</span></a> (i.e. Intel VT-x “Vanderpool” or AMD V “Pacifica”, and their modern
successors/counterparts) allows for the guest <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> to have direct access
to the underlying physical hardware, permitting for a drastic improvement in
performance. If we consider <a class="reference internal" href="#protection-rings-1"><span class="std std-numref">Fig. 3</span></a>, in the context of a
type 1 hypervisor, the guest <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>, still running in ring 3, is able to
access the hardware in a much more direct manner through the hypervisor. It is
worth noting that, in actuality, there are only really 4 rings (i.e. 0, 1, 2,
and 3). The negative rings are really all processor features/extensions that
are applied to or otherwise relate to ring 0. In any case, the key takeaway is
that a type 1 hypervisor allows for improved performance through reduced
overhead.</p>
<div class="figure align-center" id="protection-rings-1">
<img alt="../_images/protection_rings_1.png" src="../_images/protection_rings_1.png" />
<p class="caption"><span class="caption-number">Fig. 3 </span><span class="caption-text">Protection rings on Intel architecture (real and synthetic).</span><a class="headerlink" href="#protection-rings-1" title="Permalink to this image">¶</a></p>
</div>
<p>So, we’ve established that <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a> allow for a convenient way to run
software intended for combinations of <a class="reference internal" href="glossary.html#term-CPU"><span class="xref std std-term">CPU</span></a> architectures and
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OSs</span></a> in a guest <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>, even if it differs wildly from the host
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>. <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a> are also portable as a side effect of this (i.e.
pre-built <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a> setups can be easily copied between different physical
host machines and re-used, provided the varying machines have the appropriate
virtualization software present), allowing for varying degrees of scalability as
well. This this being said, we will move on to the topic of containers.</p>
<p>Containers can be thought of as “lightweight virtual machines”. Rather than
employing the use of a hypervisor, containers are essentially means of running
software on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> in private, isolated environments. A very
primitive approach to containers, known as a “<code class="docutils literal notranslate"><span class="pre">chroot</span></code> jail”, has been
available for nearly 20 years now (at the time of the writing of this
document). However, containers employ a greater degree of control and
protection mechanisms, using three particularly useful Linux features:</p>
<ul class="simple">
<li><p>Namespaces (i.e. for isolation of file systems, hostnames, <a class="reference internal" href="glossary.html#term-IPC"><span class="xref std std-term">IPC</span></a>,
network resources, etc. <span id="id4">[<a class="reference internal" href="references.html#id7" title="Michael Kerrisk. namespaces(7) — Linux manual page. \url https://man7.org/linux/man-pages/man7/namespaces.7.html, accessed 2021-07-24.">4</a>]</span>).</p></li>
<li><p>Control groups, or “cgroups” (i.e. for logically grouping processes and
applying monitor and limits on them, such as quotas on <a class="reference internal" href="glossary.html#term-CPU"><span class="xref std std-term">CPU</span></a> and
<a class="reference internal" href="glossary.html#term-RAM"><span class="xref std std-term">RAM</span></a> usage, for example).</p></li>
<li><p>Union mounts (i.e. a means of taking multiple folders and “stacking” them to
create a virtual abstraction of the contents of all the folders in
aggregate).</p></li>
</ul>
<p>Through the use of these Linux-specific pieces of functionality, isolated
execution environments, referred to as “containers”, can allow for applications
to run securely and independently from each other, relatively oblivious to the
fact that they are executing within a container framework. The lack of a
hypervisor and the associated virtualization mechanisms means that there is a
significant improvement in performance over traditional virtualization solutions
<span id="id5">[<a class="reference internal" href="references.html#id10" title="Zhang et al. A Comparative Study of Containers and Virtual Machines in Big Data Environment. \url https://arxiv.org/pdf/1807.01842.pdf, accessed 2021-07-24.">5</a>]</span> <span id="id6">[<a class="reference internal" href="references.html#id11" title="Sumit Maheshwari, Saurabh Deochake, Ridip De, Anish Grover. Comparative Study of Virtual Machines and Containers for DevOps Developers. \url https://arxiv.org/pdf/1808.08192.pdf, accessed 2021-07-24.">6</a>]</span> <span id="id7">[<a class="reference internal" href="references.html#id12" title="Roger Rogers and Susan Proietti Conti. Virtual Machines versus containers. \url https://www.ibm.com/downloads/cas/POANK8YE, accessed 2021-07-24.">7</a>]</span>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These container technologies can be utilized on non-Linux operating systems
such as Apple’s OSX, or Microsoft Windows; but they are actually containers
running within a hypervisor-based virtualization solution, so a massive
amount of additional overhead is incurred on non-Linux systems. This has
the unfortunate consequence of negating most of the benefits containers
supply, namely improved performance and no need for a hypervisor.</p>
</div>
<p>There is one potential downside to this: the containers directly re-use the
same kernel as the host operating system (i.e. Linux). If one wishes to use
different kernel-specific features and drivers, for example, the host
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OSs</span></a> kernel must support it, or it won’t be available to
applications/services running within the containers.  It also implies that the
software running in the containers must be compiled for the same <a class="reference internal" href="glossary.html#term-CPU"><span class="xref std std-term">CPU</span></a>
architecture and <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> as the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>.  There is a loss of
portability, but the trade-off is a significant boost in performance and an
astounding increase in scalability (more on this when we discuss <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a>
and cluster orchestration in later sections).</p>
<p>With the topics of <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a> and containers being briefly covered, let’s
move on to applications making use of the aforementioned technologies. Should
the reader wish to go into this topic in greater detail, please refer to
<span id="id8">[<a class="reference internal" href="references.html#id3" title="Shashank Mohan Jain. Linux Containers and Virtualization. Apress, India, 2020.">1</a>]</span> and <span id="id9">[<a class="reference internal" href="references.html#id6" title="Tavis Ormandy and Julien Tinne, Google Inc. Virtualisation security and the Intel privilege model. \url https://www.cr0.org/paper/jt-to-virtualisation_security.pdf, accessed 2021-07-24.">8</a>]</span>.</p>
</div>
<div class="section" id="single-vm-with-vagrant">
<h3>Single VM with Vagrant<a class="headerlink" href="#single-vm-with-vagrant" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section just scratches the surface on the topic of <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a>.
Tools such as Terraform <span id="id10">[<a class="reference internal" href="references.html#id38" title="HashiCorp. Write, Plan, Apply: Terraform - by HashiCorp). \url https://www.terraform.io/, accessed 2021-08-07.">9</a>]</span>, for example, can be used to
provision entire cloud infrastructure deployments in environments such as
Amazon <a class="reference internal" href="glossary.html#term-EC2"><span class="xref std std-term">EC2</span></a>, Microsoft <a class="reference internal" href="glossary.html#term-Azure"><span class="xref std std-term">Azure</span></a>, Google <a class="reference internal" href="glossary.html#term-GCP"><span class="xref std std-term">GCP</span></a>, etc.; and
can deploy virtul machines at scale efficiently and effectively. While the
rest of this chapter focuses heavily on containers and <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a>, don’t
disqualify the use of <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a>, especially in off-site cloud
environments like the aforementioned service providers.</p>
</div>
<p>At least topically, using a single <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a> as a builder appears to be very
similar to bare metal builder:</p>
<ul class="simple">
<li><p>Both represent a complete appliance/host, with a dedicated operating system
(albeit virtualized).</p></li>
<li><p>Both require tooling such as configuration management to keep them up-to-date
and secure.</p></li>
<li><p>Both can be controlled in similar manners (i.e. via a graphical window
manager or connecting via command line tools like <code class="docutils literal notranslate"><span class="pre">ssh</span></code>).</p></li>
</ul>
<p>Where <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a> really shine is in their provisioning and portability.
Using tools like HashiCorp <code class="docutils literal notranslate"><span class="pre">vagrant</span></code> <span id="id11">[<a class="reference internal" href="references.html#id13" title="Roger Rogers and Susan Proietti Conti. Vagrant by HashiCorp. \url https://www.vagrantup.com/, accessed 2021-07-24.">10</a>]</span>, for example, one may
write scripts in a structured and standardized manner to produce a virtual
machine on-demand.  Rather than manually creating a virtual machine and
provisioning it (i.e.  configuring an <code class="docutils literal notranslate"><span class="pre">ISO</span></code> image containing the guest
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OSs</span></a> installation files as a virtual optical drive, “connecting” it
to the <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a>, installing the guest <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> and relevant applications,
configuring said applications, etc.), one can download pre-created (and
verified/trusted) images for common platforms such as various Linux
distributions (i.e. Ubuntu, Arch, Fedora, etc.), and add customizations on
afterwards (i.e. additional/custom packages, scripts, pre-compiled binaries,
etc.). This removes one of the largest (and most tedious) steps involved in
provisioning a bare metal builder, and the final artifact (i.e. the <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a>
image itself) can be trivially copied from one physical host to another for
duplication and re-use (with the appropriate re-provisioning steps in place,
such as randomizing the <a class="reference internal" href="glossary.html#term-MAC"><span class="xref std std-term">MAC</span></a> address of the network adapter and
resetting credentials, etc.).</p>
<p>In addition to being able to rapidly provision <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a> rapidly, they
also lend themself to another especially helpful use case: ephemeral/throw-away
<a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a>. With a bare metal builder, chances are the intent is to
provision it, maintain it regularly, and eventually dispose of it when the need
arises. For such a setup, it is not desirable to have to re-provision it more
than necessary (i.e. if a persistent storage medium fails, for example).
However, there are cases where someone may wish to have a “fresh” deployment
every time a specific job is executed. For example, someone may have a project
that creates the installer (i.e. akin to a <code class="docutils literal notranslate"><span class="pre">deb</span></code> package for an Ubuntu/Debian
system, or a <code class="docutils literal notranslate"><span class="pre">setup.exe</span></code> for a Windows-based system), and has configured a
build pipeline to automatically perform builds of this tool when one of its
components change (i.e. in a <code class="docutils literal notranslate"><span class="pre">git</span></code> repository, due to a commit being pushed).</p>
<p>This is a sound strategy: automatically trigger unit and/or regression tests
via the <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> infrastructure every time a change is introduced into the
code base. If this automated testing is non-destructive (i.e. has minimal or no
ability to adversely impact the host/machine used for testing), this is not a
problem. However, if this testing is destructive (i.e. could corrupt the
software loadout on a host/machine to the point of it outright requiring
re-provisioning, including a re-installation of the <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>), then it’s
going to incur significant overhead by technical staff who now have to
periodically repair/re-image the build host/machine. If we were to use a
<a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a> for this task, we could dramatically cut down on the overhead
involved: just pre-create a “golden” (i.e. known to be in a good, working,
valid state) <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a>, and make a copy of it every time a build job needs to
be triggered (and run said job inside the copy of the “golden” <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a>
image).</p>
<p>When the job has concluded, just delete/discard the modified image that
was just used (after extracting build artifacts, logs, etc.; from it), and
we’re done. This will ensure every build job will have the exact same initial
conditions, cut down on the need for technical staff to re-provision physical
hosts/machines, and due to the inherent portability of <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a>, the
“golden” image can be duplicated across a wide variety of machines (i.e. even
with differing hardware): so long as they all support the same virtualization
framework, they can all make use of the same “golden” image. With this said,
let’s move on to an example where we’ll create an ephemeral/throw-away
<a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a> on-demand, use it to build a small C project, backup the build
artifacts and logs, and then dispose of the <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a> image.</p>
<p>First, we’ll just create a new <code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code> via the command <code class="docutils literal notranslate"><span class="pre">vagrant</span>
<span class="pre">init</span></code>. Next, we’ll customize the minimal/baseline <code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code> to be a bit
more interesting (manually specify some options impacting performance,
configure it to use Ubuntu 20.04 “focal” as the baseline <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>, and
configure it to use a provisioning script to install packages to the <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a>
before we begin using it).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In addition to installing Vagrant (i.e. <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">vagrant</span></code> on
Ubuntu/Debian systems), the reader is also encouraged to install the
<code class="docutils literal notranslate"><span class="pre">vbguest</span></code> plugin to avoid various errors that will require the use of
researching via Google and StackOverflow to resolve (i.e.
<code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">plugin</span> <span class="pre">install</span> <span class="pre">vagrant-vbguest</span></code>).</p>
</div>
<div class="literal-block-wrapper docutils container" id="id53">
<div class="code-block-caption"><span class="caption-number">Listing 1 </span><span class="caption-text">Original Vagrantfile generated via <code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">init</span></code> before we added our modifications to it.</span><a class="headerlink" href="#id53" title="Permalink to this code">¶</a></div>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># -*- mode: ruby -*-</span>
<span class="lineno"> 2 </span><span class="c1"># vi: set ft=ruby :</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1"># All Vagrant configuration is done below. The &quot;2&quot; in Vagrant.configure</span>
<span class="lineno"> 5 </span><span class="c1"># configures the configuration version (we support older styles for</span>
<span class="lineno"> 6 </span><span class="c1"># backwards compatibility). Please don&#39;t change it unless you know what</span>
<span class="lineno"> 7 </span><span class="c1"># you&#39;re doing.</span>
<span class="lineno"> 8 </span><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="lineno"> 9 </span>  <span class="c1"># The most common configuration options are documented and commented below.</span>
<span class="lineno">10 </span>  <span class="c1"># For a complete reference, please see the online documentation at</span>
<span class="lineno">11 </span>  <span class="c1"># https://docs.vagrantup.com.</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span>  <span class="c1"># Every Vagrant development environment requires a box. You can search for</span>
<span class="lineno">14 </span>  <span class="c1"># boxes at https://vagrantcloud.com/search.</span>
<span class="lineno">15 </span>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;base&quot;</span>
<span class="lineno">16 </span>
<span class="lineno">17 </span>  <span class="c1"># Disable automatic box update checking. If you disable this, then</span>
<span class="lineno">18 </span>  <span class="c1"># boxes will only be checked for updates when the user runs</span>
<span class="lineno">19 </span>  <span class="c1"># `vagrant box outdated`. This is not recommended.</span>
<span class="lineno">20 </span>  <span class="c1"># config.vm.box_check_update = false</span>
<span class="lineno">21 </span>
<span class="lineno">22 </span>  <span class="c1"># Create a forwarded port mapping which allows access to a specific port</span>
<span class="lineno">23 </span>  <span class="c1"># within the machine from a port on the host machine. In the example below,</span>
<span class="lineno">24 </span>  <span class="c1"># accessing &quot;localhost:8080&quot; will access port 80 on the guest machine.</span>
<span class="lineno">25 </span>  <span class="c1"># NOTE: This will enable public access to the opened port</span>
<span class="lineno">26 </span>  <span class="c1"># config.vm.network &quot;forwarded_port&quot;, guest: 80, host: 8080</span>
<span class="lineno">27 </span>
<span class="lineno">28 </span>  <span class="c1"># Create a forwarded port mapping which allows access to a specific port</span>
<span class="lineno">29 </span>  <span class="c1"># within the machine from a port on the host machine and only allow access</span>
<span class="lineno">30 </span>  <span class="c1"># via 127.0.0.1 to disable public access</span>
<span class="lineno">31 </span>  <span class="c1"># config.vm.network &quot;forwarded_port&quot;, guest: 80, host: 8080, host_ip: &quot;127.0.0.1&quot;</span>
<span class="lineno">32 </span>
<span class="lineno">33 </span>  <span class="c1"># Create a private network, which allows host-only access to the machine</span>
<span class="lineno">34 </span>  <span class="c1"># using a specific IP.</span>
<span class="lineno">35 </span>  <span class="c1"># config.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.10&quot;</span>
<span class="lineno">36 </span>
<span class="lineno">37 </span>  <span class="c1"># Create a public network, which generally matched to bridged network.</span>
<span class="lineno">38 </span>  <span class="c1"># Bridged networks make the machine appear as another physical device on</span>
<span class="lineno">39 </span>  <span class="c1"># your network.</span>
<span class="lineno">40 </span>  <span class="c1"># config.vm.network &quot;public_network&quot;</span>
<span class="lineno">41 </span>
<span class="lineno">42 </span>  <span class="c1"># Share an additional folder to the guest VM. The first argument is</span>
<span class="lineno">43 </span>  <span class="c1"># the path on the host to the actual folder. The second argument is</span>
<span class="lineno">44 </span>  <span class="c1"># the path on the guest to mount the folder. And the optional third</span>
<span class="lineno">45 </span>  <span class="c1"># argument is a set of non-required options.</span>
<span class="lineno">46 </span>  <span class="c1"># config.vm.synced_folder &quot;../data&quot;, &quot;/vagrant_data&quot;</span>
<span class="lineno">47 </span>
<span class="lineno">48 </span>  <span class="c1"># Provider-specific configuration so you can fine-tune various</span>
<span class="lineno">49 </span>  <span class="c1"># backing providers for Vagrant. These expose provider-specific options.</span>
<span class="lineno">50 </span>  <span class="c1"># Example for VirtualBox:</span>
<span class="lineno">51 </span>  <span class="c1">#</span>
<span class="lineno">52 </span>  <span class="c1"># config.vm.provider &quot;virtualbox&quot; do |vb|</span>
<span class="lineno">53 </span>  <span class="c1">#   # Display the VirtualBox GUI when booting the machine</span>
<span class="lineno">54 </span>  <span class="c1">#   vb.gui = true</span>
<span class="lineno">55 </span>  <span class="c1">#</span>
<span class="lineno">56 </span>  <span class="c1">#   # Customize the amount of memory on the VM:</span>
<span class="lineno">57 </span>  <span class="c1">#   vb.memory = &quot;1024&quot;</span>
<span class="lineno">58 </span>  <span class="c1"># end</span>
<span class="lineno">59 </span>  <span class="c1">#</span>
<span class="lineno">60 </span>  <span class="c1"># View the documentation for the provider you are using for more</span>
<span class="lineno">61 </span>  <span class="c1"># information on available options.</span>
<span class="lineno">62 </span>
<span class="lineno">63 </span>  <span class="c1"># Enable provisioning with a shell script. Additional provisioners such as</span>
<span class="lineno">64 </span>  <span class="c1"># Puppet, Chef, Ansible, Salt, and Docker are also available. Please see the</span>
<span class="lineno">65 </span>  <span class="c1"># documentation for more information about their specific syntax and use.</span>
<span class="lineno">66 </span>  <span class="c1"># config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL</span>
<span class="lineno">67 </span>  <span class="c1">#   apt-get update</span>
<span class="lineno">68 </span>  <span class="c1">#   apt-get install -y apache2</span>
<span class="lineno">69 </span>  <span class="c1"># SHELL</span>
<span class="lineno">70 </span><span class="k">end</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id54">
<div class="code-block-caption"><span class="caption-number">Listing 2 </span><span class="caption-text">Vagrantfile for generating our VM builder.</span><a class="headerlink" href="#id54" title="Permalink to this code">¶</a></div>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># -*- mode: ruby -*-</span>
<span class="lineno"> 2 </span><span class="c1"># vi: set ft=ruby :</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1"># All Vagrant configuration is done below. The &quot;2&quot; in Vagrant.configure</span>
<span class="lineno"> 5 </span><span class="c1"># configures the configuration version (we support older styles for</span>
<span class="lineno"> 6 </span><span class="c1"># backwards compatibility). Please don&#39;t change it unless you know what</span>
<span class="lineno"> 7 </span><span class="c1"># you&#39;re doing.</span>
<span class="lineno"> 8 </span><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<span class="lineno"> 9 </span>  <span class="c1"># The most common configuration options are documented and commented below.</span>
<span class="lineno">10 </span>  <span class="c1"># For a complete reference, please see the online documentation at</span>
<span class="lineno">11 </span>  <span class="c1"># https://docs.vagrantup.com.</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span>  <span class="c1"># Every Vagrant development environment requires a box. You can search for</span>
<span class="lineno">14 </span>  <span class="c1"># boxes at https://vagrantcloud.com/search.</span>
<span class="lineno">15 </span>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/focal64&quot;</span>
<span class="lineno">16 </span>
<span class="lineno">17 </span>  <span class="c1"># Disable automatic box update checking. If you disable this, then</span>
<span class="lineno">18 </span>  <span class="c1"># boxes will only be checked for updates when the user runs</span>
<span class="lineno">19 </span>  <span class="c1"># `vagrant box outdated`. This is not recommended.</span>
<span class="lineno">20 </span>  <span class="c1"># config.vm.box_check_update = false</span>
<span class="lineno">21 </span>
<span class="lineno">22 </span>  <span class="c1"># Create a forwarded port mapping which allows access to a specific port</span>
<span class="lineno">23 </span>  <span class="c1"># within the machine from a port on the host machine. In the example below,</span>
<span class="lineno">24 </span>  <span class="c1"># accessing &quot;localhost:8080&quot; will access port 80 on the guest machine.</span>
<span class="lineno">25 </span>  <span class="c1"># NOTE: This will enable public access to the opened port</span>
<span class="lineno">26 </span>  <span class="c1"># config.vm.network &quot;forwarded_port&quot;, guest: 80, host: 8080</span>
<span class="lineno">27 </span>
<span class="lineno">28 </span>  <span class="c1"># Create a forwarded port mapping which allows access to a specific port</span>
<span class="lineno">29 </span>  <span class="c1"># within the machine from a port on the host machine and only allow access</span>
<span class="lineno">30 </span>  <span class="c1"># via 127.0.0.1 to disable public access</span>
<span class="lineno">31 </span>  <span class="c1"># config.vm.network &quot;forwarded_port&quot;, guest: 80, host: 8080, host_ip: &quot;127.0.0.1&quot;</span>
<span class="lineno">32 </span>
<span class="lineno">33 </span>  <span class="c1"># Create a private network, which allows host-only access to the machine</span>
<span class="lineno">34 </span>  <span class="c1"># using a specific IP.</span>
<span class="lineno">35 </span>  <span class="c1"># config.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.10&quot;</span>
<span class="lineno">36 </span>
<span class="lineno">37 </span>  <span class="c1"># Create a public network, which generally matched to bridged network.</span>
<span class="lineno">38 </span>  <span class="c1"># Bridged networks make the machine appear as another physical device on</span>
<span class="lineno">39 </span>  <span class="c1"># your network.</span>
<span class="lineno">40 </span>  <span class="c1"># config.vm.network &quot;public_network&quot;</span>
<span class="lineno">41 </span>
<span class="lineno">42 </span>  <span class="c1"># Share an additional folder to the guest VM. The first argument is</span>
<span class="lineno">43 </span>  <span class="c1"># the path on the host to the actual folder. The second argument is</span>
<span class="lineno">44 </span>  <span class="c1"># the path on the guest to mount the folder. And the optional third</span>
<span class="lineno">45 </span>  <span class="c1"># argument is a set of non-required options.</span>
<span class="lineno">46 </span>  <span class="c1"># config.vm.synced_folder &quot;../data&quot;, &quot;/vagrant_data&quot;</span>
<span class="lineno">47 </span>
<span class="lineno">48 </span>  <span class="c1"># Provider-specific configuration so you can fine-tune various</span>
<span class="lineno">49 </span>  <span class="c1"># backing providers for Vagrant. These expose provider-specific options.</span>
<span class="lineno">50 </span>  <span class="c1"># Example for VirtualBox:</span>
<span class="lineno">51 </span>  <span class="c1">#</span>
<span class="lineno">52 </span>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
<span class="lineno">53 </span>    <span class="c1"># Display the VirtualBox GUI when booting the machine</span>
<span class="lineno">54 </span>    <span class="c1"># Nah, let&#39;s do everything via console/shell/command-line.</span>
<span class="lineno">55 </span>    <span class="n">vb</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="kp">false</span>
<span class="lineno">56 </span>
<span class="lineno">57 </span>    <span class="c1"># Customize the amount of memory on the VM:</span>
<span class="lineno">58 </span>    <span class="n">vb</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="s2">&quot;2048&quot;</span>
<span class="lineno">59 </span>
<span class="lineno">60 </span>    <span class="c1"># Add more cores.</span>
<span class="lineno">61 </span>    <span class="n">vb</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="mi">2</span>
<span class="lineno">62 </span>  <span class="k">end</span>
<span class="lineno">63 </span>
<span class="lineno">64 </span>  <span class="c1"># Run our deployment script during `vagrant up --provision` (or first</span>
<span class="lineno">65 </span>  <span class="c1"># `vagrant up`) operation.</span>
<span class="lineno">66 </span>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s2">&quot;deploy.sh&quot;</span>
<span class="lineno">67 </span>
<span class="lineno">68 </span>  <span class="c1"># View the documentation for the provider you are using for more</span>
<span class="lineno">69 </span>  <span class="c1"># information on available options.</span>
<span class="lineno">70 </span>
<span class="lineno">71 </span>  <span class="c1"># Enable provisioning with a shell script. Additional provisioners such as</span>
<span class="lineno">72 </span>  <span class="c1"># Puppet, Chef, Ansible, Salt, and Docker are also available. Please see the</span>
<span class="lineno">73 </span>  <span class="c1"># documentation for more information about their specific syntax and use.</span>
<span class="lineno">74 </span>  <span class="c1"># config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL</span>
<span class="lineno">75 </span>  <span class="c1">#   apt-get update</span>
<span class="lineno">76 </span>  <span class="c1">#   apt-get install -y apache2</span>
<span class="lineno">77 </span>  <span class="c1"># SHELL</span>
<span class="lineno">78 </span><span class="k">end</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id55">
<div class="code-block-caption"><span class="caption-number">Listing 3 </span><span class="caption-text">Difference between original and modified Vagrantfiles.</span><a class="headerlink" href="#id55" title="Permalink to this code">¶</a></div>
<div class="highlight-udiff notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="gd">--- /work/examples/build_patterns/vm_example/Vagrantfile.original</span>
<span class="lineno"> 2 </span><span class="gi">+++ /work/examples/build_patterns/vm_example/Vagrantfile</span>
<span class="lineno"> 3 </span><span class="gu">@@ -12,7 +12,7 @@</span>
<span class="lineno"> 4 </span> 
<span class="lineno"> 5 </span>   # Every Vagrant development environment requires a box. You can search for
<span class="lineno"> 6 </span>   # boxes at https://vagrantcloud.com/search.
<span class="lineno"> 7 </span><span class="gd">-  config.vm.box = &quot;base&quot;</span>
<span class="lineno"> 8 </span><span class="gi">+  config.vm.box = &quot;ubuntu/focal64&quot;</span>
<span class="lineno"> 9 </span> 
<span class="lineno">10 </span>   # Disable automatic box update checking. If you disable this, then
<span class="lineno">11 </span>   # boxes will only be checked for updates when the user runs
<span class="lineno">12 </span><span class="gu">@@ -49,14 +49,22 @@</span>
<span class="lineno">13 </span>   # backing providers for Vagrant. These expose provider-specific options.
<span class="lineno">14 </span>   # Example for VirtualBox:
<span class="lineno">15 </span>   #
<span class="lineno">16 </span><span class="gd">-  # config.vm.provider &quot;virtualbox&quot; do |vb|</span>
<span class="lineno">17 </span><span class="gd">-  #   # Display the VirtualBox GUI when booting the machine</span>
<span class="lineno">18 </span><span class="gd">-  #   vb.gui = true</span>
<span class="lineno">19 </span><span class="gd">-  #</span>
<span class="lineno">20 </span><span class="gd">-  #   # Customize the amount of memory on the VM:</span>
<span class="lineno">21 </span><span class="gd">-  #   vb.memory = &quot;1024&quot;</span>
<span class="lineno">22 </span><span class="gd">-  # end</span>
<span class="lineno">23 </span><span class="gd">-  #</span>
<span class="lineno">24 </span><span class="gi">+  config.vm.provider &quot;virtualbox&quot; do |vb|</span>
<span class="lineno">25 </span><span class="gi">+    # Display the VirtualBox GUI when booting the machine</span>
<span class="lineno">26 </span><span class="gi">+    # Nah, let&#39;s do everything via console/shell/command-line.</span>
<span class="lineno">27 </span><span class="gi">+    vb.gui = false</span>
<span class="lineno">28 </span><span class="gi">+</span>
<span class="lineno">29 </span><span class="gi">+    # Customize the amount of memory on the VM:</span>
<span class="lineno">30 </span><span class="gi">+    vb.memory = &quot;2048&quot;</span>
<span class="lineno">31 </span><span class="gi">+</span>
<span class="lineno">32 </span><span class="gi">+    # Add more cores.</span>
<span class="lineno">33 </span><span class="gi">+    vb.cpus = 2</span>
<span class="lineno">34 </span><span class="gi">+  end</span>
<span class="lineno">35 </span><span class="gi">+</span>
<span class="lineno">36 </span><span class="gi">+  # Run our deployment script during `vagrant up --provision` (or first</span>
<span class="lineno">37 </span><span class="gi">+  # `vagrant up`) operation.</span>
<span class="lineno">38 </span><span class="gi">+  config.vm.provision &quot;shell&quot;, path: &quot;deploy.sh&quot;</span>
<span class="lineno">39 </span><span class="gi">+</span>
<span class="lineno">40 </span>   # View the documentation for the provider you are using for more
<span class="lineno">41 </span>   # information on available options.
<span class="lineno">42 </span> 
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id56">
<div class="code-block-caption"><span class="caption-number">Listing 4 </span><span class="caption-text">Provisioning script to supplement Vagrantfile (Ansible playbooks are preferable in general).</span><a class="headerlink" href="#id56" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/bin/bash</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c1"># Install some packages.</span>
<span class="lineno"> 4 </span>sudo apt update -y
<span class="lineno"> 5 </span>sudo apt install -y <span class="se">\</span>
<span class="lineno"> 6 </span>    automake <span class="se">\</span>
<span class="lineno"> 7 </span>    binutils <span class="se">\</span>
<span class="lineno"> 8 </span>    cmake <span class="se">\</span>
<span class="lineno"> 9 </span>    coreutils <span class="se">\</span>
<span class="lineno">10 </span>    cowsay <span class="se">\</span>
<span class="lineno">11 </span>    gcc <span class="se">\</span>
<span class="lineno">12 </span>    iftop <span class="se">\</span>
<span class="lineno">13 </span>    iproute2 <span class="se">\</span>
<span class="lineno">14 </span>    iputils-ping <span class="se">\</span>
<span class="lineno">15 </span>    lolcat <span class="se">\</span>
<span class="lineno">16 </span>    make <span class="se">\</span>
<span class="lineno">17 </span>    net-tools <span class="se">\</span>
<span class="lineno">18 </span>    nmap <span class="se">\</span>
<span class="lineno">19 </span>    python3 <span class="se">\</span>
<span class="lineno">20 </span>    python3-dev <span class="se">\</span>
<span class="lineno">21 </span>    python3-pip <span class="se">\</span>
<span class="lineno">22 </span>    toilet
<span class="lineno">23 </span>
<span class="lineno">24 </span><span class="c1"># Some helpful python tools.</span>
<span class="lineno">25 </span>sudo pip3 install <span class="se">\</span>
<span class="lineno">26 </span>    flake8 <span class="se">\</span>
<span class="lineno">27 </span>    pylint
<span class="lineno">28 </span>
<span class="lineno">29 </span>sudo apt clean -y
</pre></div>
</div>
</div>
<p>Now, we’ll launch our <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a> via <code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">up</span></code>, and see what happens (lots
of console output is generated, so we’ll have to trim it to keep just the
relevant bits).</p>
<div class="literal-block-wrapper docutils container" id="id57">
<div class="code-block-caption"><span class="caption-number">Listing 5 </span><span class="caption-text">Launching a Vagrant VM (virtulbox provider/hypervisor).</span><a class="headerlink" href="#id57" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Start booting and configuring the VM.</span>
<span class="lineno"> 2 </span>owner@darkstar$&gt; vagrant up
<span class="lineno"> 3 </span>Bringing machine <span class="s1">&#39;default&#39;</span> up with <span class="s1">&#39;virtualbox&#39;</span> provider...
<span class="lineno"> 4 </span><span class="o">==</span>&gt; default: Importing base box <span class="s1">&#39;ubuntu/focal64&#39;</span>...
<span class="lineno"> 5 </span><span class="o">==</span>&gt; default: Matching MAC address <span class="k">for</span> NAT networking...
<span class="lineno"> 6 </span><span class="o">==</span>&gt; default: Checking <span class="k">if</span> box <span class="s1">&#39;ubuntu/focal64&#39;</span> version <span class="s1">&#39;20210803.0.0&#39;</span> is up to date...
<span class="lineno"> 7 </span><span class="o">==</span>&gt; default: Setting the name of the VM: <span class="nv">vm_example_default_1628615617134_78200</span>
<span class="lineno"> 8 </span><span class="o">==</span>&gt; default: Clearing any previously <span class="nb">set</span> network interfaces...
<span class="lineno"> 9 </span><span class="o">==</span>&gt; default: Preparing network interfaces based on configuration...
<span class="lineno">10 </span>    default: Adapter <span class="m">1</span>: <span class="nv">nat</span>
<span class="lineno">11 </span><span class="o">==</span>&gt; default: Forwarding ports...
<span class="lineno">12 </span>    default: <span class="m">22</span> <span class="o">(</span>guest<span class="o">)</span> <span class="o">=</span>&gt; <span class="m">2222</span> <span class="o">(</span>host<span class="o">)</span> <span class="o">(</span>adapter <span class="m">1</span><span class="o">)</span>
<span class="lineno">13 </span>...
<span class="lineno">14 </span>...
<span class="lineno">15 </span>...
<span class="lineno">16 </span>
<span class="lineno">17 </span><span class="c1"># Now it&#39;s successfully running our provisioning script.</span>
<span class="lineno">18 </span>The following additional packages will be installed:
<span class="lineno">19 </span>  binutils binutils-common binutils-x86-64-linux-gnu build-essential cpp cpp-9
<span class="lineno">20 </span>  dctrl-tools dpkg-dev fakeroot g++ g++-9 gcc gcc-9 gcc-9-base
<span class="lineno">21 </span>  libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl
<span class="lineno">22 </span>  libasan5 libatomic1 libbinutils libc-dev-bin libc6-dev libcc1-0 libcrypt-dev
<span class="lineno">23 </span>  libctf-nobfd0 libctf0 libdpkg-perl libfakeroot libfile-fcntllock-perl
<span class="lineno">24 </span>  libgcc-9-dev libgomp1 libisl22 libitm1 liblsan0 libmpc3 libquadmath0
<span class="lineno">25 </span>  libasan5 libatomic1 libbinutils libc-dev-bin libc6-dev libcc1-0 libcrypt-dev
<span class="lineno">26 </span>  libctf-nobfd0 libctf0 libdpkg-perl libfakeroot libfile-fcntllock-perl
<span class="lineno">27 </span>  libgcc-9-dev libgomp1 libisl22 libitm1 liblsan0 libmpc3 libquadmath0
<span class="lineno">28 </span>  libstdc++-9-dev libtsan0 libubsan1 linux-libc-dev make manpages-dev
<span class="lineno">29 </span><span class="m">0</span> upgraded, <span class="m">43</span> newly installed, <span class="m">0</span> to remove and <span class="m">0</span> not upgraded.
<span class="lineno">30 </span>Need to get <span class="m">43</span>.1 MB of archives.
<span class="lineno">31 </span>After this operation, <span class="m">189</span> MB of additional disk space will be used.
<span class="lineno">32 </span>...
<span class="lineno">33 </span>...
<span class="lineno">34 </span>...
<span class="lineno">35 </span>
<span class="lineno">36 </span><span class="c1"># And we&#39;re eventually returned to our shell. Let&#39;s log in to the VM via SSH:</span>
<span class="lineno">37 </span><span class="o">[</span><span class="m">10</span>:14:57<span class="o">]</span>: owner@darkstar$&gt; vagrant ssh
<span class="lineno">38 </span>Welcome to Ubuntu <span class="m">20</span>.04.2 LTS <span class="o">(</span>GNU/Linux <span class="m">5</span>.4.0-80-generic x86_64<span class="o">)</span>
<span class="lineno">39 </span>
<span class="lineno">40 </span> * Documentation:  https://help.ubuntu.com
<span class="lineno">41 </span> * Management:     https://landscape.canonical.com
<span class="lineno">42 </span> * Support:        https://ubuntu.com/advantage
<span class="lineno">43 </span>
<span class="lineno">44 </span>  System information as of Tue Aug <span class="m">10</span> <span class="m">17</span>:22:57 UTC <span class="m">2021</span>
<span class="lineno">45 </span>
<span class="lineno">46 </span>  System load:  <span class="m">0</span>.0               Processes:               <span class="m">119</span>
<span class="lineno">47 </span>  Usage of /:   <span class="m">4</span>.3% of <span class="m">38</span>.71GB   Users logged in:         <span class="m">0</span>
<span class="lineno">48 </span>  Memory usage: <span class="m">12</span>%               IPv4 address <span class="k">for</span> enp0s3: <span class="m">10</span>.0.2.15
<span class="lineno">49 </span>  Swap usage:   <span class="m">0</span>%
<span class="lineno">50 </span>
<span class="lineno">51 </span>
<span class="lineno">52 </span><span class="m">1</span> update can be applied immediately.
<span class="lineno">53 </span>To see these additional updates run: apt list --upgradable
<span class="lineno">54 </span>
<span class="lineno">55 </span><span class="c1"># We&#39;re in: it works. Time to call it a day.</span>
<span class="lineno">56 </span>vagrant@ubuntu-focal:~$ <span class="nb">logout</span>
<span class="lineno">57 </span>Connection to <span class="m">127</span>.0.0.1 closed.
</pre></div>
</div>
</div>
<p>Vagrant is a large topic that can encompass several books, so the reader is
left to conduct their own research and learning/training exercises to become
more versed in its use (if desired). The goal of this section has been
accomplished: demonstrating how easy it is to rapidly prepare and deploy a
<a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a> via a tool like Vagrant (and using an <a class="reference internal" href="glossary.html#term-IAC"><span class="xref std std-term">IAC</span></a> approach no less).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Build pattern viability metrics.</p>
<p>Repeatable: very repeatable. Use of infrastructure-as-code techniques via
Vagrantfiles allows us to achieve a high level of repeatability (similar to
Docker containers; described later).</p>
<p>Reliable: generally reliable. Attempting to access specific hardware (e.g.
<a class="reference internal" href="glossary.html#term-USB"><span class="xref std std-term">USB</span></a>-passthrough) can, in the author’s experience, lead to stability
problems (although such use cases are never typically encountered when using
<a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a> as dedicated builders, so it’s a moot point.</p>
<p>Maintainable: in the case of long-lived <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a>, maintainable as
long as configuration management is used (similar to bare metal hosts). In
the case of ephemeral/throwaway <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a>, very maintainable (similar
to Docker containers, as we just invoke them on-demand, and discard them
when no longer needed).</p>
<p>Scalable: generally scalable vertically (due to hardware acceleration being
available for most hypervisors) and horizontally (i.e. via tools like
Terraform). More resource overhead than containers, but still manageable.</p>
</div>
</div>
</div>
<div class="section" id="containers">
<h2>Containers<a class="headerlink" href="#containers" title="Permalink to this headline">¶</a></h2>
<p>One of the most (in recent memory) ubiquitous and useful patterns (in my own
opinion) is container-based build patterns. As the following examples will
show, they not only scale exceptionally well, but they are very easy to
extend/manipulate to provide an assortment of features (without having to rely
on <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a> vendor-specific functionality).</p>
<div class="section" id="single-container-with-docker">
<span id="ssec-single-container"></span><h3>Single Container with Docker<a class="headerlink" href="#single-container-with-docker" title="Permalink to this headline">¶</a></h3>
<p>Launching a single container interactively is very straightforward. We just
need to make sure that Docker is installed <span id="id12">[<a class="reference internal" href="references.html#id14" title="Docker Inc. Install Docker Engine. \url https://docs.docker.com/engine/install/, accessed 2021-08-01.">11</a>]</span>. In my own case, on
an Ubuntu 20.04 installation, I simply needed to do the following:</p>
<ul class="simple">
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">docker</span></code>.</p></li>
<li><p>Add myself to the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">group</span></code> so I could execute Docker commands without
the use of the <code class="docutils literal notranslate"><span class="pre">sudo</span></code> command, i.e: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">usermod</span> <span class="pre">-a</span> <span class="pre">-G</span> <span class="pre">docker</span>
<span class="pre">$(whoami)</span></code>, and then log out of all running sessions (or rebooting the
machine might be easier).</p></li>
</ul>
<p>In any case, please refer to the official Docker documentation <span id="id13">[<a class="reference internal" href="references.html#id14" title="Docker Inc. Install Docker Engine. \url https://docs.docker.com/engine/install/, accessed 2021-08-01.">11</a>]</span>
for guidance on installing Docker (on Linux; as noted earlier, this material
focuses exclusively on Linux hosts). Now, let’s take the latest Ubuntu 20.04
“Focal” distro for a spin, by instantiating an interactive instance of it (for
more details on the command line arguments, please see <span id="id14">[<a class="reference internal" href="references.html#id15" title="Docker Inc. Use the Docker command line. \url https://docs.docker.com/engine/reference/commandline/cli/, accessed 2021-08-01.">12</a>]</span>).</p>
<div class="literal-block-wrapper docutils container" id="id58">
<div class="code-block-caption"><span class="caption-number">Listing 6 </span><span class="caption-text">Example of launching a container.</span><a class="headerlink" href="#id58" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Launch an interactive instance, and auto-cleanup when done.</span>
<span class="lineno"> 2 </span>$&gt; docker run -it --rm ubuntu:focal
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span>Unable to find image <span class="s1">&#39;ubuntu:focal&#39;</span> locally
<span class="lineno"> 5 </span>focal: Pulling from library/ubuntu
<span class="lineno"> 6 </span>16ec32c2132b: Already exists
<span class="lineno"> 7 </span>Digest:
<span class="lineno"> 8 </span>sha256:82becede498899ec668628e7cb0ad87b6e1c371cb8a1e597d83a47fac21d6af3
<span class="lineno"> 9 </span>Status: Downloaded newer image <span class="k">for</span> ubuntu:focal
<span class="lineno">10 </span>
<span class="lineno">11 </span><span class="c1"># Now we&#39;re in our container, in it&#39;s own dedicated virtual/throw-away</span>
<span class="lineno">12 </span><span class="c1"># file system. Let&#39;s look around.</span>
<span class="lineno">13 </span>root@016a95a884a3:/# ls -a
<span class="lineno">14 </span>.  ..  .dockerenv  bin  boot  dev  etc  home  lib  lib32  lib64  libx32
<span class="lineno">15 </span>media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
</pre></div>
</div>
</div>
<p>Keep in mind, when we’re using <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code> (or <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span></code>) to
instantiate and run a shell in the container, we’re operating within a
throwaway file system (i.e. when the container instance is terminated, that
file system and the files present in it, even those we manually create, are
gone). Let’s start to fine tune our arguments to Docker to get more use out of
it. Let’s assume I’m currently logged in to my host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> as user
<code class="docutils literal notranslate"><span class="pre">owner</span></code>, on a machine with host name <code class="docutils literal notranslate"><span class="pre">darkstar</span></code>, and my home directory is
<code class="docutils literal notranslate"><span class="pre">/home/owner</span></code>. Let’s create a “staging area” for our Docker-related
experiments in <code class="docutils literal notranslate"><span class="pre">/home/owner/work</span></code> (the following examples will use the <code class="docutils literal notranslate"><span class="pre">~</span></code>
literal and <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> variable to avoid references to <code class="docutils literal notranslate"><span class="pre">owner</span></code> and/or
<code class="docutils literal notranslate"><span class="pre">darkstar</span></code> being hard-coded into them).</p>
<div class="literal-block-wrapper docutils container" id="id59">
<div class="code-block-caption"><span class="caption-number">Listing 7 </span><span class="caption-text">Example of launching a container with a host volume mount.</span><a class="headerlink" href="#id59" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Create our staging path.</span>
<span class="lineno"> 2 </span>owner@darkstar$&gt; mkdir -p ~/work
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1"># Change directory. Manually make sure no files are present here via &quot;ls&quot;, so</span>
<span class="lineno"> 5 </span><span class="c1"># we&#39;re not destroying data in case, by coincidence, you already have a</span>
<span class="lineno"> 6 </span><span class="c1"># &quot;~/work&quot; directory on your host machine.</span>
<span class="lineno"> 7 </span>owner@darkstar$&gt; <span class="nb">cd</span> ~/work
<span class="lineno"> 8 </span>
<span class="lineno"> 9 </span><span class="c1"># Launch our Docker container, but mount the current directory so that it&#39;s</span>
<span class="lineno">10 </span><span class="c1"># accessible from within the container. We can also use the &quot;pwd&quot; command</span>
<span class="lineno">11 </span><span class="c1"># instead of &quot;readlink -f&quot;, but I prefer the latter for cases where</span>
<span class="lineno">12 </span><span class="c1"># additional mounts are needed, so a single command is used throughout the</span>
<span class="lineno">13 </span><span class="c1"># (lengthy) set of command-line arguments.</span>
<span class="lineno">14 </span>owner@darkstar$&gt; $&gt; docker run -it --rm <span class="se">\</span>
<span class="lineno">15 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work&quot;</span>
<span class="lineno">16 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span>
<span class="lineno">17 </span>    ubuntu:focal
<span class="lineno">18 </span>
<span class="lineno">19 </span>root@0c33ac445db4:/work# ls
<span class="lineno">20 </span>
<span class="lineno">21 </span>root@0c33ac445db4:/work# touch foo
<span class="lineno">22 </span>
<span class="lineno">23 </span>root@0c33ac445db4:/work# ls
<span class="lineno">24 </span>foo
<span class="lineno">25 </span>
<span class="lineno">26 </span>root@0c33ac445db4:/work# <span class="nb">exit</span>
<span class="lineno">27 </span>
<span class="lineno">28 </span>owner@darkstar$&gt; ls
<span class="lineno">29 </span>foo
</pre></div>
</div>
</div>
<p>How exciting: the file we created via the <code class="docutils literal notranslate"><span class="pre">touch</span></code> command within our
container survived the termination of the container, and is accessible to the
current user session on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>. Let’s take another step forward:
let’s actually build something within the container. We’ll create the following
two files within the current directory (i.e. <a class="reference internal" href="glossary.html#term-CWD"><span class="xref std std-term">CWD</span></a> or <a class="reference internal" href="glossary.html#term-PWD"><span class="xref std std-term">PWD</span></a>):
<code class="docutils literal notranslate"><span class="pre">Makefile</span></code> and <code class="docutils literal notranslate"><span class="pre">helloworld.c</span></code> (the programming language doesn’t really
matter, and the example we’re demonstrating is just a C-specific minimal “hello
world” example, so there’s no need to be versed in the C programming language
to proceed).</p>
<div class="literal-block-wrapper docutils container" id="id60">
<div class="code-block-caption"><span class="caption-number">Listing 8 </span><span class="caption-text">Makefile for building a simple ANSI-C “hello world” example.</span><a class="headerlink" href="#id60" title="Permalink to this code">¶</a></div>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="nf">.DEFAULT_GOAL</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno">2 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno">3 </span><span class="nf">all</span><span class="o">:</span>
<span class="lineno">4 </span>        gcc helloworld.c -o helloworld_app
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id61">
<div class="code-block-caption"><span class="caption-number">Listing 9 </span><span class="caption-text">C code for building a simple ANSI-C “hello world” example.</span><a class="headerlink" href="#id61" title="Permalink to this code">¶</a></div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="lineno">2 </span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">3 </span>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello world!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="lineno">4 </span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">5 </span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now, let’s attempt to manually compile our source file via GNU <code class="docutils literal notranslate"><span class="pre">make</span></code> within
our container.</p>
<div class="literal-block-wrapper docutils container" id="id62">
<div class="code-block-caption"><span class="caption-number">Listing 10 </span><span class="caption-text">Example of launching a container with a host volume mount.</span><a class="headerlink" href="#id62" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Launch our Docker container, but mount the current directory so that it&#39;s</span>
<span class="lineno"> 2 </span><span class="c1"># accessible from within the container. We can also use the &quot;pwd&quot; command</span>
<span class="lineno"> 3 </span><span class="c1"># instead of &quot;readlink -f&quot;, but I prefer the latter for cases where</span>
<span class="lineno"> 4 </span><span class="c1"># additional mounts are needed, so a single command is used throughout the</span>
<span class="lineno"> 5 </span><span class="c1"># (lengthy) set of command-line arguments.</span>
<span class="lineno"> 6 </span>owner@darkstar$&gt; $&gt; docker run -it --rm <span class="se">\</span>
<span class="lineno"> 7 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work&quot;</span>
<span class="lineno"> 8 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span>
<span class="lineno"> 9 </span>    ubuntu:focal
<span class="lineno">10 </span>
<span class="lineno">11 </span><span class="c1"># Confirm our files are present (after creating them on the host OS in</span>
<span class="lineno">12 </span><span class="c1"># &quot;~/work&quot;): looks good.</span>
<span class="lineno">13 </span>root@f2fb4aeecfbc:/work# ls
<span class="lineno">14 </span>Makefile  foo  helloworld.c
<span class="lineno">15 </span>
<span class="lineno">16 </span><span class="c1"># Build our app.</span>
<span class="lineno">17 </span>root@f2fb4aeecfbc:/work# make
<span class="lineno">18 </span>bash: make: <span class="nb">command</span> not found
<span class="lineno">19 </span>
<span class="lineno">20 </span><span class="c1"># That&#39;s not good: let&#39;s try building directly via &quot;gcc&quot;:</span>
<span class="lineno">21 </span>root@f2fb4aeecfbc:/work# gcc helloworld.c -o helloworld_app
<span class="lineno">22 </span>bash: gcc: <span class="nb">command</span> not found
<span class="lineno">23 </span>
<span class="lineno">24 </span><span class="c1"># Still no good. Well, let&#39;s try installing these apps.</span>
<span class="lineno">25 </span>root@f2fb4aeecfbc:/work# apt install make gcc
<span class="lineno">26 </span>Reading package lists... Done
<span class="lineno">27 </span>Building dependency tree
<span class="lineno">28 </span>Reading state information... Done
<span class="lineno">29 </span>E: Unable to locate package make
<span class="lineno">30 </span>E: Unable to locate package gcc
<span class="lineno">31 </span>
<span class="lineno">32 </span><span class="c1"># Oh yeah: need to update our apt cache, as it will be empty by default in a</span>
<span class="lineno">33 </span><span class="c1"># &quot;fresh&quot; container.</span>
<span class="lineno">34 </span>
<span class="lineno">35 </span>root@f2fb4aeecfbc:/work# apt update -q <span class="o">&amp;&amp;</span> apt install make gcc
<span class="lineno">36 </span>Hit:1 http://security.ubuntu.com/ubuntu focal-security InRelease
<span class="lineno">37 </span>Hit:2 http://archive.ubuntu.com/ubuntu focal InRelease
<span class="lineno">38 </span>Hit:3 http://archive.ubuntu.com/ubuntu focal-updates InRelease
<span class="lineno">39 </span>Hit:4 http://archive.ubuntu.com/ubuntu focal-backports InRelease
<span class="lineno">40 </span>...
<span class="lineno">41 </span>...
<span class="lineno">42 </span>...
<span class="lineno">43 </span>Need to get <span class="m">33</span>.3 MB of archives.
<span class="lineno">44 </span>After this operation, <span class="m">139</span> MB of additional disk space will be used.
<span class="lineno">45 </span>Do you want to <span class="k">continue</span>? <span class="o">[</span>Y/n<span class="o">]</span>
<span class="lineno">46 </span>
<span class="lineno">47 </span><span class="c1"># Why not: let&#39;s install the packages (Y).</span>
<span class="lineno">48 </span>
<span class="lineno">49 </span><span class="c1"># Now, we should be able to build and run our app in this container.</span>
<span class="lineno">50 </span>root@f2fb4aeecfbc:/work# make
<span class="lineno">51 </span>gcc helloworld.c -o helloworld_app
<span class="lineno">52 </span>
<span class="lineno">53 </span>root@f2fb4aeecfbc:/work# ls -la
<span class="lineno">54 </span>total <span class="m">36</span>
<span class="lineno">55 </span>drwxrwxr-x <span class="m">2</span> <span class="m">1000</span> <span class="m">1000</span>  <span class="m">4096</span> Aug  <span class="m">1</span> <span class="m">17</span>:43 .
<span class="lineno">56 </span>drwxr-xr-x <span class="m">1</span> root root  <span class="m">4096</span> Aug  <span class="m">1</span> <span class="m">17</span>:37 ..
<span class="lineno">57 </span>-rw-rw-r-- <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>    <span class="m">72</span> Aug  <span class="m">1</span> <span class="m">17</span>:37 Makefile
<span class="lineno">58 </span>-rw-r--r-- <span class="m">1</span> root root     <span class="m">0</span> Aug  <span class="m">1</span> <span class="m">17</span>:23 foo
<span class="lineno">59 </span>-rw-rw-r-- <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>    <span class="m">77</span> Aug  <span class="m">1</span> <span class="m">17</span>:37 helloworld.c
<span class="lineno">60 </span>-rwxr-xr-x <span class="m">1</span> root root <span class="m">16704</span> Aug  <span class="m">1</span> <span class="m">17</span>:43 helloworld_app
<span class="lineno">61 </span>
<span class="lineno">62 </span>root@f2fb4aeecfbc:/work# ./helloworld_app
<span class="lineno">63 </span>Hello world!
<span class="lineno">64 </span>
<span class="lineno">65 </span>
<span class="lineno">66 </span>root@f2fb4aeecfbc:/work# <span class="nb">exit</span>
</pre></div>
</div>
</div>
<p>Well, that was interesting: it turns out that these “baseline” Docker images
for various Linux distributions (also referred to as “distros”) are quite
minimal in terms of packages present. We were able to manually install the
needed packages however, and eventually build and run our example. Now, go
ahead and re-run the example we just finished: notice anything odd/unexpected?</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please go ahead and re-run the example. What is amiss?</p>
</div>
<p>As you’ve likely noticed, you need to re-install <code class="docutils literal notranslate"><span class="pre">make</span></code> and <code class="docutils literal notranslate"><span class="pre">gcc</span></code> again.
While the files in <code class="docutils literal notranslate"><span class="pre">/work</span></code> within the container survive container termination
(due to the volume mount we have in place), the rest of the container
(including packages we’ve installed to places like <code class="docutils literal notranslate"><span class="pre">/usr</span></code> within the
container) do not (this is by design, as containers are intended to generally
be throwaway/ephemeral; anything intended for long-term storage needs to be
backed up or otherwise exported via mounts or some other means of exporting the
data from the running container). Well, this is going to consume a large amount
of bandwidth and slow down our build process if we want to repeatedly re-build
our example (and not keep the same container instance “live” indefinitely).
Fortunately, we can easily extend our baseline Ubuntu container to have some
modifications that will be helpful to us. Let’s create a new file named
<code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> in the <a class="reference internal" href="glossary.html#term-PWD"><span class="xref std std-term">PWD</span></a>, and populate it like so:</p>
<div class="literal-block-wrapper docutils container" id="id63">
<div class="code-block-caption"><span class="caption-number">Listing 11 </span><span class="caption-text">Dockerfile that extends Ubuntu.</span><a class="headerlink" href="#id63" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno">2 </span>
<span class="lineno">3 </span><span class="c"># System packages.</span>
<span class="lineno">4 </span><span class="k">RUN</span> apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">5 </span>    apt install -y <span class="se">\</span>
<span class="lineno">6 </span>        make <span class="se">\</span>
<span class="lineno">7 </span>        gcc <span class="se">\</span>
<span class="lineno">8 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">9 </span>    apt clean -y
</pre></div>
</div>
</div>
<p>The key things to keep in mind are that we’re using “ubuntu:focal” as our
baseline image (“baseline” is just an arbitrary name I chose, it’s not a
Dockerfile primitive/keyword), and we’re using <code class="docutils literal notranslate"><span class="pre">apt</span></code> to install the extra
packages we need. The remaining code (i.e. multi-line <code class="docutils literal notranslate"><span class="pre">apt</span></code> usage, <code class="docutils literal notranslate"><span class="pre">apt</span>
<span class="pre">clean</span></code>, etc.) are just “common/best practises” to reduce the size of the
overall image (i.e. optimizations), and are covered in a later section. It’s
also worth noting that I will typically refer to “Docker containers” as
live/running instances of “Docker images”, while “Docker images” are the static
build artifacts produced by <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code> operations (i.e. “Docker
containers are live instantiations of Docker images”), to avoid ambiguity.</p>
<p>Now, let’s build the Dockerfile to produce an image we can use (pay attention
to the period <code class="docutils literal notranslate"><span class="pre">.</span></code> literal on the final line: it’s not a typo; you can also
replace it with <code class="docutils literal notranslate"><span class="pre">./</span></code> if desired for better readability):</p>
<div class="literal-block-wrapper docutils container" id="id64">
<div class="code-block-caption"><span class="caption-number">Listing 12 </span><span class="caption-text">Example build command to create a Docker image from a Dockerfile.</span><a class="headerlink" href="#id64" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Build our image.</span>
<span class="lineno"> 2 </span><span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno"> 3 </span>  -t <span class="s2">&quot;my_docker_builder:local&quot;</span> <span class="se">\</span>
<span class="lineno"> 4 </span>  --target baseline <span class="se">\</span>
<span class="lineno"> 5 </span>  -f Dockerfile <span class="se">\</span>
<span class="lineno"> 6 </span>  .
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="c1"># Confirm it exists.</span>
<span class="lineno"> 9 </span>owner@darkstar$&gt; docker image ls
<span class="lineno">10 </span>REPOSITORY                        TAG       IMAGE ID       CREATED
<span class="lineno">11 </span>SIZE
<span class="lineno">12 </span>my_docker_builder                 latest    5dd3b898dfc1   <span class="m">31</span> seconds ago
<span class="lineno">13 </span>233MB
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The reader may notice the use of the <code class="docutils literal notranslate"><span class="pre">DOCKER_BUILDKIT</span></code> environment
variable <span id="id15">[<a class="reference internal" href="references.html#id33" title="Docker Inc. Build images with BuildKit. \url https://docs.docker.com/develop/develop-images/build_enhancements/, accessed 2021-08-03.">13</a>]</span>, along with manually specifying the path
to the Dockerfile via the <code class="docutils literal notranslate"><span class="pre">-f</span></code> command-line argument. This is to allow for
custom <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> and <code class="docutils literal notranslate"><span class="pre">.dockerignore</span></code> <span id="id16">[<a class="reference internal" href="references.html#id34" title="Docker Inc. Dockerfile Reference. \url https://docs.docker.com/engine/reference/builder/, accessed 2021-08-03.">14</a>]</span>, file
names
<span id="id17">[<a class="reference internal" href="references.html#id35" title="Tristan Zajonc, The Docker Maintainers. Add support for specifying .dockerignore file with -i/–ignore #12886. \url https://github.com/moby/moby/issues/12886#issuecomment-480575928, accessed 2021-08-03.">15</a>]</span>, greatly increasing build speeds (i.e. reducing
build times/duration), providing increased security against accidentally
bundling files unintentionally, <span id="id18">[<a class="reference internal" href="references.html#id36" title="Alexei Ledenev. Do not ignore .dockerignore (it’s expensive and potentially dangerous). \url https://codefresh.io/docker-tutorial/not-ignore-dockerignore-2/, accessed 2021-08-03.">16</a>]</span>, etc. The reader is
encouraged to futher investigate these techniques if not already familiar
with them, as a minor change to project structure can greatly improve the
security and velocity of builds.</p>
</div>
<p>Now, let’s repeat the earlier <code class="docutils literal notranslate"><span class="pre">make</span></code> example, but use our newly-minted
container rather than the “vanilla” (i.e. un-modified) <code class="docutils literal notranslate"><span class="pre">ubuntu:focal</span></code> image.</p>
<div class="literal-block-wrapper docutils container" id="id65">
<div class="code-block-caption"><span class="caption-number">Listing 13 </span><span class="caption-text">Example of launching a container with a host volume mount via a custom Docker image.</span><a class="headerlink" href="#id65" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Launch our Docker container, but mount the current directory so that it&#39;s</span>
<span class="lineno"> 2 </span><span class="c1"># accessible from within the container. We can also use the &quot;pwd&quot; command</span>
<span class="lineno"> 3 </span><span class="c1"># instead of &quot;readlink -f&quot;, but I prefer the latter for cases where</span>
<span class="lineno"> 4 </span><span class="c1"># additional mounts are needed, so a single command is used throughout the</span>
<span class="lineno"> 5 </span><span class="c1"># (lengthy) set of command-line arguments.</span>
<span class="lineno"> 6 </span>owner@darkstar$&gt; $&gt; docker run -it --rm <span class="se">\</span>
<span class="lineno"> 7 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work&quot;</span>
<span class="lineno"> 8 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span>
<span class="lineno"> 9 </span>    my_docker_builder:local
<span class="lineno">10 </span>
<span class="lineno">11 </span><span class="c1"># Confirm our files are present (after creating them on the host OS in</span>
<span class="lineno">12 </span><span class="c1"># &quot;~/work&quot;): looks good. Let&#39;s remove the binary we compiled in our previous</span>
<span class="lineno">13 </span><span class="c1"># run to make sure we&#39;re really building it from source correctly.</span>
<span class="lineno">14 </span>root@6b60e799f6dc:/work# ls
<span class="lineno">15 </span>Dockerfile  Makefile  foo  helloworld.c  helloworld_app
<span class="lineno">16 </span>
<span class="lineno">17 </span>root@6b60e799f6dc:/work# rm helloworld_app
<span class="lineno">18 </span>
<span class="lineno">19 </span>root@6b60e799f6dc:/work# make
<span class="lineno">20 </span>gcc helloworld.c -o helloworld_app
<span class="lineno">21 </span>
<span class="lineno">22 </span>root@6b60e799f6dc:/work# ./helloworld_app
<span class="lineno">23 </span>Hello world!
<span class="lineno">24 </span>
<span class="lineno">25 </span>root@6b60e799f6dc:/work# <span class="nb">exit</span>
</pre></div>
</div>
</div>
<p>Hurrah! We now have a Docker image with the necessary tools present to build
our application, without having to re-download them every time (saving
bandwidth, decreasing the amount of time our build takes, and allowing this
build process to work in environments without internet access, which would be
necessary for downloading packages via <code class="docutils literal notranslate"><span class="pre">apt</span></code>). This Docker image can be used
for local builds, as well as builds via <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> pipelines with tools like
GitHub, Jenkins, GitLab, etc. At this point, the reader is strongly encouraged
to review the use of <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">push</span></code> (<span id="id19">[<a class="reference internal" href="references.html#id22" title="Docker Inc. docker push. \url https://docs.docker.com/engine/reference/commandline/push/, accessed 2021-08-01.">17</a>]</span>,
<span id="id20">[<a class="reference internal" href="references.html#id23" title="Docker Inc. Repositories. \url https://docs.docker.com/docker-hub/repos/, accessed 2021-08-01.">18</a>]</span>) to learn how to back up your Docker images for long-term
re-use (and for sharing them with colleagues and team members).</p>
<p>As a final example for this section, we leave the reader with a sample script
they are encouraged to use with the source listings we’ve used, as a matter of
convenience, e.g. <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code> (the file name is arbitrary; please pick an
alternative at your own discretion; also be sure to make it executable via
<code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">+x</span> <span class="pre">iax.sh</span></code>).</p>
<div class="literal-block-wrapper docutils container" id="id66">
<div class="code-block-caption"><span class="caption-number">Listing 14 </span><span class="caption-text">Docker launcher script.</span><a class="headerlink" href="#id66" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/bin/bash</span>
<span class="lineno"> 2 </span><span class="c1">################################################################################</span>
<span class="lineno"> 3 </span><span class="c1"># @brief:       Docker-bootstrap script for building projects via a Docker</span>
<span class="lineno"> 4 </span><span class="c1">#               image.</span>
<span class="lineno"> 5 </span><span class="c1">################################################################################</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="c1"># Docker runtime image to use for building artifacts.</span>
<span class="lineno"> 8 </span><span class="nv">DOCKER_IMG</span><span class="o">=</span><span class="s2">&quot;my_docker_builder:local&quot;</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1"># Launch docker container. Setup PWD on host to mount to &quot;/work&quot; in the</span>
<span class="lineno">11 </span><span class="c1"># guest/container.</span>
<span class="lineno">12 </span>docker run <span class="se">\</span>
<span class="lineno">13 </span>  --rm -it <span class="se">\</span>
<span class="lineno">14 </span>  --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">15 </span>  --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">16 </span>  <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">17 </span>  <span class="si">${</span><span class="p">@</span><span class="si">}</span>
</pre></div>
</div>
</div>
<p>What use is this compared to the commands we’ve already been using so far?
Well, there are four important consequences of using a launcher script like
this:</p>
<ul class="simple">
<li><p>Without any arguments, it just launches an interactive instance of your
container, like how we’ve been doing throughout this section (i.e. less
typing).</p></li>
<li><p>If arguments are passed to the container, it will run them as a
non-interactive job, and terminate the container instance when done. For
example, try executing something like <code class="docutils literal notranslate"><span class="pre">./iax.sh</span> <span class="pre">make</span></code>, and the script will
launch the <code class="docutils literal notranslate"><span class="pre">make</span></code> command within the container, and then terminate the
container, while leaving the build artifacts behind on your host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>
(very handy if you want to script/batch builds and other operations in an
automated, non-interactive manner using your builder containers).</p></li>
<li><p>You can add a lot of other complex options (some of which will be covered in
later sections) to get more functionality out of the script, without
requiring users of the script (i.e. other team members) to have to memorize
a copious amount of Docker command-line arguments.</p></li>
<li><p>The script can be modified to reflect the behavior of your <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a>
build system, to minimize differences between local/developer builds of a
project, and builds launched on dedicated infrastructure as part of your
<a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> pipeline (i.e. no more cases of build-related bugs occurring
and the response being “but it worked on my machine!”). Less headaches for
developers thanks to pro-active, user-friendly infrastructure design by
DevOps.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Build pattern viability metrics.</p>
<p>Repeatable: very repeatable.</p>
<p>Reliable: very reliable, provided the host OS itself is stable.</p>
<p>Maintainable: yes, especially when most uses of containers are
throwaway/ephemeral, as we just create new instances when needed, rather
than maintaining old instances long-term.</p>
<p>Scalable: extremely scalable, especially when tools like K8S are added to
the mix. More on such topics in later sections.</p>
</div>
</div>
<div class="section" id="multiple-containers-with-docker">
<h3>Multiple Containers with Docker<a class="headerlink" href="#multiple-containers-with-docker" title="Permalink to this headline">¶</a></h3>
<p>This use case is nearly identical to the single container user case (i.e.
<a class="reference internal" href="#ssec-single-container"><span class="std std-ref">Single Container with Docker</span></a>). <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> frameworks like GitHub, GitLab,
etc.; support building applications in containers, and also support building
different portions of a project/pipeline in different containers (e.g. consider
a project with a C and a Go/Golang sub-project in it, and for the sake of
convenience, the two sub-projects are built with different dedicated Docker
images).</p>
<p>The one place where this can become a bit tedious is when handling the case of
local developer builds. Using a launcher script like the <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code> script is
great if everything needs to be built under the same container (e.g. one can
just execute <code class="docutils literal notranslate"><span class="pre">./iax.sh</span> <span class="pre">make</span></code> and have an entire project build end-to-end
without any further user interaction). However, this pattern no longer works if
different images need to be used throughout the build pipeline, as we’d need to
execute different stages of the build with different launcher scripts (i.e.
boilerplate copies of <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code>: one per builder image needed).</p>
<p>One off-the-cuff solution to this would be to have a top-level shell script
that launches (in the case of local/developer builds) various stages of the
pipeline in different containers (example shown below).</p>
<div class="literal-block-wrapper docutils container" id="id67">
<div class="code-block-caption"><span class="caption-number">Listing 15 </span><span class="caption-text">Example of a multi-container build script.</span><a class="headerlink" href="#id67" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="c1"># Launch our &quot;C builder&quot; to build a sub-directory in the PWD.</span>
<span class="lineno">2 </span>./iax_c.sh <span class="nb">cd</span> c_sub_project <span class="o">&amp;&amp;</span> make
<span class="lineno">3 </span>
<span class="lineno">4 </span><span class="c1"># Do the same, for a Go sub-project with our &quot;Go builder&quot;.</span>
<span class="lineno">5 </span>./iax_golang.sh <span class="nb">cd</span> go_sub_project <span class="o">&amp;&amp;</span> make
</pre></div>
</div>
</div>
<p>While this works, it has several issues with respect to maintainability (even
if it seems fine according to our build pattern viability metrics). Namely:</p>
<ul class="simple">
<li><p>The top-level build script isn’t launching within a container, so it
immediately becomes less portable due to certain requirements (besides the
existence of Docker) being present on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>. This may
seem trivial, but can be very frustrating if suddenly the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>
requires a specific version of a specific tool like <code class="docutils literal notranslate"><span class="pre">cmake</span></code>, <code class="docutils literal notranslate"><span class="pre">scons</span></code>,
etc.; present, and is further compounded if developers are using different
distros/versions and these tools aren’t available for the required
combination of distro, tool version, etc. In short, we can avoid a lot of
headache and frustration by ensuring the entirety of the build process is
somehow “wrapped” via containers or some other virtualization technology.</p></li>
<li><p>We need to have near-duplicate copies of the launcher script for each build
image we support. They can easily drift (i.e. they become dissimilar from
each other) over time, or as boilerplate copies are duplicated into other
projects.</p></li>
<li><p>The top-level build tool (generally, in the case of local/developer builds)
has to be a specific tool (i.e. <code class="docutils literal notranslate"><span class="pre">bash</span></code> or some other interpreter). It
prevents the (trivial) use of tools like <code class="docutils literal notranslate"><span class="pre">make</span></code> as the top-level build
tool, which can prevent better (more optimal) means of building software.</p></li>
<li><p>Executing incremental builds puts additional cognitive load on
developers/engineers as they conduct their day-to-day tasks (i.e. “one more
corner-case to remember”), as they have to possess a more intricate knowledge
of the build chain for local/developer builds (i.e. “a shell script launches
some more shell scripts that launch Makefiles in different containers for
different sub-projects in the top-level project…”). Simplicity and
ease-of-use are paramount for adoption.</p></li>
</ul>
<p>With all this said, multiple container (i.e. serialized) builds are a perfectly
viable pattern, but some serious thought needs to be put into how it will be
presented to the consumer of these systems and scripts (i.e. development teams)
so that it is helpful rather than a hindrance to day-to-day development tasks.
Since the top-level build script is not containerized, it should ideally be
something portable that works across multiple Linux distros and versions (e.g.
<code class="docutils literal notranslate"><span class="pre">bash</span></code> or a specific version of <code class="docutils literal notranslate"><span class="pre">python3</span></code>, for example).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Build pattern viability metrics.</p>
<p>Repeatable: very repeatable, but the difference between local/developer
builds and CI/CD pipeline builds may result in additional work/load for
individual contributors.</p>
<p>Reliable: very reliable, provided the host OS itself is stable.</p>
<p>Maintainable: yes, similar to single container use case.</p>
<p>Scalable: extremely scalable, especially when tools like K8S and
docker-compose are added to the mix. More on these in later sections.</p>
</div>
</div>
<div class="section" id="nested-containers-with-docker-in-docker">
<h3>Nested Containers with Docker-in-Docker<a class="headerlink" href="#nested-containers-with-docker-in-docker" title="Permalink to this headline">¶</a></h3>
<p>While more complex in nature (not by too much, I promise), a nested Docker or
“Docker-in-Docker” (<a class="reference internal" href="glossary.html#term-DIND"><span class="xref std std-term">DIND</span></a>) provides the best of both the single
container and multiple container uses cases for a build pattern, with a modest
increase in complexity, <strong>and</strong>, very specific security requirements, as we’ll
be exposing the Docker socket (a <a class="reference internal" href="glossary.html#term-UDS"><span class="xref std std-term">UDS</span></a> type of socket) to the top-level
container. In such cases, the top-level container should be invoked from a
trusted, verified, (and usually built in-house) Docker image.</p>
<p>Additionally, to clear up some terminology, there are at least two ways (at
this time, excluding solutions that encapsulate containers in <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VMs</span></a>)
to run nested containers or “Docker-in-Docker”:</p>
<ul class="simple">
<li><p>“Docker-in-Docker via <code class="docutils literal notranslate"><span class="pre">dind</span></code> <span id="id21">[<a class="reference internal" href="references.html#id16" title="Docker Inc. Docker in Docker! \url https://hub.docker.com/_/docker, accessed 2021-08-03.">19</a>]</span>: a dedicated Docker image
designed to allow for nested Docker deployments. Targeted primarily at use
cases involving the development and testing of Docker itself.</p></li>
<li><p>“Sharing the Docker socket” via mounting <code class="docutils literal notranslate"><span class="pre">/var/run/docker.sock</span></code> in “child”
containers.</p></li>
</ul>
<p>For the sake of our analysis of build patterns, we’ll focus on the latter of
the two approaches noted above. Also, to avoid ambiguity, I will use
<a class="reference internal" href="glossary.html#term-DIND"><span class="xref std std-term">DIND</span></a> to refer to the general approach of nested containers or
“Docker-in-Docker”, while the term (in monospaced font) of <code class="docutils literal notranslate"><span class="pre">dind</span></code> refers to
the specific “Docker-in-Docker” implementation covered in <span id="id22">[<a class="reference internal" href="references.html#id16" title="Docker Inc. Docker in Docker! \url https://hub.docker.com/_/docker, accessed 2021-08-03.">19</a>]</span>
(which likely won’t be mentioned much more, if at all, in the rest of this
book). The use of this approach (i..e “sharing the Docker socket”) is quite
straightforward: we just launch a Docker container while mounting the Docker
<a class="reference internal" href="glossary.html#term-UDS"><span class="xref std std-term">UDS</span></a> (i.e. <a class="reference internal" href="glossary.html#term-API"><span class="xref std std-term">API</span></a> entry point for communicating with Docker) in the
top-level container we launch. This allows the top-level container to launch
additional “child” containers (well, “sibling” containers actually; more on
that later), which it could not accomplish without the use of this command-line
argument. To use this feature, we just add the following to our <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>
invocation, and we’re all set:
<code class="docutils literal notranslate"><span class="pre">--volume=&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span></code></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This option (i.e. mounting <code class="docutils literal notranslate"><span class="pre">/var/run/docker.sock</span></code> within a container)
should <strong>only</strong> be used in specific circumstances where its use is needed
and justified (i.e. build infrastructure that’s only executing safe/trusted
code and containers, local development use with safe/trusted environments,
the DevOps engineers maintaining the system are aware that containers
running with this capability effectively have root control over the host
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> and all the security implications that go along with it, etc.).</p>
<p>This functionality should not be enabled in a non-hardened/isolated
environment, as it is easily exploited to allow for priviledge esclatation
and eventual compromise of the machine (and even encompassing
infrastructure) <span id="id23">[<a class="reference internal" href="references.html#id25" title="Matthew Close. Tutorial- Understanding the Security Risks of Running Docker Containers: Don't Lose Your Sock(et)s. \url https://www.ctl.io/developers/blog/post/tutorial-understanding-the-security-risks-of-running-docker-containers, accessed 2021-08-02.">20</a>]</span> <span id="id24">[<a class="reference internal" href="references.html#id26" title="Peter Benjamin. Docker Security Best-Practises. \url https://dev.to/pbnj/docker-security-best-practices-45ih, accessed 2021-08-03.">21</a>]</span>
<span id="id25">[<a class="reference internal" href="references.html#id27" title="Srdjan Grubor. Top 3 Things to Avoid When Using Containers. \url https://www.conjur.org/blog/top-3-things-to-avoid-when-using-containers/, accessed 2021-08-03.">22</a>]</span> <span id="id26">[<a class="reference internal" href="references.html#id28" title="OWASP Cheat Sheet Series Team. Docker Security Cheat Sheet. \url https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html, accessed 2021-08-03.">23</a>]</span>. This being said, many common,
modern <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> systems <span id="id27">[<a class="reference internal" href="references.html#id31" title="GitLab Inc. Run GitLab Runner in a container. \url https://docs.gitlab.com/runner/install/docker.html, accessed 2021-08-03.">24</a>]</span> <span id="id28">[<a class="reference internal" href="references.html#id32" title="The Jenkins Project. Docker plugin for Jenkins. \url https://plugins.jenkins.io/docker-plugin/, accessed 2021-08-03.">25</a>]</span>: either
support or even advise (under specific circumstances) the use of such an
approach. While acknowledging the usefulness of this approach and its
security implications, I’ve elected to not qualify the approach overall, and
will instead focus on how it is used as a build pattern. The reader is free
to draw their own conclusion with respect to whether or not the utility
provided by such a method warrants the extra security
policies/implementations required to lock it down.</p>
<p>Also, the version of Docker installed within the container itself must be
<a class="reference internal" href="glossary.html#term-API"><span class="xref std std-term">API</span></a>-compatible with that running on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>, so there is
at least that requirement on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> in terms of software
loadout.</p>
<p><strong>With all this being said,</strong> all of the examples in this chapter make use
of “rootless Docker” at every step along the way, even when using
“Docker-in-Docker”, “Kubernetes-in-Docker”, etc. This greatly mitigates the
aforementioned concerns.</p>
</div>
<p>Now, for actually using this approach to execute a build operation.</p>
<div class="literal-block-wrapper docutils container" id="id68">
<div class="code-block-caption"><span class="caption-number">Listing 16 </span><span class="caption-text">Docker-in-Docker launcher: parent container.</span><a class="headerlink" href="#id68" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Docker runtime image to use for building artifacts.</span>
<span class="lineno"> 2 </span><span class="nv">DOCKER_IMG</span><span class="o">=</span><span class="s2">&quot;ubuntu:focal&quot;</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1"># Launch docker container with DIND capabilities.</span>
<span class="lineno"> 5 </span>docker run <span class="se">\</span>
<span class="lineno"> 6 </span>    --rm -it <span class="se">\</span>
<span class="lineno"> 7 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno"> 8 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno"> 9 </span>    --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">10 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">11 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="c1"># Confirm we can see some files from the host OS.</span>
<span class="lineno">14 </span>root@9ad1796a0ef5:/work# ls -la
<span class="lineno">15 </span>total <span class="m">24</span>
<span class="lineno">16 </span>drwxrwxr-x <span class="m">2</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Aug  <span class="m">3</span> <span class="m">21</span>:28 .
<span class="lineno">17 </span>drwxr-xr-x <span class="m">1</span> root root <span class="m">4096</span> Aug  <span class="m">3</span> <span class="m">21</span>:28 ..
<span class="lineno">18 </span>-rw-rw-r-- <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>  <span class="m">150</span> Aug  <span class="m">1</span> <span class="m">17</span>:57 Dockerfile
<span class="lineno">19 </span>-rw-rw-r-- <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>   <span class="m">72</span> Aug  <span class="m">1</span> <span class="m">17</span>:37 Makefile
<span class="lineno">20 </span>-rw-rw-r-- <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>   <span class="m">77</span> Aug  <span class="m">1</span> <span class="m">17</span>:37 helloworld.c
<span class="lineno">21 </span>-rwxrwxr-x <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>  <span class="m">571</span> Aug  <span class="m">1</span> <span class="m">18</span>:25 iax.sh
<span class="lineno">22 </span>
<span class="lineno">23 </span><span class="c1"># Done.</span>
<span class="lineno">24 </span>root@9ad1796a0ef5:/work# <span class="nb">exit</span>
<span class="lineno">25 </span><span class="nb">exit</span>
</pre></div>
</div>
</div>
<p>Great: we’ve re-enacted our single container use case. Now, let’s attempt to
launch another container, the “child” container (depth is 1, as this is a
single level of nesting), from within the “parent” container (depth is 0, as it
was invoked directly from the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> via <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>).</p>
<div class="literal-block-wrapper docutils container" id="id69">
<div class="code-block-caption"><span class="caption-number">Listing 17 </span><span class="caption-text">Docker-in-Docker launcher: parent container.</span><a class="headerlink" href="#id69" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Docker runtime image to use for building artifacts (parent image).</span>
<span class="lineno"> 2 </span><span class="nv">DOCKER_IMG</span><span class="o">=</span><span class="s2">&quot;ubuntu:focal&quot;</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1"># Launch parent docker container with DIND capabilities.</span>
<span class="lineno"> 5 </span>docker run <span class="se">\</span>
<span class="lineno"> 6 </span>    --rm -it <span class="se">\</span>
<span class="lineno"> 7 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno"> 8 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno"> 9 </span>    --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">10 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">11 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="c1"># Confirm we can see some files from the host OS.</span>
<span class="lineno">14 </span>root@b9b5d9166edf:/work# ls -la
<span class="lineno">15 </span>total <span class="m">24</span>
<span class="lineno">16 </span>drwxrwxr-x <span class="m">2</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Aug  <span class="m">3</span> <span class="m">21</span>:28 .
<span class="lineno">17 </span>drwxr-xr-x <span class="m">1</span> root root <span class="m">4096</span> Aug  <span class="m">3</span> <span class="m">21</span>:28 ..
<span class="lineno">18 </span>-rw-rw-r-- <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>  <span class="m">150</span> Aug  <span class="m">1</span> <span class="m">17</span>:57 Dockerfile
<span class="lineno">19 </span>-rw-rw-r-- <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>   <span class="m">72</span> Aug  <span class="m">1</span> <span class="m">17</span>:37 Makefile
<span class="lineno">20 </span>-rw-rw-r-- <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>   <span class="m">77</span> Aug  <span class="m">1</span> <span class="m">17</span>:37 helloworld.c
<span class="lineno">21 </span>-rwxrwxr-x <span class="m">1</span> <span class="m">1000</span> <span class="m">1000</span>  <span class="m">571</span> Aug  <span class="m">1</span> <span class="m">18</span>:25 iax.sh
<span class="lineno">22 </span>
<span class="lineno">23 </span><span class="c1"># Confirm this is Ubuntu &quot;Focal&quot; (i.e. 20.04 LTS).</span>
<span class="lineno">24 </span>root@b9b5d9166edf:/work# cat /etc/lsb-release
<span class="lineno">25 </span><span class="nv">DISTRIB_ID</span><span class="o">=</span>Ubuntu
<span class="lineno">26 </span><span class="nv">DISTRIB_RELEASE</span><span class="o">=</span><span class="m">20</span>.04
<span class="lineno">27 </span><span class="nv">DISTRIB_CODENAME</span><span class="o">=</span>focal
<span class="lineno">28 </span><span class="nv">DISTRIB_DESCRIPTION</span><span class="o">=</span><span class="s2">&quot;Ubuntu 20.04.2 LTS&quot;</span>
<span class="lineno">29 </span>
<span class="lineno">30 </span><span class="c1"># Make sure our host OS files are visible: check.</span>
<span class="lineno">31 </span>root@b9b5d9166edf:/work# ls
<span class="lineno">32 </span>Makefile  README.md  diagrams.drawio  doc  google2b0f328e0f93c24f.html
<span class="lineno">33 </span>iax.sh
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="c1"># Launch child container (no need to also give it DIND capabilities, in this</span>
<span class="lineno">36 </span><span class="c1"># case).</span>
<span class="lineno">37 </span><span class="c1"># Docker runtime image to use for building artifacts (child image).</span>
<span class="lineno">38 </span><span class="nv">DOCKER_IMG_CHILD</span><span class="o">=</span><span class="s2">&quot;debian:buster&quot;</span>
<span class="lineno">39 </span>docker run <span class="se">\</span>
<span class="lineno">40 </span>    --rm -it <span class="se">\</span>
<span class="lineno">41 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">42 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">43 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG_CHILD</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">44 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
<span class="lineno">45 </span>
<span class="lineno">46 </span>bash: docker: <span class="nb">command</span> not found
<span class="lineno">47 </span><span class="c1"># Oh? Seems the &quot;docker&quot; package isn&#39;t bundled into &quot;baseline&quot; container</span>
<span class="lineno">48 </span><span class="c1"># images by default (not typically needed, consumes extract space, etc.).</span>
<span class="lineno">49 </span>
<span class="lineno">50 </span><span class="c1"># Done, for now.</span>
<span class="lineno">51 </span>root@b9b5d9166edf:/work# <span class="nb">exit</span>
<span class="lineno">52 </span><span class="nb">exit</span>
</pre></div>
</div>
</div>
<p>Well, that was a short exercise. Looks like we’ll need to define our own custom
“parent” or “top-level” Docker image rather than using a “vanilla” baseline
image. While we’re at it, let’s define a custom “child” Docker image too, for
the sake of being thorough. First, let’s create the Dockerfiles for the parent
and child image, along with the relevant <code class="docutils literal notranslate"><span class="pre">.dockerignore</span></code> files too.</p>
<div class="literal-block-wrapper docutils container" id="id70">
<div class="code-block-caption"><span class="caption-number">Listing 18 </span><span class="caption-text">Dockerfile.dind_example.parent that extends Ubuntu.</span><a class="headerlink" href="#id70" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c"># System packages. Make sure &quot;docker&quot; is included.</span>
<span class="lineno"> 4 </span><span class="k">RUN</span> apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno"> 5 </span>    apt install -y <span class="se">\</span>
<span class="lineno"> 6 </span>        docker.io <span class="se">\</span>
<span class="lineno"> 7 </span>        jq <span class="se">\</span>
<span class="lineno"> 8 </span>        lsb-release <span class="se">\</span>
<span class="lineno"> 9 </span>        make <span class="se">\</span>
<span class="lineno">10 </span>        gcc <span class="se">\</span>
<span class="lineno">11 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">12 </span>    apt clean -y
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id71">
<div class="code-block-caption"><span class="caption-number">Listing 19 </span><span class="caption-text">Dockerfile.dind_example.parent.dockerignore for Dockerfile.dind_example.parent</span><a class="headerlink" href="#id71" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="c"># Ignore everything by default. Have to manually add entries permitted</span>
<span class="lineno">2 </span><span class="c"># for inclusion.</span>
<span class="lineno">3 </span>*
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id72">
<div class="code-block-caption"><span class="caption-number">Listing 20 </span><span class="caption-text">Dockerfile.dind_example.child that extends Debian.</span><a class="headerlink" href="#id72" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="k">FROM</span><span class="s"> debian:buster as baseline</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c"># System packages.</span>
<span class="lineno"> 4 </span><span class="k">RUN</span> apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno"> 5 </span>    apt install -y <span class="se">\</span>
<span class="lineno"> 6 </span>        jq <span class="se">\</span>
<span class="lineno"> 7 </span>        lsb-release <span class="se">\</span>
<span class="lineno"> 8 </span>        make <span class="se">\</span>
<span class="lineno"> 9 </span>        gcc <span class="se">\</span>
<span class="lineno">10 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">11 </span>    apt clean -y
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id73">
<div class="code-block-caption"><span class="caption-number">Listing 21 </span><span class="caption-text">Dockerfile.dind_example.child.dockerignore for Dockerfile.dind_example.child</span><a class="headerlink" href="#id73" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="c"># Ignore everything by default. Have to manually add entries permitted</span>
<span class="lineno">2 </span><span class="c"># for inclusion.</span>
<span class="lineno">3 </span>*
</pre></div>
</div>
</div>
<p>While we’re at it, let’s modify our <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> to be able to build these
images, so we’re not constantly re-typing the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code> operations into
the console manually. Let’s include the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code> operations as goals we
can invoke as well.</p>
<div class="literal-block-wrapper docutils container" id="id74">
<div class="code-block-caption"><span class="caption-number">Listing 22 </span><span class="caption-text">Makefile for building our Docker images.</span><a class="headerlink" href="#id74" title="Permalink to this code">¶</a></div>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c"># Defaults and global settings.</span>
<span class="lineno"> 2 </span><span class="nf">.DEFAULT_GOAL</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno"> 3 </span><span class="nv">PARENT_TAG</span><span class="o">=</span>dind_example_parent:local
<span class="lineno"> 4 </span><span class="nv">CHILD_TAG</span><span class="o">=</span>dind_example_child:local
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="c"># Default goal (no longer builds C app, but can via manually running</span>
<span class="lineno"> 7 </span><span class="c"># &quot;make app&quot;).</span>
<span class="lineno"> 8 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno"> 9 </span><span class="nf">all</span><span class="o">:</span> <span class="n">docker_parent</span> <span class="n">docker_child</span>
<span class="lineno">10 </span>	@echo <span class="s2">&quot;Done build.&quot;</span>
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="c"># Build parent Docker image.</span>
<span class="lineno">13 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">docker_parent</span>
<span class="lineno">14 </span><span class="nf">docker_parent</span><span class="o">:</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">parent</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">parent</span>.<span class="n">dockerignore</span>
<span class="lineno">15 </span>	<span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno">16 </span>			-t <span class="s2">&quot;</span><span class="k">$(</span>PARENT_TAG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">17 </span>			--target baseline <span class="se">\</span>
<span class="lineno">18 </span>			-f Dockerfile.dind_example.parent <span class="se">\</span>
<span class="lineno">19 </span>			.
<span class="lineno">20 </span>
<span class="lineno">21 </span><span class="c"># Build child Docker image.</span>
<span class="lineno">22 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">docker_child</span>
<span class="lineno">23 </span><span class="nf">docker_child</span><span class="o">:</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">child</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">child</span>.<span class="n">dockerignore</span>
<span class="lineno">24 </span>	<span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno">25 </span>			-t <span class="s2">&quot;</span><span class="k">$(</span>CHILD_TAG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">26 </span>			--target baseline <span class="se">\</span>
<span class="lineno">27 </span>			-f Dockerfile.dind_example.child <span class="se">\</span>
<span class="lineno">28 </span>			.
<span class="lineno">29 </span>
<span class="lineno">30 </span><span class="c"># Launch parent container.</span>
<span class="lineno">31 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">run_parent</span>
<span class="lineno">32 </span><span class="nf">run_parent</span><span class="o">:</span>
<span class="lineno">33 </span>	docker run <span class="se">\</span>
<span class="lineno">34 </span>		--rm -it <span class="se">\</span>
<span class="lineno">35 </span>		--volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>shell readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">36 </span>		--workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">37 </span>		--volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">38 </span>		<span class="k">$(</span>PARENT_TAG<span class="k">)</span>
<span class="lineno">39 </span>
<span class="lineno">40 </span><span class="c"># Launch child container.</span>
<span class="lineno">41 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">run_child</span>
<span class="lineno">42 </span><span class="nf">run_child</span><span class="o">:</span>
<span class="lineno">43 </span>	docker run <span class="se">\</span>
<span class="lineno">44 </span>		--rm -it <span class="se">\</span>
<span class="lineno">45 </span>		--volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>shell readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">46 </span>		--workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">47 </span>		--volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">48 </span>		<span class="k">$(</span>CHILD_TAG<span class="k">)</span>
<span class="lineno">49 </span>
<span class="lineno">50 </span><span class="c"># Build our C app.</span>
<span class="lineno">51 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">app</span>
<span class="lineno">52 </span><span class="nf">app</span><span class="o">:</span> <span class="n">helloworld_app</span>
<span class="lineno">53 </span><span class="nf">helloworld_app</span><span class="o">:</span>
<span class="lineno">54 </span>	gcc helloworld.c -o <span class="nv">$@</span>
</pre></div>
</div>
</div>
<p>Alright then: let’s try this again.</p>
<div class="literal-block-wrapper docutils container" id="id75">
<div class="code-block-caption"><span class="caption-number">Listing 23 </span><span class="caption-text">Docker-in-Docker ateempt: round 2.</span><a class="headerlink" href="#id75" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Launch the parent-level container.</span>
<span class="lineno"> 2 </span>owner@darkstar$&gt; make run_parent
<span class="lineno"> 3 </span>docker run <span class="se">\</span>
<span class="lineno"> 4 </span>      --rm -it <span class="se">\</span>
<span class="lineno"> 5 </span>      --volume<span class="o">=</span><span class="s2">&quot;/home/owner/work:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno"> 6 </span>      --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno"> 7 </span>      --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno"> 8 </span>      dind_example_parent:local
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1"># Nice! Let&#39;s verify the OS used by the parent-level container. Should be</span>
<span class="lineno">11 </span><span class="c1"># Ubuntu 20.04.</span>
<span class="lineno">12 </span>root@d1d839fde6d4:/work# lsb_release -a
<span class="lineno">13 </span>No LSB modules are available.
<span class="lineno">14 </span>Distributor ID: Ubuntu
<span class="lineno">15 </span>Description:    Ubuntu <span class="m">20</span>.04.2 LTS
<span class="lineno">16 </span>Release:        <span class="m">20</span>.04
<span class="lineno">17 </span>Codename:       focal
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="c1"># Confirmed! Let&#39;s make sure we can see the files we mounted from the host</span>
<span class="lineno">20 </span><span class="c1"># OS.</span>
<span class="lineno">21 </span>root@d1d839fde6d4:/work# ls -a
<span class="lineno">22 </span>.  ..  Dockerfile  Dockerfile.dind_example.child  Dockerfile.dind_example.child.dockerignore  Dockerfile.dind_example.parent  Dockerfile.dind_example.parent.dockerignore  Makefile  helloworld.c  iax.sh
<span class="lineno">23 </span>
<span class="lineno">24 </span><span class="c1"># So far, so good. Now let&#39;s try to launch the child container, since our</span>
<span class="lineno">25 </span><span class="c1"># parent-level container has Docker installed, and we&#39;re sharing the Docker</span>
<span class="lineno">26 </span><span class="c1"># socket with it.</span>
<span class="lineno">27 </span>root@d1d839fde6d4:/work# make run_child
<span class="lineno">28 </span>docker run <span class="se">\</span>
<span class="lineno">29 </span>        --rm -it <span class="se">\</span>
<span class="lineno">30 </span>        --volume<span class="o">=</span><span class="s2">&quot;/work:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">31 </span>        --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">32 </span>        --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">33 </span>        dind_example_child:local
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="c1"># This looks promising. Let&#39;s verify the child container is a Debian 10</span>
<span class="lineno">36 </span><span class="c1"># &quot;Buster&quot; release.</span>
<span class="lineno">37 </span>root@7662f05f4b1b:/work# lsb_release -a
<span class="lineno">38 </span>No LSB modules are available.
<span class="lineno">39 </span>Distributor ID: Debian
<span class="lineno">40 </span>Description:    Debian GNU/Linux <span class="m">10</span> <span class="o">(</span>buster<span class="o">)</span>
<span class="lineno">41 </span>Release:        <span class="m">10</span>
<span class="lineno">42 </span>Codename:       buster
<span class="lineno">43 </span>
<span class="lineno">44 </span><span class="c1"># Great! We have a parent-level container that can bootstrap our build</span>
<span class="lineno">45 </span><span class="c1"># process, and a child-level container that can run the actual build. Let&#39;s</span>
<span class="lineno">46 </span><span class="c1"># make sure our files are present.</span>
<span class="lineno">47 </span>root@7662f05f4b1b:/work# ls -a
<span class="lineno">48 </span>.  ..
<span class="lineno">49 </span>
<span class="lineno">50 </span><span class="c1"># Wait, what? None of our files are present. Time to debug. Exit child</span>
<span class="lineno">51 </span><span class="c1"># container.</span>
<span class="lineno">52 </span>root@7662f05f4b1b:/work# <span class="nb">exit</span>
<span class="lineno">53 </span><span class="nb">exit</span>
<span class="lineno">54 </span>
<span class="lineno">55 </span><span class="c1"># Exit parent container.</span>
<span class="lineno">56 </span>root@d1d839fde6d4:/work# <span class="nb">exit</span>
<span class="lineno">57 </span><span class="nb">exit</span>
</pre></div>
</div>
</div>
<p>What happened here? We can wee from the console output of the <code class="docutils literal notranslate"><span class="pre">make</span>
<span class="pre">run_child</span></code> command that we’re mapping <code class="docutils literal notranslate"><span class="pre">/work</span></code> within the parent container to
<code class="docutils literal notranslate"><span class="pre">/work</span></code> in the child container, and from the output of the <code class="docutils literal notranslate"><span class="pre">make</span>
<span class="pre">run_parent</span></code> command that we’re mapping the <a class="reference internal" href="glossary.html#term-PWD"><span class="xref std std-term">PWD</span></a> in the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>
to <code class="docutils literal notranslate"><span class="pre">/work</span></code> in the parent container. By transitivity, we should expect that
mounting <a class="reference internal" href="glossary.html#term-PWD"><span class="xref std std-term">PWD</span></a> (host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>) to <code class="docutils literal notranslate"><span class="pre">/work</span></code> (parent container) to
<code class="docutils literal notranslate"><span class="pre">/work</span></code> (child container) should expose the files on our host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> to
the child container. This doesn’t appear to be the case: we only get as far as
making files on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> visible to the parent container. What
happened?</p>
<p>Well, as it turns out, “Docker-in-Docker” or “nested containers”, can be a bit
of a misnomer. Even though we use terms like “parent container” and “child
container”, from an implementation perspective (i.e. “under the hood”), child
containers might be better described as “sibling” containers. Consider
<a class="reference internal" href="#nested-containers"><span class="std std-numref">Fig. 4</span></a> - this looks roughly what one may imagine
represents the concept of “nested containers”: the parent container runs
directly from the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>, and the child container runs within the
parent container.</p>
<div class="figure align-center" id="nested-containers">
<img alt="../_images/nested_containers.png" src="../_images/nested_containers.png" />
<p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">Conceptual model (incorrect, as it turns out) for nested containers.</span><a class="headerlink" href="#nested-containers" title="Permalink to this image">¶</a></p>
</div>
<p>This assumption turns out to be incorrect, and in actuality, the “topology” of
our containers is closer to that of <a class="reference internal" href="#sibling-containers"><span class="std std-numref">Fig. 5</span></a>.</p>
<div class="figure align-center" id="sibling-containers">
<img alt="../_images/sibling_containers.png" src="../_images/sibling_containers.png" />
<p class="caption"><span class="caption-number">Fig. 5 </span><span class="caption-text">Model (approximate) for sibling (i.e. “nested”) containers.</span><a class="headerlink" href="#sibling-containers" title="Permalink to this image">¶</a></p>
</div>
<p>So, what does this all mean? For a in-depth summary, the reader is encouraged
to review <span id="id29">[<a class="reference internal" href="references.html#id3" title="Shashank Mohan Jain. Linux Containers and Virtualization. Apress, India, 2020.">1</a>]</span>, but for now, the key takeaway is this: if we want a
mount point that is visible within the parent container to be visible in the
child container, the volume mount options passed to the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>
invocation of the child container must match those that were passed to the
parent container. For example, in our most recent attempt to use nested
containers, notice the different in the volume mount commands:</p>
<div class="literal-block-wrapper docutils container" id="id76">
<div class="code-block-caption"><span class="caption-number">Listing 24 </span><span class="caption-text">Docker-in-Docker launchers: parent/child invocation comparison.</span><a class="headerlink" href="#id76" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Parent container.</span>
<span class="lineno"> 2 </span>docker run <span class="se">\</span>
<span class="lineno"> 3 </span>      ...
<span class="lineno"> 4 </span>      ...
<span class="lineno"> 5 </span>      --volume<span class="o">=</span><span class="s2">&quot;/home/owner/work:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno"> 6 </span>      --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno"> 7 </span>      ...
<span class="lineno"> 8 </span>      ...
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1"># Child container.</span>
<span class="lineno">11 </span>root@d1d839fde6d4:/work# make run_child
<span class="lineno">12 </span>docker run <span class="se">\</span>
<span class="lineno">13 </span>        ...
<span class="lineno">14 </span>        ...
<span class="lineno">15 </span>        --volume<span class="o">=</span><span class="s2">&quot;/work:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">16 </span>        --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">17 </span>        ...
<span class="lineno">18 </span>        ...
</pre></div>
</div>
</div>
<p>If we were to somehow pass the same <code class="docutils literal notranslate"><span class="pre">--volume</span></code> command used for the parent
container, to the child container’s invocation, we can make the files in
<code class="docutils literal notranslate"><span class="pre">/home/owner/work</span></code> visible to <strong>both</strong> the parent container and the child
container. Ignoring the trivial approach of simply hard-coding the paths (our
project isn’t very portable anymore if we do that, since every developer that
checks out a copy of the project has to go modifying hard-coded paths, and
hopefully not committing said changes back to the shared repository). Rather,
let’s just pass the values used by the parent container invocation to the child
container’s invocation as environment variables. That should do the trick.
First, our modified <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id77">
<div class="code-block-caption"><span class="caption-number">Listing 25 </span><span class="caption-text">Makefile.sibling_container_exports</span><a class="headerlink" href="#id77" title="Permalink to this code">¶</a></div>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c"># Defaults and global settings.</span>
<span class="lineno"> 2 </span><span class="nf">.DEFAULT_GOAL</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno"> 3 </span><span class="nv">PARENT_TAG</span><span class="o">=</span>dind_example_parent:local
<span class="lineno"> 4 </span><span class="nv">CHILD_TAG</span><span class="o">=</span>dind_example_child:local
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="c"># For mounting paths in parent and child containers.</span>
<span class="lineno"> 7 </span><span class="c"># Only set HOST_SRC_PATH if it&#39;s not already set. We expect the</span>
<span class="lineno"> 8 </span><span class="c"># invocation/launch of the parent container to &quot;see&quot; this value as un-set,</span>
<span class="lineno"> 9 </span><span class="c"># while the child container should already see it set via &quot;docker run ... -e</span>
<span class="lineno">10 </span><span class="c"># ...&quot;.</span>
<span class="lineno">11 </span><span class="cp">ifeq ($(HOST_PATH_SRC),)</span>
<span class="lineno">12 </span><span class="nv">HOST_PATH_SRC</span><span class="o">:=</span><span class="k">$(</span>shell readlink -f .<span class="k">)</span>
<span class="lineno">13 </span><span class="cp">endif</span>
<span class="lineno">14 </span><span class="nv">HOST_PATH_DST</span><span class="o">:=</span>/work
<span class="lineno">15 </span>
<span class="lineno">16 </span><span class="c"># Default goal (no longer builds C app, but can via manually running</span>
<span class="lineno">17 </span><span class="c"># &quot;make app&quot;).</span>
<span class="lineno">18 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno">19 </span><span class="nf">all</span><span class="o">:</span> <span class="n">docker_parent</span> <span class="n">docker_child</span>
<span class="lineno">20 </span>	@echo <span class="s2">&quot;Done build.&quot;</span>
<span class="lineno">21 </span>
<span class="lineno">22 </span><span class="c"># Build parent Docker image.</span>
<span class="lineno">23 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">docker_parent</span>
<span class="lineno">24 </span><span class="nf">docker_parent</span><span class="o">:</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">parent</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">parent</span>.<span class="n">dockerignore</span>
<span class="lineno">25 </span>	<span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno">26 </span>			-t <span class="s2">&quot;</span><span class="k">$(</span>PARENT_TAG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">27 </span>			--target baseline <span class="se">\</span>
<span class="lineno">28 </span>			-f Dockerfile.dind_example.parent <span class="se">\</span>
<span class="lineno">29 </span>			.
<span class="lineno">30 </span>
<span class="lineno">31 </span><span class="c"># Build child Docker image.</span>
<span class="lineno">32 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">docker_child</span>
<span class="lineno">33 </span><span class="nf">docker_child</span><span class="o">:</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">child</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">child</span>.<span class="n">dockerignore</span>
<span class="lineno">34 </span>	<span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno">35 </span>			-t <span class="s2">&quot;</span><span class="k">$(</span>CHILD_TAG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">36 </span>			--target baseline <span class="se">\</span>
<span class="lineno">37 </span>			-f Dockerfile.dind_example.child <span class="se">\</span>
<span class="lineno">38 </span>			.
<span class="lineno">39 </span>
<span class="lineno">40 </span><span class="c"># Launch parent container.</span>
<span class="lineno">41 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">run_parent_alt</span>
<span class="lineno">42 </span><span class="nf">run_parent_alt</span><span class="o">:</span>
<span class="lineno">43 </span>	docker run <span class="se">\</span>
<span class="lineno">44 </span>		--rm -it <span class="se">\</span>
<span class="lineno">45 </span>		--volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_SRC<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">:rw&quot;</span> <span class="se">\</span>
<span class="lineno">46 </span>		--workdir<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">47 </span>		-e <span class="nv">HOST_PATH_SRC</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_SRC<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">48 </span>		-e <span class="nv">HOST_PATH_DST</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">49 </span>		--volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">50 </span>		<span class="k">$(</span>PARENT_TAG<span class="k">)</span>
<span class="lineno">51 </span>
<span class="lineno">52 </span><span class="c"># Launch child container.</span>
<span class="lineno">53 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">run_child_alt</span>
<span class="lineno">54 </span><span class="nf">run_child_alt</span><span class="o">:</span>
<span class="lineno">55 </span>	docker run <span class="se">\</span>
<span class="lineno">56 </span>		--rm -it <span class="se">\</span>
<span class="lineno">57 </span>		--volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_SRC<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">:rw&quot;</span> <span class="se">\</span>
<span class="lineno">58 </span>		--workdir<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">59 </span>		-e <span class="nv">HOST_PATH_SRC</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_SRC<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">60 </span>		-e <span class="nv">HOST_PATH_DST</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">61 </span>		--workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">62 </span>		--volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">63 </span>		<span class="k">$(</span>CHILD_TAG<span class="k">)</span>
<span class="lineno">64 </span>
<span class="lineno">65 </span><span class="c"># Build our C app.</span>
<span class="lineno">66 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">app</span>
<span class="lineno">67 </span><span class="nf">app</span><span class="o">:</span> <span class="n">helloworld_app</span>
<span class="lineno">68 </span><span class="nf">helloworld_app</span><span class="o">:</span>
<span class="lineno">69 </span>	gcc helloworld.c -o <span class="nv">$@</span>
</pre></div>
</div>
</div>
<p>Now let’s try this again:</p>
<div class="literal-block-wrapper docutils container" id="id78">
<div class="code-block-caption"><span class="caption-number">Listing 26 </span><span class="caption-text">Docker-in-Docker launcher: round 3.</span><a class="headerlink" href="#id78" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Launch the parent container with our new Makefile (need to specify Makefile</span>
<span class="lineno"> 2 </span><span class="c1"># name and rule, since we made a new Makefile to hold our changes).</span>
<span class="lineno"> 3 </span>make -f Makefile.sibling_container_exports run_parent_alt
<span class="lineno"> 4 </span>docker run <span class="se">\</span>
<span class="lineno"> 5 </span>        --rm -it <span class="se">\</span>
<span class="lineno"> 6 </span>        --volume<span class="o">=</span><span class="s2">&quot;/home/owner/work:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno"> 7 </span>        --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno"> 8 </span>        -e <span class="nv">HOST_PATH_SRC</span><span class="o">=</span><span class="s2">&quot;/home/owner/work&quot;</span> <span class="se">\</span>
<span class="lineno"> 9 </span>        -e <span class="nv">HOST_PATH_DST</span><span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">10 </span>        --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">11 </span>        dind_example_parent:local
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="c1"># Files are visible from parent container.</span>
<span class="lineno">14 </span>root@fc4380b8bc06:/work# ls
<span class="lineno">15 </span>Dockerfile                     Dockerfile.dind_example.child.dockerignore  Dockerfile.dind_example.parent.dockerignore  Makefile.sibling_container_exports  iax.sh
<span class="lineno">16 </span>Dockerfile.dind_example.child  Dockerfile.dind_example.parent              Makefile                                     helloworld.c
<span class="lineno">17 </span>
<span class="lineno">18 </span><span class="c1"># Verify environment variables were passed to parent container (it needs to</span>
<span class="lineno">19 </span><span class="c1"># pass them along to the child container).</span>
<span class="lineno">20 </span>root@fc4380b8bc06:/work# <span class="nb">export</span> <span class="p">|</span> grep HOST_PATH
<span class="lineno">21 </span><span class="nb">declare</span> -x <span class="nv">HOST_PATH_DST</span><span class="o">=</span><span class="s2">&quot;/work&quot;</span>
<span class="lineno">22 </span><span class="nb">declare</span> -x <span class="nv">HOST_PATH_SRC</span><span class="o">=</span><span class="s2">&quot;/home/owner/work&quot;</span>
<span class="lineno">23 </span>
<span class="lineno">24 </span><span class="c1"># Looking good so far. Now let&#39;s launch the child container.</span>
<span class="lineno">25 </span>root@fc4380b8bc06:/work# make -f Makefile.sibling_container_exports run_child_alt
<span class="lineno">26 </span>docker run <span class="se">\</span>
<span class="lineno">27 </span>        --rm -it <span class="se">\</span>
<span class="lineno">28 </span>        --volume<span class="o">=</span><span class="s2">&quot;/home/owner/work:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">29 </span>        --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">30 </span>        -e <span class="nv">HOST_PATH_SRC</span><span class="o">=</span><span class="s2">&quot;/home/owner/work&quot;</span> <span class="se">\</span>
<span class="lineno">31 </span>        -e <span class="nv">HOST_PATH_DST</span><span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">32 </span>        --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">33 </span>        --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">34 </span>        dind_example_child:local
<span class="lineno">35 </span>
<span class="lineno">36 </span><span class="c1"># Can we see our files in the child container?</span>
<span class="lineno">37 </span>root@a841398f3d24:/work# ls
<span class="lineno">38 </span>Dockerfile                     Dockerfile.dind_example.child.dockerignore  Dockerfile.dind_example.parent.dockerignore  Makefile.sibling_container_exports  iax.sh
<span class="lineno">39 </span>Dockerfile.dind_example.child  Dockerfile.dind_example.parent              Makefile                                     helloworld.c
<span class="lineno">40 </span>
<span class="lineno">41 </span><span class="c1"># YES!!! Now, can our child container compile our application (the whole</span>
<span class="lineno">42 </span><span class="c1"># point of having the child container: a dedicated container to build a</span>
<span class="lineno">43 </span><span class="c1"># specific app via our top-level Makefile).</span>
<span class="lineno">44 </span>root@a841398f3d24:/work# make -f Makefile.sibling_container_exports app
<span class="lineno">45 </span>gcc helloworld.c -o helloworld_app
<span class="lineno">46 </span>
<span class="lineno">47 </span><span class="c1"># Beautiful! All done! Exit child container.</span>
<span class="lineno">48 </span>root@a841398f3d24:/work# <span class="nb">exit</span>
<span class="lineno">49 </span><span class="nb">exit</span>
<span class="lineno">50 </span>
<span class="lineno">51 </span><span class="c1"># Exit parent container.</span>
<span class="lineno">52 </span>root@fc4380b8bc06:/work# <span class="nb">exit</span>
<span class="lineno">53 </span><span class="nb">exit</span>
</pre></div>
</div>
</div>
<p>Excellent! We are able to have a top-level container launch child containers
on-demand to carry out various stages of the build. Furthermore, we could make
additional modifications to a top-level launcher script (e.g. <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code>) so
that it can bootstrap the entire build from a parent-level container via
something like <code class="docutils literal notranslate"><span class="pre">./iax.sh</span> <span class="pre">make</span> <span class="pre">run_parent</span></code>, which can then trigger the various
intermediate build steps.</p>
<p>Before we conclude this section, there’s one last edge-case I’d like to visit
(which turns out to be rather common): what if we can’t 100% control the
parent-level container (i.e. have it export the <code class="docutils literal notranslate"><span class="pre">HOST_PATH_SRC</span></code> and
<code class="docutils literal notranslate"><span class="pre">HOST_PATH_DST</span></code> environment variables to the child container)? This can
happen in cases where using build systems as part of a <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> pipeline
that have the runners/builders (i.e. hosts, physical or virtual) execute build
jobs from a container <span id="id30">[<a class="reference internal" href="references.html#id31" title="GitLab Inc. Run GitLab Runner in a container. \url https://docs.gitlab.com/runner/install/docker.html, accessed 2021-08-03.">24</a>]</span> <span id="id31">[<a class="reference internal" href="references.html#id32" title="The Jenkins Project. Docker plugin for Jenkins. \url https://plugins.jenkins.io/docker-plugin/, accessed 2021-08-03.">25</a>]</span>. If this is the case,
we’ll have problems with <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> builds, as we’ll once again have the
problem where the child container doesn’t have the necessary information
required for it to properly access the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> file mount. What is one
to do?</p>
<p>It turns out there is a means (albeit, somewhat “hacky’ish”) that allows a
container to query information on other running containers, if we allow our
“parent” container to access <code class="docutils literal notranslate"><span class="pre">/var/lib/docker.sock</span></code> (hence the previous
warnings that allowing containers access to this grant them elevated control of
the host system). Before proceeding, let’s establish some (loose) terminology.</p>
<ul class="simple">
<li><p>“Launcher container”: the true “parent container”. It’s the top-level
container that a <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> system uses to launch a build job.</p></li>
<li><p>“Bootstrap container”: our own “parent container” (i.e. Ubuntu 20.04)
that we’ve been working with so far. Since it’s not being used to the launch
the build job, it’s technically a “child container” (and the “child
container” is actually a “grandchild” container). The “Launcher container” is
responsible solely for invoking the “bootstrap container”, which is then
responsible for handling the rest of the build.</p></li>
<li><p>“Builder container”: our own “child container” (i.e. Debian 10 “Buster”) that
we’ve been using so far (is actually a “grandchild container” due to multiple
levels of parent containers).</p></li>
</ul>
<p>Now, let’s assume that the launcher container invokes the bootstrap container
via something like <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">...</span> <span class="pre">make</span> <span class="pre">run_child</span></code>, and that the Docker socket on
any system is <strong>always</strong> <code class="docutils literal notranslate"><span class="pre">/var/run/docker.sock</span></code>, and that it is being mounted
in the launcher container via
<code class="docutils literal notranslate"><span class="pre">--volume=/var/run/docker.sock:/var/run/docker.sock</span></code> (i.e. while tools like
<code class="docutils literal notranslate"><span class="pre">iax.sh</span></code> are useful for local builds, <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> systems will never use
them, and prefer their own methods/scripts for bootstrapping builds).</p>
<p>With these assumptions in place, we should be able to, using some Docker
commands (i.e.  <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">inspect</span></code>) execute various queries within the context
of the bootstrap container, and then pass them along to child (i.e. “builder”)
containers at run time. This should let us, within the bootstrap container,
dynamically determine the equivalent of <code class="docutils literal notranslate"><span class="pre">HOST_PATH_SRC</span></code> and
<code class="docutils literal notranslate"><span class="pre">HOST_PATH_DST</span></code>. First, let’s review our modified <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, and our
introspection helper script.</p>
<div class="literal-block-wrapper docutils container" id="id79">
<div class="code-block-caption"><span class="caption-number">Listing 27 </span><span class="caption-text">Makefile.introspection</span><a class="headerlink" href="#id79" title="Permalink to this code">¶</a></div>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c"># Defaults and global settings.</span>
<span class="lineno"> 2 </span><span class="nf">.DEFAULT_GOAL</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno"> 3 </span><span class="nv">PARENT_TAG</span><span class="o">=</span>dind_example_parent:local
<span class="lineno"> 4 </span><span class="nv">CHILD_TAG</span><span class="o">=</span>dind_example_child:local
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="c"># For mounting paths in parent and child containers.</span>
<span class="lineno"> 7 </span><span class="c"># Only set HOST_SRC_PATH if it&#39;s not already set. We expect the</span>
<span class="lineno"> 8 </span><span class="c"># invocation/launch of the parent container to &quot;see&quot; this value as un-set,</span>
<span class="lineno"> 9 </span><span class="c"># while the child container should already see it set via &quot;docker run ... -e</span>
<span class="lineno">10 </span><span class="c"># ...&quot;.</span>
<span class="lineno">11 </span><span class="cp">ifeq ($(HOST_PATH_SRC),)</span>
<span class="lineno">12 </span><span class="nv">HOST_PATH_SRC</span><span class="o">:=</span><span class="k">$(</span>shell readlink -f .<span class="k">)</span>
<span class="lineno">13 </span><span class="cp">endif</span>
<span class="lineno">14 </span><span class="nv">HOST_PATH_DST</span><span class="o">:=</span>/work
<span class="lineno">15 </span>
<span class="lineno">16 </span><span class="c"># Psuedo-random path to PWD. Build systems often use tools like `mktmp` to</span>
<span class="lineno">17 </span><span class="c"># create throwaway intermediate build paths for jobs.</span>
<span class="lineno">18 </span><span class="nv">HOST_PATH_SRC_RANDOM</span><span class="o">:=</span><span class="k">$(</span>HOST_PATH_SRC<span class="k">)</span>_<span class="k">$(</span>shell shuf -i <span class="m">1000000</span>-9999999 -n <span class="m">1</span><span class="k">)</span>
<span class="lineno">19 </span>
<span class="lineno">20 </span><span class="c"># Default goal (no longer builds C app, but can via manually running</span>
<span class="lineno">21 </span><span class="c"># &quot;make app&quot;).</span>
<span class="lineno">22 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno">23 </span><span class="nf">all</span><span class="o">:</span> <span class="n">docker_parent</span> <span class="n">docker_child</span>
<span class="lineno">24 </span>	@echo <span class="s2">&quot;Done build.&quot;</span>
<span class="lineno">25 </span>
<span class="lineno">26 </span><span class="c"># Launcher image (our &quot;parent&quot; image from earlier examples). We&#39;ll also use it</span>
<span class="lineno">27 </span><span class="c"># as our bootstrap image.</span>
<span class="lineno">28 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">docker_parent</span>
<span class="lineno">29 </span><span class="nf">docker_parent</span><span class="o">:</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">parent</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">parent</span>.<span class="n">dockerignore</span>
<span class="lineno">30 </span>	<span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno">31 </span>			-t <span class="s2">&quot;</span><span class="k">$(</span>PARENT_TAG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">32 </span>			--target baseline <span class="se">\</span>
<span class="lineno">33 </span>			-f Dockerfile.dind_example.parent <span class="se">\</span>
<span class="lineno">34 </span>			.
<span class="lineno">35 </span>
<span class="lineno">36 </span>
<span class="lineno">37 </span><span class="c"># Builder image (our &quot;child&quot; image from earlier examples).</span>
<span class="lineno">38 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">docker_child</span>
<span class="lineno">39 </span><span class="nf">docker_child</span><span class="o">:</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">child</span> <span class="n">Dockerfile</span>.<span class="n">dind_example</span>.<span class="n">child</span>.<span class="n">dockerignore</span>
<span class="lineno">40 </span>	<span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno">41 </span>			-t <span class="s2">&quot;</span><span class="k">$(</span>CHILD_TAG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">42 </span>			--target baseline <span class="se">\</span>
<span class="lineno">43 </span>			-f Dockerfile.dind_example.child <span class="se">\</span>
<span class="lineno">44 </span>			.
<span class="lineno">45 </span>
<span class="lineno">46 </span><span class="c"># Launch &quot;launcher&quot; container.</span>
<span class="lineno">47 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">run_launcher</span>
<span class="lineno">48 </span><span class="nf">run_launcher</span><span class="o">:</span>
<span class="lineno">49 </span><span class="c">	# Create pseudo-random path to emulate behavior of CI/CD systems.</span>
<span class="lineno">50 </span><span class="c">	# For educational purposes only.</span>
<span class="lineno">51 </span><span class="c">	# DON&#39;T USE SUDO IN YOUR BUILD SCRIPTS!!!</span>
<span class="lineno">52 </span>	mkdir -p <span class="k">$(</span>HOST_PATH_SRC_RANDOM<span class="k">)</span>
<span class="lineno">53 </span>	sudo mount --bind <span class="k">$(</span>HOST_PATH_SRC<span class="k">)</span> <span class="k">$(</span>HOST_PATH_SRC_RANDOM<span class="k">)</span>
<span class="lineno">54 </span>	@echo <span class="s2">&quot;RANDOM PATH: </span><span class="k">$(</span>HOST_PATH_SRC_RANDOM<span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno">55 </span>
<span class="lineno">56 </span>	docker run <span class="se">\</span>
<span class="lineno">57 </span>		--rm -it <span class="se">\</span>
<span class="lineno">58 </span>		--volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_SRC_RANDOM<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">:rw&quot;</span> <span class="se">\</span>
<span class="lineno">59 </span>		--workdir<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">60 </span>		-e <span class="nv">HOST_PATH_SRC</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_SRC<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">61 </span>		-e <span class="nv">HOST_PATH_DST</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">62 </span>		--volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">63 </span>		<span class="k">$(</span>PARENT_TAG<span class="k">)</span> <span class="se">\</span>
<span class="lineno">64 </span>		docker run <span class="se">\</span>
<span class="lineno">65 </span>			--rm -it <span class="se">\</span>
<span class="lineno">66 </span>			--volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_SRC_RANDOM<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">:rw&quot;</span> <span class="se">\</span>
<span class="lineno">67 </span>			--workdir<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>HOST_PATH_DST<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">68 </span>			--volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">69 </span>			<span class="k">$(</span>PARENT_TAG<span class="k">)</span>
<span class="lineno">70 </span>
<span class="lineno">71 </span><span class="c">	# Clean up.</span>
<span class="lineno">72 </span>	sudo umount <span class="k">$(</span>HOST_PATH_SRC_RANDOM<span class="k">)</span>
<span class="lineno">73 </span>
<span class="lineno">74 </span><span class="c"># Build our C app.</span>
<span class="lineno">75 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">app</span>
<span class="lineno">76 </span><span class="nf">app</span><span class="o">:</span> <span class="n">helloworld_app</span>
<span class="lineno">77 </span><span class="nf">helloworld_app</span><span class="o">:</span>
<span class="lineno">78 </span>	gcc helloworld.c -o <span class="nv">$@</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id80">
<div class="code-block-caption"><span class="caption-number">Listing 28 </span><span class="caption-text">docker_mount_resolver.sh</span><a class="headerlink" href="#id80" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/bin/bash</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c1"># Needs an argument.</span>
<span class="lineno"> 4 </span><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno"> 5 </span>    <span class="nb">exit</span> <span class="m">1</span>
<span class="lineno"> 6 </span><span class="k">fi</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="c1"># Get the name of the image for the currently running container.</span>
<span class="lineno"> 9 </span><span class="nv">SELF_IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="k">$(</span>head /proc/1/cgroup<span class="k">)</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="lineno">10 </span>
<span class="lineno">11 </span><span class="c1"># Might need to strip out some extra info depending how old your Docker</span>
<span class="lineno">12 </span><span class="c1"># installation is.</span>
<span class="lineno">13 </span><span class="nv">SELF_IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">SELF_IMAGE_NAME</span><span class="si">}</span> <span class="p">|</span> sed <span class="s2">&quot;s/^docker-//g&quot;</span> <span class="p">|</span> sed <span class="s2">&quot;s/\.scope</span>$<span class="s2">//g&quot;</span><span class="k">)</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span><span class="c1"># Search mounts associated with currently running container. Return a match if</span>
<span class="lineno">16 </span><span class="c1"># found.</span>
<span class="lineno">17 </span>docker inspect --format <span class="s1">&#39;{{json .Mounts }}&#39;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SELF_IMAGE_NAME</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">|</span> jq -c <span class="s1">&#39;.[]&#39;</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> key <span class="p">;</span> <span class="k">do</span>
<span class="lineno">18 </span>    <span class="nv">src</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">key</span><span class="si">}</span> <span class="p">|</span> jq -r .Source<span class="k">)</span>
<span class="lineno">19 </span>    <span class="nv">dst</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">key</span><span class="si">}</span> <span class="p">|</span> jq -r .Destination<span class="k">)</span>
<span class="lineno">20 </span>    <span class="nb">echo</span> <span class="s2">&quot;SRC:</span><span class="si">${</span><span class="nv">src</span><span class="si">}</span><span class="s2"> DST:</span><span class="si">${</span><span class="nv">dst</span><span class="si">}</span><span class="s2">&quot;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="lineno">21 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">dst</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">22 </span>        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">src</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">23 </span>        <span class="nb">exit</span> <span class="m">0</span>
<span class="lineno">24 </span>    <span class="k">fi</span>
<span class="lineno">25 </span><span class="k">done</span>
</pre></div>
</div>
</div>
<p>Now, let’s launch our launcher container (e.g. represents something similar to
a GitLab or Jenkins “runner” image), and then launch our bootstrap container
(effectively the “parent” container we’ve been working with throughout this
section), and see what useful information we can glean.</p>
<div class="literal-block-wrapper docutils container" id="id81">
<div class="code-block-caption"><span class="caption-number">Listing 29 </span><span class="caption-text">Docker-in-Docker launcher: using introspection.</span><a class="headerlink" href="#id81" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span>owner@darkstar$&gt; make -f Makefile.introspection run_launcher
<span class="lineno"> 2 </span><span class="c1"># Create pseudo-random path to emulate behavior of CI/CD systems.</span>
<span class="lineno"> 3 </span><span class="c1"># For educational purposes only.</span>
<span class="lineno"> 4 </span><span class="c1"># DON&#39;T USE SUDO IN YOUR BUILD SCRIPTS!!!</span>
<span class="lineno"> 5 </span>mkdir -p /home/owner/work_2338367
<span class="lineno"> 6 </span>sudo mount --bind /home/owner/work /home/owner/work_2338367
<span class="lineno"> 7 </span>RANDOM PATH: /home/owner/work_2338367
<span class="lineno"> 8 </span>docker run <span class="se">\</span>
<span class="lineno"> 9 </span>        --rm -it <span class="se">\</span>
<span class="lineno">10 </span>        --volume<span class="o">=</span><span class="s2">&quot;/home/owner/work_2338367:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">11 </span>        --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">12 </span>        -e <span class="nv">HOST_PATH_SRC</span><span class="o">=</span><span class="s2">&quot;/home/owner/work&quot;</span> <span class="se">\</span>
<span class="lineno">13 </span>        -e <span class="nv">HOST_PATH_DST</span><span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">14 </span>        --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">15 </span>        dind_example_parent:local <span class="se">\</span>
<span class="lineno">16 </span>        docker run <span class="se">\</span>
<span class="lineno">17 </span>                --rm -it <span class="se">\</span>
<span class="lineno">18 </span>                --volume<span class="o">=</span><span class="s2">&quot;/home/owner/work_2338367:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">19 </span>                --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">20 </span>                --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">21 </span>                dind_example_parent:local
<span class="lineno">22 </span>
<span class="lineno">23 </span><span class="c1"># Launched 2 levels of Docker, now in the &quot;bootstrap&quot; container.</span>
<span class="lineno">24 </span>root@094da58d8a64:/work# ls
<span class="lineno">25 </span>Dockerfile                     Dockerfile.dind_example.child.dockerignore  Dockerfile.dind_example.parent.dockerignore  Makefile.introspection              docker_mount_resolver.sh  helloworld_app
<span class="lineno">26 </span>Dockerfile.dind_example.child  Dockerfile.dind_example.parent              Makefile                                     Makefile.sibling_container_exports  helloworld.c              iax.sh
<span class="lineno">27 </span>
<span class="lineno">28 </span><span class="c1"># Make sure no env vars to &quot;cheat&quot; with.</span>
<span class="lineno">29 </span>root@094da58d8a64:/work# <span class="nb">export</span> <span class="p">|</span> grep HOST_PATH
<span class="lineno">30 </span>
<span class="lineno">31 </span><span class="c1"># Try to find a Docker mount in the parent container matching &quot;blah&quot; (we know</span>
<span class="lineno">32 </span><span class="c1"># this will fail, just running the script to see what kind of results we&#39;re</span>
<span class="lineno">33 </span><span class="c1"># searching through).</span>
<span class="lineno">34 </span>root@094da58d8a64:/work# ./docker_mount_resolver.sh blah
<span class="lineno">35 </span>SRC:/home/owner/work_2338367 DST:/work
<span class="lineno">36 </span>SRC:/var/run/docker.sock DST:/var/run/docker.sock
<span class="lineno">37 </span>
<span class="lineno">38 </span><span class="c1"># Done.</span>
<span class="lineno">39 </span>root@094da58d8a64:/work# <span class="nb">exit</span>
<span class="lineno">40 </span><span class="c1"># Clean up.</span>
<span class="lineno">41 </span>sudo umount /home/owner/code/repos/iaxes/pronk8s-src/examples/build_patterns/dind_example_2338367
</pre></div>
</div>
</div>
<p>So we can see that through the use of a tool like our
<code class="docutils literal notranslate"><span class="pre">docker_mount_resolver.sh</span></code> script we can see the mounts used by the parent of
our bootstrap container (i.e. the launcher container), and we could make an
educated guess as to which of the results yields the pair of strings we’d pass
to a child container if we wanted it to be able to access files from the host
<a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> (hint: in the above example, it’s
<code class="docutils literal notranslate"><span class="pre">SRC:/home/owner/work_2338367</span> <span class="pre">DST:/work</span></code>). However, the key point to keep in
mind is that <strong>it’s still a guess</strong>. Unless your <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> system exports
some environment variables or provides some means of querying/exporting these
values at run time, you’ll have to use some sort of run-time introspection to
fully leverage nested containers in your own <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> pipelines. This can
be further compounded with minor discrepancies between runners (i.e. hosts that
execute builds for the pipeline), such as a difference in path names or path
patterns on in-house versus <a class="reference internal" href="glossary.html#term-AWS"><span class="xref std std-term">AWS</span></a> instances of runners. Also, you’ll need
to get the necessary approvals from your <a class="reference internal" href="glossary.html#term-ITS"><span class="xref std std-term">ITS</span></a> department due to the
security implications of sharing the Docker socket, and so on. So, it’s worth
noting that as useful and flexible nested Docker/container builds are, they are
not without their caveats, and you may end up finding it easier (in terms of
not using introspection scripts, getting approval from <a class="reference internal" href="glossary.html#term-ITS"><span class="xref std std-term">ITS</span></a> on how
you’ll implement your <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> pipelines, etc.) to use multi-container
builds rather than nested container builds.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Build pattern viability metrics.</p>
<p>Repeatable: moderately repeatable. DevOps team members will likely have to
debug numerous corner-cases that arise due to differences in CI/CD builds
versus local/developer builds.</p>
<p>Reliable: very reliable, provided the host OS itself is stable.</p>
<p>Maintainable: yes, but additional testing/debugging by developers and DevOps
to “get it right initially” (i.e. working out quirks in build infrastructure
for CI/CD builds versus local/developer builds). More complex to maintain as
developers responsible for maintaining the build scripts will need to be
sufficiently versed in Linux and Docker.</p>
<p>Scalable: extremely scalable.</p>
</div>
</div>
<div class="section" id="advanced-example-single-container-with-docker">
<h3>Advanced Example: Single Container with Docker<a class="headerlink" href="#advanced-example-single-container-with-docker" title="Permalink to this headline">¶</a></h3>
<p>This section focuses exclusively on an advanced version of the <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code>
launcher script covered in <a class="reference internal" href="#ssec-single-container"><span class="std std-ref">Single Container with Docker</span></a>, with emphasis on
day-to-day “real world” scenarios where one would use a Docker container for
building projects from source locally (and has no relevance to <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a>
build infrastructure). Therefore, the following section is only recommended for
those that will be building (or supporting builds) of source trees on local
development environments (e.g. workstations/laptops for individual
contributors).</p>
<p>Now, with that said, let’s just demonstrate our “improved” launcher script, and
then we’ll go through the various options, line-by-line, and explain their
significance (with “real-world” examples) as we go along.</p>
<div class="literal-block-wrapper docutils container" id="id82">
<div class="code-block-caption"><span class="caption-number">Listing 30 </span><span class="caption-text">iax.sh - advanced Docker launcher script.</span><a class="headerlink" href="#id82" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/bin/bash</span>
<span class="lineno"> 2 </span><span class="c1">################################################################################</span>
<span class="lineno"> 3 </span><span class="c1"># @brief:       Docker-bootstrap script for building projects via a Docker</span>
<span class="lineno"> 4 </span><span class="c1">#               image.</span>
<span class="lineno"> 5 </span><span class="c1"># @author:      Matthew Giassa.</span>
<span class="lineno"> 6 </span><span class="c1"># @e-mail:      matthew@giassa.net</span>
<span class="lineno"> 7 </span><span class="c1"># @copyright:   Matthew Giassa (IAXES) 2017.</span>
<span class="lineno"> 8 </span><span class="c1">################################################################################</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1"># Docker runtime image to use for building artifacts.</span>
<span class="lineno">11 </span><span class="nv">DOCKER_IMG</span><span class="o">=</span><span class="s2">&quot;iaxes/iaxes-docker-builder-docs&quot;</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="c1"># Need to dynamically create a set of &quot;--group-add&quot; statements while iteration</span>
<span class="lineno">14 </span><span class="c1"># across all groups for which we are a member, otherwise a simple</span>
<span class="lineno">15 </span><span class="c1"># &quot;--user=$(id -u):$(id -g)&quot; argument to &quot;docker run&quot; will only capture our</span>
<span class="lineno">16 </span><span class="c1"># primary group ID, and overlook our secondary group IDs (which means we won&#39;t</span>
<span class="lineno">17 </span><span class="c1"># be a member of the &quot;docker&quot; group when executing nested containers as a</span>
<span class="lineno">18 </span><span class="c1"># rootless user, causing headaches).</span>
<span class="lineno">19 </span><span class="nv">MY_GROUPS</span><span class="o">=(</span><span class="s2">&quot;</span><span class="k">$(</span>groups<span class="k">)</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="lineno">20 </span><span class="nv">MY_GROUPS_STR</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="lineno">21 </span><span class="k">for</span> grp in <span class="si">${</span><span class="nv">MY_GROUPS</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
<span class="lineno">22 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">grp</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">23 </span>        <span class="k">continue</span>
<span class="lineno">24 </span>    <span class="k">else</span>
<span class="lineno">25 </span>        <span class="c1"># Need to use GID, not group name.</span>
<span class="lineno">26 </span>        <span class="nv">gid</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>getent group <span class="si">${</span><span class="nv">grp</span><span class="si">}</span><span class="k">)</span> <span class="p">|</span> awk -F <span class="s1">&#39;:&#39;</span> <span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno">27 </span>        <span class="nv">MY_GROUPS_STR</span><span class="o">+=</span><span class="s2">&quot;--group-add </span><span class="si">${</span><span class="nv">gid</span><span class="si">}</span><span class="s2"> &quot;</span>
<span class="lineno">28 </span>    <span class="k">fi</span>
<span class="lineno">29 </span><span class="k">done</span>
<span class="lineno">30 </span>
<span class="lineno">31 </span><span class="c1"># Debug logging.</span>
<span class="lineno">32 </span><span class="c1"># echo &quot;My groups: ${MY_GROUPS[@]}&quot;     &gt;&amp;2</span>
<span class="lineno">33 </span><span class="c1"># echo &quot;Group string: ${MY_GROUPS_STR}&quot; &gt;&amp;2</span>
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="c1"># Launch docker container.</span>
<span class="lineno">36 </span><span class="c1"># * Setup PWD on host to mount to &quot;/work&quot; in the guest/container.</span>
<span class="lineno">37 </span><span class="c1"># * Forward access to SSH agent and host credentials (so container uses same</span>
<span class="lineno">38 </span><span class="c1">#   user/group permissions as current user that launches the script).</span>
<span class="lineno">39 </span><span class="c1"># * Make DIND possible (i.e. expose host Docker Unix domain socket to</span>
<span class="lineno">40 </span><span class="c1">#   guest/container).</span>
<span class="lineno">41 </span><span class="c1"># * Make the home directory be &quot;/work&quot; so that it&#39;s always writeable (allows us</span>
<span class="lineno">42 </span><span class="c1">#   to better handle rootless DIND and KIND).</span>
<span class="lineno">43 </span><span class="c1"># * Use host networking (non-ideal, but necessary for top-level containers to</span>
<span class="lineno">44 </span><span class="c1">#   access certain services like KIND-exposed kubeadm ports redirecting to port</span>
<span class="lineno">45 </span><span class="c1">#   6443 inside a pod without requiring a bridge being setup in advance).</span>
<span class="lineno">46 </span>docker run <span class="se">\</span>
<span class="lineno">47 </span>    --rm -it <span class="se">\</span>
<span class="lineno">48 </span>    --user<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>id -u<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>id -g<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">49 </span>    <span class="si">${</span><span class="nv">MY_GROUPS_STR</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">50 </span>    --volume<span class="o">=</span><span class="s2">&quot;/etc/passwd:/etc/passwd:ro&quot;</span> <span class="se">\</span>
<span class="lineno">51 </span>    --volume<span class="o">=</span><span class="s2">&quot;/etc/group:/etc/group:ro&quot;</span> <span class="se">\</span>
<span class="lineno">52 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">53 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">54 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f ~/.ssh<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>readlink -f ~/.ssh<span class="k">)</span><span class="s2">:ro&quot;</span> <span class="se">\</span>
<span class="lineno">55 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span><span class="k">)</span><span class="s2">:</span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">56 </span>    -e <span class="nv">SSH_AUTH_SOCK</span><span class="o">=</span><span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">57 </span>    --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">58 </span>    -e <span class="nv">HOME</span><span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">59 </span>    --network<span class="o">=</span>host <span class="se">\</span>
<span class="lineno">60 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">61 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
</pre></div>
</div>
</div>
<p>Before proceeding, it is worth noting that, for certain types of work, I will
use a command-line <a class="reference internal" href="glossary.html#term-SSH"><span class="xref std std-term">SSH</span></a> agent to cache credentials. This is so that I
don’t find myself repeatedly having to type in passphrases every single time I
execute a <code class="docutils literal notranslate"><span class="pre">git</span></code> or <code class="docutils literal notranslate"><span class="pre">ssh</span></code> command. A common way to do this, assuming one has
a <code class="docutils literal notranslate"><span class="pre">~/.ssh/id_rsa</span></code> private key and <code class="docutils literal notranslate"><span class="pre">~/.ssh/id_rsa.pub</span></code> public key, for
example, is like so:</p>
<div class="literal-block-wrapper docutils container" id="id83">
<div class="code-block-caption"><span class="caption-number">Listing 31 </span><span class="caption-text">Example of launching an SSH agent instance to cache credentials.</span><a class="headerlink" href="#id83" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="nb">eval</span> <span class="sb">`</span>ssh-agent<span class="sb">`</span>
<span class="lineno">2 </span>ssh-add ~/.ssh/id_rsa
</pre></div>
</div>
</div>
<p>After running this, subsequent commands will inherit the relevant environment
variables the above-noted commands generate (i.e. <code class="docutils literal notranslate"><span class="pre">SSH_AGENT_PID</span></code>,
<code class="docutils literal notranslate"><span class="pre">SSH_AUTH_SOCK</span></code>), so you could launch an instance of <code class="docutils literal notranslate"><span class="pre">tmux</span></code> <span id="id32">[<a class="reference internal" href="references.html#id24" title="The tmux Maintainers. Welcome to tmux! \url https://github.com/tmux/tmux/wiki, accessed 2021-08-01.">26</a>]</span>
for example, and all panes/windows/etc. created within it would have access to
this credential cache (helpful for having multiple “tabs” open at once and not
having to manually enter credentials into all of them manually). For example,
in <a class="reference internal" href="#tmux-0"><span class="std std-numref">Fig. 6</span></a>, I have various editors, tools, etc.; running in the
various <cite>tmux</cite> panes, and I’ve only had to enter my credentials once rather
than 6+ times. When I eventually terminate the <code class="docutils literal notranslate"><span class="pre">tmux</span></code> instance itself at the
end of my work day, the credential cache is gone, and we can just repeat the
whole process again another day.</p>
<div class="figure align-center" id="tmux-0">
<img alt="../_images/tmux_0.png" src="../_images/tmux_0.png" />
<p class="caption"><span class="caption-number">Fig. 6 </span><span class="caption-text">Example of my (console-centric) development environment.</span><a class="headerlink" href="#tmux-0" title="Permalink to this image">¶</a></p>
</div>
<p>Why is this relevant, you might ask? Well, while the bulk of coding and editing
(in my case) is done on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>, the majority of the build
operations take place in containers. These containers, by default, do not have
access to my <a class="reference internal" href="glossary.html#term-SSH"><span class="xref std std-term">SSH</span></a> keys, credentials, etc.; so they cannot interact with
various pieces of build infrastructure to carry out common tasks, such as
checking out code from a <code class="docutils literal notranslate"><span class="pre">git</span></code> repository, downloading
dependencies/intermediate-build-artifacts from secured repositories, etc. While
in theory, one could duplicate their credentials into a Docker container (i.e.
by modifying the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> to bundle credentials and keys into the image,
<strong>which is a horrible idea</strong>, as discussed in further detail in
<a class="reference internal" href="#sec-containers-security"><span class="std std-ref">Best Practises &amp; Security Concerns</span></a>), there’s a better, and much more temporary way
to accomplish this (without having build artifacts containing credentials
floating around on your workstation, or even worse, shared build infrastructure
in case you accidentally published the image).</p>
<p>Now, on to the specific options we use when launching our builder image.</p>
<div class="literal-block-wrapper docutils container" id="id84">
<div class="code-block-caption"><span class="caption-number">Listing 32 </span><span class="caption-text">Description of advanced Docker launcher command.</span><a class="headerlink" href="#id84" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span>docker run <span class="se">\</span>
<span class="lineno">2 </span>    --rm -it <span class="se">\</span>
<span class="lineno">3 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">4 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">5 </span>    ...
<span class="lineno">6 </span>    ...
<span class="lineno">7 </span>    ...
<span class="lineno">8 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">9 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
</pre></div>
</div>
</div>
<p>Nothing new here: this is how we’ve been launching builder containers so far
(i.e. attach <code class="docutils literal notranslate"><span class="pre">STDIN</span></code>, allocate a pseudo-TTY, clean-up when done, mount the
<a class="reference internal" href="glossary.html#term-PWD"><span class="xref std std-term">PWD</span></a> on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> to <code class="docutils literal notranslate"><span class="pre">/work</span></code> inside the running container,
pass along command-line arguments, etc.).</p>
<div class="literal-block-wrapper docutils container" id="id85">
<div class="code-block-caption"><span class="caption-number">Listing 33 </span><span class="caption-text">Description of advanced Docker launcher command.</span><a class="headerlink" href="#id85" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span>docker run <span class="se">\</span>
<span class="lineno"> 2 </span>    ...
<span class="lineno"> 3 </span>    ...
<span class="lineno"> 4 </span>    ...
<span class="lineno"> 5 </span>    --user<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>id -u<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>id -g<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno"> 6 </span>    --volume<span class="o">=</span><span class="s2">&quot;/etc/passwd:/etc/passwd:ro&quot;</span> <span class="se">\</span>
<span class="lineno"> 7 </span>    --volume<span class="o">=</span><span class="s2">&quot;/etc/group:/etc/group:ro&quot;</span> <span class="se">\</span>
<span class="lineno"> 8 </span>    ...
<span class="lineno"> 9 </span>    ...
<span class="lineno">10 </span>    ...
<span class="lineno">11 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">12 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
</pre></div>
</div>
</div>
<p>These commands instruct Docker to run under a specific user and group name
(i.e. that of the current user session running on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>). The
volume mounts (set to read-only on purpose so we don’t give the container the
opportunity to accidentally or deliberately corrupt them) supplement the
<code class="docutils literal notranslate"><span class="pre">--user</span></code> command so we can map user and group names to their appropriate
numerical <a class="reference internal" href="glossary.html#term-ID"><span class="xref std std-term">IDs</span></a> within the container. Why is this helpful? Well, if
you just <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code> a container with a volume mount in place (like in the
various examples found in <a class="reference internal" href="#ssec-single-container"><span class="std std-ref">Single Container with Docker</span></a>), and create a file
(e.g. <code class="docutils literal notranslate"><span class="pre">touch</span> <span class="pre">/work/myfile.txt</span></code>), you’ll notice the file is owned by the
<code class="docutils literal notranslate"><span class="pre">root</span></code> user (example below).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The use of <code class="docutils literal notranslate"><span class="pre">--user=&quot;$(id</span> <span class="pre">-u):$(id</span> <span class="pre">-g)&quot;</span></code> works in general, but it only
associates the user’s primary group, rather than the union of the primary
group and secondary groups (necessary if we want to do certain types of
complex operations like “rootless docker-in-docker”). Please see the
<a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> build pattern section later in this chapter for more details.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id86">
<div class="code-block-caption"><span class="caption-number">Listing 34 </span><span class="caption-text">Container launched with root credentials.</span><a class="headerlink" href="#id86" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Launch our Docker container.</span>
<span class="lineno"> 2 </span>owner@darkstar$&gt; $&gt; docker run -it --rm <span class="se">\</span>
<span class="lineno"> 3 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work&quot;</span>
<span class="lineno"> 4 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span>
<span class="lineno"> 5 </span>    ubuntu:focal
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="c1"># Create a file while in the container.</span>
<span class="lineno"> 8 </span>root@8111f7b149c7:/work# touch myfile.txt
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1"># Exit container, and verify file ownership.</span>
<span class="lineno">11 </span>root@8111f7b149c7:/work# <span class="nb">exit</span>
<span class="lineno">12 </span>owner@darkstar$&gt; ls -la myfile.txt
<span class="lineno">13 </span>-rw-r--r-- <span class="m">1</span> root <span class="m">0</span> Aug  <span class="m">1</span> <span class="m">12</span>:39 myfile.txt
</pre></div>
</div>
</div>
<p>This is no good! We now have a file owned by <code class="docutils literal notranslate"><span class="pre">root</span></code> in our <a class="reference internal" href="glossary.html#term-PWD"><span class="xref std std-term">PWD</span></a> that
we can’t delete. If we want to purge our build stage or just change branches in
<code class="docutils literal notranslate"><span class="pre">git</span></code>, we’re out of luck. We now either require our user account to have
<code class="docutils literal notranslate"><span class="pre">sudo</span></code> privileges (which is not always possible), or we need an administrator
to purge the file for us (which isn’t very helpful for a workflow we’re aiming
to automate significantly). If we use the <code class="docutils literal notranslate"><span class="pre">--user</span></code> and volume mounts in the
previous example, all new files created in our volume mount are owned by the
user that launched <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code> in the first place (allowing for files to be
cleaned up, deleted, etc.) at the user’s discretion. On to the next set of
options.</p>
<div class="literal-block-wrapper docutils container" id="id87">
<div class="code-block-caption"><span class="caption-number">Listing 35 </span><span class="caption-text">Example of launching a container with a host volume mount.</span><a class="headerlink" href="#id87" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span>docker run <span class="se">\</span>
<span class="lineno"> 2 </span>    ...
<span class="lineno"> 3 </span>    ...
<span class="lineno"> 4 </span>    ...
<span class="lineno"> 5 </span>    --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno"> 6 </span>    ...
<span class="lineno"> 7 </span>    ...
<span class="lineno"> 8 </span>    ...
<span class="lineno"> 9 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">10 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
</pre></div>
</div>
</div>
<p>This is just for allowing functionality like Docker-in-Docker to work. On to
the final set of “customizations”. The security implications of this method are
discussed earlier in this chapter, and the reader is encouraged to review it in
case they’ve skipped said section.</p>
<div class="literal-block-wrapper docutils container" id="id88">
<div class="code-block-caption"><span class="caption-number">Listing 36 </span><span class="caption-text">Example of launching a container with a host volume mount.</span><a class="headerlink" href="#id88" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span>docker run <span class="se">\</span>
<span class="lineno"> 2 </span>    ...
<span class="lineno"> 3 </span>    ...
<span class="lineno"> 4 </span>    ...
<span class="lineno"> 5 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f ~/.ssh<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>readlink -f ~/.ssh<span class="k">)</span><span class="s2">:ro&quot;</span> <span class="se">\</span>
<span class="lineno"> 6 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span><span class="k">)</span><span class="s2">:</span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno"> 7 </span>    -e <span class="nv">SSH_AUTH_SOCK</span><span class="o">=</span><span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno"> 8 </span>    ...
<span class="lineno"> 9 </span>    ...
<span class="lineno">10 </span>    ...
<span class="lineno">11 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">12 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
</pre></div>
</div>
</div>
<p>This last set of options should only be used in cases where you implicitly
trust the contents of the builder container (i.e. provided to you by a trusted
party and you’ve verified the contents via checksums or digital signatures).
The first volume mount grants read-only access to your <a class="reference internal" href="glossary.html#term-SSH"><span class="xref std std-term">SSH</span></a> key files
(public <strong>and</strong> private files, and whatever other keys you have present in
<code class="docutils literal notranslate"><span class="pre">~/.ssh</span></code>; I hope you’re using passphrases to protect these files). The second
volume mount provides access to the currently running <code class="docutils literal notranslate"><span class="pre">ssh-agent</span></code> instance
that is caching our credentials in the background (while the subsequent
environment variable export allows the container to know where to find the
socket/path associated with the agent).</p>
<p>When we combine these various settings, we can take an ordering builder
container (provided we trust it and can verify its contents), and give it
various capabilities (i.e. make use of our currently running session to
authenticate things like <code class="docutils literal notranslate"><span class="pre">git</span></code> and <code class="docutils literal notranslate"><span class="pre">ssh</span></code> commands, launch nested containers
via Docker-in-Docker, make sure build artifacts have the same ownership as the
user that invoked the container, etc.). Most importantly, all these settings
are ephemeral, are provided entirely by additional command-line arguments
supplied to <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>, and at no time have we taken credential files or
sensitive information and “baked it in” to a concrete Docker image.</p>
</div>
</div>
<div class="section" id="cluster-orchestration-with-kubernetes-k8s">
<h2>Cluster Orchestration with Kubernetes (K8S)<a class="headerlink" href="#cluster-orchestration-with-kubernetes-k8s" title="Permalink to this headline">¶</a></h2>
<p>This section extends the topics in the preceding sections by throwing in a
useful technology to the mix: <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a>. This is accomplished by using
container-centric build patterns, and introducing tools to create on-demand,
throwaway clusters, and deploying applications into them on-the-fly. This is
particularly useful for emulating complex build (i.e. <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a>) systems
that operate within a cluster, and we don’t want to have to provision a
dedicated centralized cluster for developers.</p>
<p>In fact, if individual developers have sufficient computing resources at their
disposal (i.e. powerful-enough laptops/workstations/etc.), this is quite
convenient, as individuals may test their code changes against a private,
throwaway cluster, rather than having to share a common cluster that others may
be using at the same time (requiring isolation between different deployments,
possibly reserving the cluster outright if potentially-destructive testing
needs to be done, etc.).</p>
<p>These topics will be revisited in future sections when we address topics
involving automated testing (<a class="reference internal" href="testing.html#sec-testing"><span class="std std-ref">Testing Strategies</span></a>). Finally, it is worth noting
that in this chapter so far, various scripts have accumulated in
<code class="docutils literal notranslate"><span class="pre">/home/owner/work</span></code> on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a> (i.e. Dockerfiles, Makefiles,
various build scripts) that were used in examples so far. From this point
forward, we’re going to purge the contents of this path and start with a fresh
slate (i.e. an empty/clean <code class="docutils literal notranslate"><span class="pre">/home/owner/work</span></code> path).</p>
<div class="section" id="kubernetes-in-docker-kind">
<h3>Kubernetes in Docker (KIND)<a class="headerlink" href="#kubernetes-in-docker-kind" title="Permalink to this headline">¶</a></h3>
<p>Perhaps the most extreme example of a cloud native build pattern, the use of
“Kubernetes in Docker” (<a class="reference internal" href="glossary.html#term-KIND"><span class="xref std std-term">KIND</span></a>) makes extensive use of containers, as
well as container orchestration in the form of <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> itself. In short, it
literally invokes a Docker container, and configures a <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> cluster
within it, which is amusing due to the fact that the cluster itself, which
handles “cluster orchestration”, which is effectively a grouping of various
types of containers (some to manage or support normal cluster operations, and
others which are just applications that we design ourselves). The net result is
a container, running a cluster, than runs more containers (“containers in a
cluster in a container”, <a class="reference internal" href="#kind-0"><span class="std std-numref">Fig. 7</span></a>).</p>
<div class="figure align-center" id="kind-0">
<img alt="../_images/kind_0.png" src="../_images/kind_0.png" />
<p class="caption"><span class="caption-number">Fig. 7 </span><span class="caption-text">Conceptual model of Kubernetes-in-Docker. Recall from earlier that nested
containers, including use cases like <a class="reference internal" href="glossary.html#term-KIND"><span class="xref std std-term">KIND</span></a>, are really “sibling
containers”.</span><a class="headerlink" href="#kind-0" title="Permalink to this image">¶</a></p>
</div>
<p>With respect to <a class="reference internal" href="#kind-0"><span class="std std-numref">Fig. 7</span></a>, we’re hiding some implementation details,
namely the critical components for a <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> installation (i.e. <code class="docutils literal notranslate"><span class="pre">etcd</span></code>,
<code class="docutils literal notranslate"><span class="pre">kube-apiserver</span></code>, <code class="docutils literal notranslate"><span class="pre">kube-scheduler</span></code>, and <code class="docutils literal notranslate"><span class="pre">controller-manager</span></code> for the
control plane; and <code class="docutils literal notranslate"><span class="pre">kubelet</span></code>, <code class="docutils literal notranslate"><span class="pre">kube-proxy</span></code>, and a container runtime such as
<code class="docutils literal notranslate"><span class="pre">docker</span></code> for the nodes/workers <span id="id33">[<a class="reference internal" href="references.html#id39" title="The Kubernetes Authors. Kubernetes Components. \url https://kubernetes.io/docs/concepts/overview/components/, accessed 2021-08-07.">27</a>]</span>). A detailed example of these
components can be seen in <a class="reference internal" href="#k8s-components"><span class="std std-numref">Fig. 8</span></a>. For the sake of simplicity,
the small purple boxes in <a class="reference internal" href="#kind-0"><span class="std std-numref">Fig. 7</span></a> more-or-less equate to the
architecture shown in <a class="reference internal" href="#k8s-components"><span class="std std-numref">Fig. 8</span></a>, which the small red boxes
represent “business applications” (i.e. programs that we write ourselves,
encapsulate in Docker containers, and deploy to a <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> cluster).</p>
<div class="figure align-center" id="k8s-components">
<img alt="../_images/kind_2.png" src="../_images/kind_2.png" />
<p class="caption"><span class="caption-number">Fig. 8 </span><span class="caption-text">Overview of core <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> components in KIND.
(C) 2021 the KIND Authors.
Used under the fair dealings clause under section 29 of the Copyright Act of
Canada, circa 2012; for the purposes of non-profit scientific research
and the promotion of scientific and educational advancement.</span><a class="headerlink" href="#k8s-components" title="Permalink to this image">¶</a></p>
</div>
<p>Before proceeding, we’re going to make this example just a bit more involved:
we’re going to throw more, believe it or not, Docker at the problem. For
starters, I’d like this example to be as portable as possible, and in order to
proceed, we’ll need some additional tools (namely <code class="docutils literal notranslate"><span class="pre">kubectl</span></code>, for
administering a <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> cluster), so I’d like to encapsulate the
<a class="reference internal" href="glossary.html#term-KIND"><span class="xref std std-term">KIND</span></a> container in a top-level “builder container”, which will “house”
the <a class="reference internal" href="glossary.html#term-KIND"><span class="xref std std-term">KIND</span></a> Docker container and its own child processes (“containers in a
cluster in a container in yet another container”).</p>
<p>While this might appear to border on the absurd, it’s a helpful way to make the
overall project easier to share with colleagues, and allows it to be a more
viable build pattern (i.e.  allowing local/developer build environments and
<a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> pipelines to differ as little as possible). The “builder
container” will also house some additional child containers for validating our
application (i.e. test suites), and the “KIND container” for actually running
the final result in a cluster. Our overall model will look something like
<a class="reference internal" href="#fig-kind-1"><span class="std std-numref">Fig. 9</span></a>. In the future (i.e.  <a class="reference internal" href="testing.html#sec-testing"><span class="std std-ref">Testing Strategies</span></a>) we can extend
this even further to include additional testing containers as children of the
“builder container” to do automated unit testing, among other tasks.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>At this time, the “app testing container” will be created, but not used.
This will be revisited in <a class="reference internal" href="testing.html#sec-testing"><span class="std std-ref">Testing Strategies</span></a>. For now, any (basic) testing
we do will be processes that reside in the “builder container” communicating
with the “business app” running within the KIND container.</p>
</div>
<div class="figure align-center" id="fig-kind-1">
<img alt="../_images/kind_1.png" src="../_images/kind_1.png" />
<p class="caption"><span class="caption-number">Fig. 9 </span><span class="caption-text">Conceptual model of a Docker-in-Docker configuration that encapsulates a
build system, and KIND-based system for temporary/ephemeral cluster
generation.</span><a class="headerlink" href="#fig-kind-1" title="Permalink to this image">¶</a></p>
</div>
<p>Now, let’s get started. First, we need to create the image for the builder
container, and the various containers it encapsulates. To maximize the
portability of this overall process, we’re going to “bootstrap a builder
image”. This is effectively building a Docker image (that includes, at a
minimum, a copy of Docker itself along with some build tools) which we build
from either a bare metal or <a class="reference internal" href="glossary.html#term-VM"><span class="xref std std-term">VM</span></a>-based host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>. When the image is
built, it is now capable of building new releases of itself from the same build
scripts we originally used on the original host that built it in the first
place. Why go to such hassle?</p>
<p>Well, we can create a self-sustaining build environment that’s completely
containerized (after the initial bootstrapping phase), and re-use this builder
image to produce the other various containers in our final product (i.e. it can
build the “app tester container”, etc.) in addition to new versions/releases of
the builder image itself. In the end, <strong>all</strong> of our infrastructure, including
the build-time and runtime images, are completely encapsulated in
containerization technology, increasing overall scalability and re-usability
significantly. Now, let’s get the scripts in order for the initial “bare metal
build” of our “pre-bootstrap builder image”.</p>
<div class="literal-block-wrapper docutils container" id="id89">
<div class="code-block-caption"><span class="caption-number">Listing 37 </span><span class="caption-text">/code/Dockerfile.bootstrap_builder.pre</span><a class="headerlink" href="#id89" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c"># System packages.</span>
<span class="lineno"> 4 </span><span class="k">RUN</span> apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno"> 5 </span>    apt install -y <span class="se">\</span>
<span class="lineno"> 6 </span>        binutils <span class="se">\</span>
<span class="lineno"> 7 </span>        build-essential <span class="se">\</span>
<span class="lineno"> 8 </span>        coreutils <span class="se">\</span>
<span class="lineno"> 9 </span>        curl <span class="se">\</span>
<span class="lineno">10 </span>        docker.io <span class="se">\</span>
<span class="lineno">11 </span>        gcc <span class="se">\</span>
<span class="lineno">12 </span>        git <span class="se">\</span>
<span class="lineno">13 </span>        iproute2 <span class="se">\</span>
<span class="lineno">14 </span>        iputils-ping <span class="se">\</span>
<span class="lineno">15 </span>        jq <span class="se">\</span>
<span class="lineno">16 </span>        lsb-release <span class="se">\</span>
<span class="lineno">17 </span>        make <span class="se">\</span>
<span class="lineno">18 </span>        net-tools<span class="se">\</span>
<span class="lineno">19 </span>        python3 <span class="se">\</span>
<span class="lineno">20 </span>        python3-dev <span class="se">\</span>
<span class="lineno">21 </span>        python3-pip <span class="se">\</span>
<span class="lineno">22 </span>        uuid-runtime <span class="se">\</span>
<span class="lineno">23 </span>        vim <span class="se">\</span>
<span class="lineno">24 </span>        wget <span class="se">\</span>
<span class="lineno">25 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">26 </span>    apt clean -y
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id90">
<div class="code-block-caption"><span class="caption-number">Listing 38 </span><span class="caption-text">/code/Dockerfile.bootstrap_builder.pre.dockerignore</span><a class="headerlink" href="#id90" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="c"># Ignore everything by default. We can manually add individual files as we</span>
<span class="lineno">2 </span><span class="c"># need them to this permit-list.</span>
<span class="lineno">3 </span>*
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id91">
<div class="code-block-caption"><span class="caption-number">Listing 39 </span><span class="caption-text">/code/Makefile.bootstrap_builder.pre</span><a class="headerlink" href="#id91" title="Permalink to this code">¶</a></div>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c"># Defaults and global settings.</span>
<span class="lineno"> 2 </span><span class="nf">.DEFAULT_GOAL</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno"> 3 </span><span class="nv">BUILDER_TAG</span><span class="o">=</span>docker_builder:0.0.0
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="c"># Default goal.</span>
<span class="lineno"> 6 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno"> 7 </span><span class="nf">all</span><span class="o">:</span> <span class="n">docker_builder</span>
<span class="lineno"> 8 </span>	@echo <span class="s2">&quot;Done build.&quot;</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c"># Build Docker image.</span>
<span class="lineno">11 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">docker_builder</span>
<span class="lineno">12 </span><span class="nf">docker_builder</span><span class="o">:</span> <span class="n">Dockerfile</span>.<span class="n">bootstrap_builder</span>.<span class="n">pre</span> <span class="n">Dockerfile</span>.<span class="n">bootstrap_builder</span>.<span class="n">pre</span>.<span class="n">dockerignore</span>
<span class="lineno">13 </span>	<span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno">14 </span>			-t <span class="s2">&quot;</span><span class="k">$(</span>BUILDER_TAG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">15 </span>			--target baseline <span class="se">\</span>
<span class="lineno">16 </span>			-f Dockerfile.bootstrap_builder.pre <span class="se">\</span>
<span class="lineno">17 </span>			.
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="c"># Launch Docker container.</span>
<span class="lineno">20 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">run_builder</span>
<span class="lineno">21 </span><span class="nf">run_builder</span><span class="o">:</span>
<span class="lineno">22 </span>	docker run <span class="se">\</span>
<span class="lineno">23 </span>		--rm -it <span class="se">\</span>
<span class="lineno">24 </span>		--volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>shell readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">25 </span>		--workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">26 </span>		--volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">27 </span>		<span class="k">$(</span>BUILDER_TAG<span class="k">)</span>
</pre></div>
</div>
</div>
<p>Now let’s trigger the build of our “pre-bootstrap builder image”.</p>
<div class="literal-block-wrapper docutils container" id="id92">
<div class="code-block-caption"><span class="caption-number">Listing 40 </span><span class="caption-text">Creating the pre-bootstrap version of our baseline builder image.</span><a class="headerlink" href="#id92" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Build the image.</span>
<span class="lineno"> 2 </span>owner@darkstar$&gt; make -f Makefile.bootstrap_builder.pre
<span class="lineno"> 3 </span><span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno"> 4 </span>                -t <span class="s2">&quot;docker_builder:0.0.0&quot;</span> <span class="se">\</span>
<span class="lineno"> 5 </span>                --target baseline <span class="se">\</span>
<span class="lineno"> 6 </span>                -f Dockerfile.bootstrap_builder.pre <span class="se">\</span>
<span class="lineno"> 7 </span>                .
<span class="lineno"> 8 </span><span class="o">[</span>+<span class="o">]</span> Building <span class="m">40</span>.6s <span class="o">(</span><span class="m">6</span>/6<span class="o">)</span> <span class="nv">FINISHED</span>
<span class="lineno"> 9 </span> <span class="o">=</span>&gt; <span class="o">=</span>&gt; naming to docker.io/library/docker_builder:0.0.0                                                                                                                                               <span class="m">0</span>.0s
<span class="lineno">10 </span>Done build.
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="c1"># Let&#39;s confirm it&#39;s properly tagged.</span>
<span class="lineno">13 </span>owner@darkstar$&gt; docker image ls <span class="p">|</span> grep docker_builder.*<span class="s1">&#39;0.0.0&#39;</span>
<span class="lineno">14 </span>docker_builder                    <span class="m">0</span>.0.0     1c407d6c0b93   <span class="m">14</span> minutes ago 860MB
<span class="lineno">15 </span>
<span class="lineno">16 </span><span class="c1"># Great.</span>
</pre></div>
</div>
</div>
<p>Now we have a <code class="docutils literal notranslate"><span class="pre">0.0.0</span></code> release of our builder image. Let’s duplicate the
various build scripts (so we can compare the before-and-after), along with the
top-level <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code> we use to bootstrap the whole process. Note how the
version of the builder image in <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code> always trails/follows the version in
in Makefile.builder (i.e. <code class="docutils literal notranslate"><span class="pre">0.0.0</span></code> in <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code> versus <code class="docutils literal notranslate"><span class="pre">0.0.1</span></code> in
<code class="docutils literal notranslate"><span class="pre">Makefile.builder</span></code>; we’re using an old version of the builder image to create
a newer one, and we’ll need to periodically increment <strong>both</strong> of these
values).</p>
<div class="literal-block-wrapper docutils container" id="id93">
<div class="code-block-caption"><span class="caption-number">Listing 41 </span><span class="caption-text">/code/Dockerfile.builder</span><a class="headerlink" href="#id93" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c"># System packages.</span>
<span class="lineno"> 4 </span><span class="k">RUN</span> apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno"> 5 </span>    apt install -y <span class="se">\</span>
<span class="lineno"> 6 </span>        binutils <span class="se">\</span>
<span class="lineno"> 7 </span>        build-essential <span class="se">\</span>
<span class="lineno"> 8 </span>        coreutils <span class="se">\</span>
<span class="lineno"> 9 </span>        curl <span class="se">\</span>
<span class="lineno">10 </span>        docker.io <span class="se">\</span>
<span class="lineno">11 </span>        gcc <span class="se">\</span>
<span class="lineno">12 </span>        git <span class="se">\</span>
<span class="lineno">13 </span>        iproute2 <span class="se">\</span>
<span class="lineno">14 </span>        iputils-ping <span class="se">\</span>
<span class="lineno">15 </span>        jq <span class="se">\</span>
<span class="lineno">16 </span>        lsb-release <span class="se">\</span>
<span class="lineno">17 </span>        make <span class="se">\</span>
<span class="lineno">18 </span>        net-tools<span class="se">\</span>
<span class="lineno">19 </span>        python3 <span class="se">\</span>
<span class="lineno">20 </span>        python3-dev <span class="se">\</span>
<span class="lineno">21 </span>        python3-pip <span class="se">\</span>
<span class="lineno">22 </span>        uuid-runtime <span class="se">\</span>
<span class="lineno">23 </span>        vim <span class="se">\</span>
<span class="lineno">24 </span>        wget <span class="se">\</span>
<span class="lineno">25 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">26 </span>    apt clean -y
<span class="lineno">27 </span>
<span class="lineno">28 </span><span class="c"># kubectl - for administering K8S clusters.</span>
<span class="lineno">29 </span><span class="k">ADD</span> kubectl /usr/local/bin/
<span class="lineno">30 </span>
<span class="lineno">31 </span><span class="c"># helm - for K8S package management.</span>
<span class="lineno">32 </span><span class="k">ADD</span> helm /usr/local/bin/
<span class="lineno">33 </span>
<span class="lineno">34 </span><span class="c"># kind - for spinning-up throwaway/test K8S clusters on-demand.</span>
<span class="lineno">35 </span><span class="k">ADD</span> kind /usr/local/bin/
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id94">
<div class="code-block-caption"><span class="caption-number">Listing 42 </span><span class="caption-text">/code/Dockerfile.builder.dockerignore</span><a class="headerlink" href="#id94" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="c"># Ignore everything by default. We can manually add individual files as we</span>
<span class="lineno">2 </span><span class="c"># need them to this permit-list.</span>
<span class="lineno">3 </span>*
<span class="lineno">4 </span>
<span class="lineno">5 </span><span class="c"># Build artifacts we want in the final image.</span>
<span class="lineno">6 </span>!kubectl
<span class="lineno">7 </span>!helm
<span class="lineno">8 </span>!kind
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id95">
<div class="code-block-caption"><span class="caption-number">Listing 43 </span><span class="caption-text">/code/Makefile.builder</span><a class="headerlink" href="#id95" title="Permalink to this code">¶</a></div>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="lineno">  1 </span><span class="c"># Default shell (need bash instead of sh for some inline scripts).</span>
<span class="lineno">  2 </span><span class="nv">SHELL</span> <span class="o">:=</span> /bin/bash
<span class="lineno">  3 </span>
<span class="lineno">  4 </span><span class="c"># Defaults and global settings.</span>
<span class="lineno">  5 </span><span class="nf">.DEFAULT_GOAL</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno">  6 </span><span class="nv">BUILDER_TAG</span><span class="o">=</span>docker_builder:0.0.1
<span class="lineno">  7 </span>
<span class="lineno">  8 </span><span class="c"># Default goal.</span>
<span class="lineno">  9 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno"> 10 </span><span class="nf">all</span><span class="o">:</span> <span class="n">docker_builder</span>
<span class="lineno"> 11 </span>	@echo <span class="s2">&quot;Done build.&quot;</span>
<span class="lineno"> 12 </span>
<span class="lineno"> 13 </span><span class="c"># Build Docker image.</span>
<span class="lineno"> 14 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">docker_builder</span>
<span class="lineno"> 15 </span><span class="nf">docker_builder</span><span class="o">:</span> <span class="n">Dockerfile</span>.<span class="n">builder</span> <span class="n">Dockerfile</span>.<span class="n">builder</span>.<span class="n">dockerignore</span> <span class="n">kubectl</span> <span class="n">kind</span> <span class="n">helm</span>
<span class="lineno"> 16 </span>	<span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno"> 17 </span>			-t <span class="s2">&quot;</span><span class="k">$(</span>BUILDER_TAG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno"> 18 </span>			--target baseline <span class="se">\</span>
<span class="lineno"> 19 </span>			-f Dockerfile.builder <span class="se">\</span>
<span class="lineno"> 20 </span>			.
<span class="lineno"> 21 </span>
<span class="lineno"> 22 </span><span class="c"># Download and verify kubectl binary.</span>
<span class="lineno"> 23 </span><span class="nf">kubectl</span><span class="o">:</span>
<span class="lineno"> 24 </span><span class="c">	# Purge old copy if it exists from previous (failed) run.</span>
<span class="lineno"> 25 </span>	rm -f ./kubectl
<span class="lineno"> 26 </span>
<span class="lineno"> 27 </span><span class="c">	# Pull file.</span>
<span class="lineno"> 28 </span>	curl -o <span class="k">$(</span>@<span class="k">)</span> -L https://dl.k8s.io/release/v1.21.0/bin/linux/amd64/kubectl
<span class="lineno"> 29 </span>
<span class="lineno"> 30 </span><span class="c">	# Validate checksum. Terminate build if it fails.</span>
<span class="lineno"> 31 </span>	<span class="nv">EXPECTED_CHECKSUM</span><span class="o">=</span><span class="s2">&quot;9f74f2fa7ee32ad07e17211725992248470310ca1988214518806b39b1dad9f0&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="lineno"> 32 </span>	<span class="nv">CALCULATED_CHECKSUM</span><span class="o">=</span><span class="nv">$$</span><span class="o">(</span>sha256sum <span class="k">$(</span>@<span class="k">)</span> <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f1<span class="o">)</span><span class="p">;</span> <span class="se">\</span>
<span class="lineno"> 33 </span>	<span class="nb">echo</span> <span class="s2">&quot;Sums: </span><span class="nv">$$</span><span class="s2">{EXPECTED_CHECKSUM} --&gt; </span><span class="nv">$$</span><span class="s2">{CALCULATED_CHECKSUM}&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="lineno"> 34 </span><span class="cp">	if [[ $${EXPECTED_CHECKSUM} == $${CALCULATED_CHECKSUM} ]]; then  \</span>
<span class="lineno"> 35 </span><span class="cp">	  echo &quot;Checksum matches.&quot;; \</span>
<span class="lineno"> 36 </span><span class="cp">	  true; \</span>
<span class="lineno"> 37 </span><span class="cp">	else \</span>
<span class="lineno"> 38 </span><span class="cp">	  echo &quot;Checksum failure.&quot;; \</span>
<span class="lineno"> 39 </span><span class="cp">	  false; \</span>
<span class="lineno"> 40 </span><span class="cp">	fi ;</span>
<span class="lineno"> 41 </span>	chmod +x <span class="k">$(</span>@<span class="k">)</span>
<span class="lineno"> 42 </span>
<span class="lineno"> 43 </span><span class="c"># Download and verify kind binary.</span>
<span class="lineno"> 44 </span><span class="nf">kind</span><span class="o">:</span>
<span class="lineno"> 45 </span><span class="c">	# Purge old copy if it exists from previous (failed) run.</span>
<span class="lineno"> 46 </span>	rm -f ./kind
<span class="lineno"> 47 </span>
<span class="lineno"> 48 </span><span class="c">	# Pull file.</span>
<span class="lineno"> 49 </span>	curl -o <span class="k">$(</span>@<span class="k">)</span> -L https://github.com/kubernetes-sigs/kind/releases/download/v0.11.1/kind-linux-amd64
<span class="lineno"> 50 </span>
<span class="lineno"> 51 </span><span class="c">	# Validate checksum. Terminate build if it fails.</span>
<span class="lineno"> 52 </span>	<span class="nv">EXPECTED_CHECKSUM</span><span class="o">=</span><span class="s2">&quot;949f81b3c30ca03a3d4effdecda04f100fa3edc07a28b19400f72ede7c5f0491&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="lineno"> 53 </span>	<span class="nv">CALCULATED_CHECKSUM</span><span class="o">=</span><span class="nv">$$</span><span class="o">(</span>sha256sum <span class="k">$(</span>@<span class="k">)</span> <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f1<span class="o">)</span><span class="p">;</span> <span class="se">\</span>
<span class="lineno"> 54 </span>	<span class="nb">echo</span> <span class="s2">&quot;Sums: </span><span class="nv">$$</span><span class="s2">{EXPECTED_CHECKSUM} --&gt; </span><span class="nv">$$</span><span class="s2">{CALCULATED_CHECKSUM}&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="lineno"> 55 </span><span class="cp">	if [[ $${EXPECTED_CHECKSUM} == $${CALCULATED_CHECKSUM} ]]; then  \</span>
<span class="lineno"> 56 </span><span class="cp">	  echo &quot;Checksum matches.&quot;; \</span>
<span class="lineno"> 57 </span><span class="cp">	  true; \</span>
<span class="lineno"> 58 </span><span class="cp">	else \</span>
<span class="lineno"> 59 </span><span class="cp">	  echo &quot;Checksum failure.&quot;; \</span>
<span class="lineno"> 60 </span><span class="cp">	  false; \</span>
<span class="lineno"> 61 </span><span class="cp">	fi ;</span>
<span class="lineno"> 62 </span>	chmod +x <span class="k">$(</span>@<span class="k">)</span>
<span class="lineno"> 63 </span>
<span class="lineno"> 64 </span><span class="c"># Download and verify helm binary.</span>
<span class="lineno"> 65 </span><span class="nf">helm</span><span class="o">:</span>
<span class="lineno"> 66 </span><span class="c">	# Purge old copy if it exists from previous (failed) run.</span>
<span class="lineno"> 67 </span>	rm -f ./helm
<span class="lineno"> 68 </span>	rm -f ./helm.tar.gz
<span class="lineno"> 69 </span>	rm -rf <span class="s2">&quot;./linux-amd64&quot;</span>
<span class="lineno"> 70 </span>
<span class="lineno"> 71 </span><span class="c">	# Pull file.</span>
<span class="lineno"> 72 </span>	curl -o helm.tar.gz -L https://get.helm.sh/helm-v3.6.3-linux-amd64.tar.gz &gt; helm.tar.gz
<span class="lineno"> 73 </span>
<span class="lineno"> 74 </span><span class="c">	# Validate checksum. Terminate build if it fails.</span>
<span class="lineno"> 75 </span>	<span class="nv">EXPECTED_CHECKSUM</span><span class="o">=</span><span class="s2">&quot;07c100849925623dc1913209cd1a30f0a9b80a5b4d6ff2153c609d11b043e262&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="lineno"> 76 </span>	<span class="nv">CALCULATED_CHECKSUM</span><span class="o">=</span><span class="nv">$$</span><span class="o">(</span>sha256sum helm.tar.gz  <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f1<span class="o">)</span><span class="p">;</span> <span class="se">\</span>
<span class="lineno"> 77 </span>	<span class="nb">echo</span> <span class="s2">&quot;Sums: </span><span class="nv">$$</span><span class="s2">{EXPECTED_CHECKSUM} --&gt; </span><span class="nv">$$</span><span class="s2">{CALCULATED_CHECKSUM}&quot;</span><span class="p">;</span> <span class="se">\</span>
<span class="lineno"> 78 </span><span class="cp">	if [[ $${EXPECTED_CHECKSUM} == $${CALCULATED_CHECKSUM} ]]; then  \</span>
<span class="lineno"> 79 </span><span class="cp">	  echo &quot;Checksum matches.&quot;; \</span>
<span class="lineno"> 80 </span><span class="cp">	  true; \</span>
<span class="lineno"> 81 </span><span class="cp">	else \</span>
<span class="lineno"> 82 </span><span class="cp">	  echo &quot;Checksum failure.&quot;; \</span>
<span class="lineno"> 83 </span><span class="cp">	  false; \</span>
<span class="lineno"> 84 </span><span class="cp">	fi ;</span>
<span class="lineno"> 85 </span>
<span class="lineno"> 86 </span><span class="c">	# If the job hasn&#39;t failed at this point, checksum is good. Extract the</span>
<span class="lineno"> 87 </span><span class="c">	# binary and delete the original archive.</span>
<span class="lineno"> 88 </span>	tar -zxvf helm.tar.gz
<span class="lineno"> 89 </span>	mv ./linux-amd64/helm .
<span class="lineno"> 90 </span>	chmod +x <span class="k">$(</span>@<span class="k">)</span>
<span class="lineno"> 91 </span>	rm -f ./helm.tar.gz
<span class="lineno"> 92 </span>	rm -rf <span class="s2">&quot;./linux-amd64&quot;</span>
<span class="lineno"> 93 </span>
<span class="lineno"> 94 </span><span class="c"># Launch Docker container.</span>
<span class="lineno"> 95 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">run_builder</span>
<span class="lineno"> 96 </span><span class="nf">run_builder</span><span class="o">:</span>
<span class="lineno"> 97 </span>	docker run <span class="se">\</span>
<span class="lineno"> 98 </span>		--rm -it <span class="se">\</span>
<span class="lineno"> 99 </span>		--volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>shell readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">100 </span>		--workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">101 </span>		--volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">102 </span>		<span class="k">$(</span>BUILDER_TAG<span class="k">)</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id96">
<div class="code-block-caption"><span class="caption-number">Listing 44 </span><span class="caption-text">/code/iax.sh</span><a class="headerlink" href="#id96" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/bin/bash</span>
<span class="lineno"> 2 </span><span class="c1">################################################################################</span>
<span class="lineno"> 3 </span><span class="c1"># @brief:       Docker-bootstrap script for building projects via a Docker</span>
<span class="lineno"> 4 </span><span class="c1">#               image.</span>
<span class="lineno"> 5 </span><span class="c1"># @author:      Matthew Giassa.</span>
<span class="lineno"> 6 </span><span class="c1"># @e-mail:      matthew@giassa.net</span>
<span class="lineno"> 7 </span><span class="c1"># @copyright:   Matthew Giassa (IAXES) 2017.</span>
<span class="lineno"> 8 </span><span class="c1">################################################################################</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1"># Docker runtime image to use for building artifacts.</span>
<span class="lineno">11 </span><span class="nv">DOCKER_IMG</span><span class="o">=</span><span class="s2">&quot;docker_builder:0.0.0&quot;</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="c1"># Need to dynamically create a set of &quot;--group-add&quot; statements while iteration</span>
<span class="lineno">14 </span><span class="c1"># across all groups for which we are a member, otherwise a simple</span>
<span class="lineno">15 </span><span class="c1"># &quot;--user=$(id -u):$(id -g)&quot; argument to &quot;docker run&quot; will only capture our</span>
<span class="lineno">16 </span><span class="c1"># primary group ID, and overlook our secondary group IDs (which means we won&#39;t</span>
<span class="lineno">17 </span><span class="c1"># be a member of the &quot;docker&quot; group when executing nested containers as a</span>
<span class="lineno">18 </span><span class="c1"># rootless user, causing headaches).</span>
<span class="lineno">19 </span><span class="nv">MY_GROUPS</span><span class="o">=(</span><span class="s2">&quot;</span><span class="k">$(</span>groups<span class="k">)</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="lineno">20 </span><span class="nv">MY_GROUPS_STR</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="lineno">21 </span><span class="k">for</span> grp in <span class="si">${</span><span class="nv">MY_GROUPS</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
<span class="lineno">22 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">grp</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">23 </span>        <span class="k">continue</span>
<span class="lineno">24 </span>    <span class="k">else</span>
<span class="lineno">25 </span>        <span class="c1"># Need to use GID, not group name.</span>
<span class="lineno">26 </span>        <span class="nv">gid</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>getent group <span class="si">${</span><span class="nv">grp</span><span class="si">}</span><span class="k">)</span> <span class="p">|</span> awk -F <span class="s1">&#39;:&#39;</span> <span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno">27 </span>        <span class="nv">MY_GROUPS_STR</span><span class="o">+=</span><span class="s2">&quot;--group-add </span><span class="si">${</span><span class="nv">gid</span><span class="si">}</span><span class="s2"> &quot;</span>
<span class="lineno">28 </span>    <span class="k">fi</span>
<span class="lineno">29 </span><span class="k">done</span>
<span class="lineno">30 </span>
<span class="lineno">31 </span><span class="c1"># Debug logging.</span>
<span class="lineno">32 </span><span class="c1"># echo &quot;My groups: ${MY_GROUPS[@]}&quot;     &gt;&amp;2</span>
<span class="lineno">33 </span><span class="c1"># echo &quot;Group string: ${MY_GROUPS_STR}&quot; &gt;&amp;2</span>
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="c1"># Launch docker container.</span>
<span class="lineno">36 </span><span class="c1"># * Setup PWD on host to mount to &quot;/work&quot; in the guest/container.</span>
<span class="lineno">37 </span><span class="c1"># * Forward access to SSH agent and host credentials (so container uses same</span>
<span class="lineno">38 </span><span class="c1">#   user/group permissions as current user that launches the script).</span>
<span class="lineno">39 </span><span class="c1"># * Make DIND possible (i.e. expose host Docker Unix domain socket to</span>
<span class="lineno">40 </span><span class="c1">#   guest/container).</span>
<span class="lineno">41 </span><span class="c1"># * Make the home directory be &quot;/work&quot; so that it&#39;s always writeable (allows us</span>
<span class="lineno">42 </span><span class="c1">#   to better handle rootless DIND and KIND).</span>
<span class="lineno">43 </span><span class="c1"># * Use host networking (non-ideal, but necessary for top-level containers to</span>
<span class="lineno">44 </span><span class="c1">#   access certain services like KIND-exposed kubeadm ports redirecting to port</span>
<span class="lineno">45 </span><span class="c1">#   6443 inside a pod without requiring a bridge being setup in advance).</span>
<span class="lineno">46 </span>docker run <span class="se">\</span>
<span class="lineno">47 </span>    --rm -it <span class="se">\</span>
<span class="lineno">48 </span>    --user<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>id -u<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>id -g<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">49 </span>    <span class="si">${</span><span class="nv">MY_GROUPS_STR</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">50 </span>    --volume<span class="o">=</span><span class="s2">&quot;/etc/passwd:/etc/passwd:ro&quot;</span> <span class="se">\</span>
<span class="lineno">51 </span>    --volume<span class="o">=</span><span class="s2">&quot;/etc/group:/etc/group:ro&quot;</span> <span class="se">\</span>
<span class="lineno">52 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">53 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">54 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f ~/.ssh<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>readlink -f ~/.ssh<span class="k">)</span><span class="s2">:ro&quot;</span> <span class="se">\</span>
<span class="lineno">55 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span><span class="k">)</span><span class="s2">:</span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">56 </span>    -e <span class="nv">SSH_AUTH_SOCK</span><span class="o">=</span><span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">57 </span>    --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">58 </span>    -e <span class="nv">HOME</span><span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">59 </span>    --network<span class="o">=</span>host <span class="se">\</span>
<span class="lineno">60 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">61 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id97">
<div class="code-block-caption"><span class="caption-number">Listing 45 </span><span class="caption-text">Building our “post-bootstrap” builder image, with an older version of itself.</span><a class="headerlink" href="#id97" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Start the build.</span>
<span class="lineno"> 2 </span>owner@darkstar$&gt; ./iax.sh make -f Makefile.builder
<span class="lineno"> 3 </span><span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno"> 4 </span>                -t <span class="s2">&quot;docker_builder:0.0.1&quot;</span> <span class="se">\</span>
<span class="lineno"> 5 </span>                --target baseline <span class="se">\</span>
<span class="lineno"> 6 </span>                -f Dockerfile.builder <span class="se">\</span>
<span class="lineno"> 7 </span>                .
<span class="lineno"> 8 </span><span class="o">[</span>+<span class="o">]</span> Building <span class="m">0</span>.0s <span class="o">(</span><span class="m">6</span>/6<span class="o">)</span> FINISHED
<span class="lineno"> 9 </span>...
<span class="lineno">10 </span>...
<span class="lineno">11 </span>...
<span class="lineno">12 </span>Done build.
<span class="lineno">13 </span>
<span class="lineno">14 </span><span class="c1"># Let&#39;s verify that it built.</span>
<span class="lineno">15 </span>owner@darkstar$&gt; docker image ls <span class="p">|</span> grep -i docker_builder
<span class="lineno">16 </span>docker_builder                    <span class="m">0</span>.0.0     8dc0244d19fa   About an hour ago   862MB
<span class="lineno">17 </span>docker_builder                    <span class="m">0</span>.0.1     1c407d6c0b93   <span class="m">2</span> hours ago         860MB
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="c1"># Excellent: we still have our original &quot;0.0.0&quot; image we built via &quot;bare</span>
<span class="lineno">20 </span><span class="c1"># metal building&quot;, and the new &quot;0.0.1&quot; image. From this point forward, we can</span>
<span class="lineno">21 </span><span class="c1"># produce new releases by modifying our &quot;Dockerfile.builder&quot; as needed, and</span>
<span class="lineno">22 </span><span class="c1"># then just incrementing the versions in &quot;iax.sh&quot; and &quot;Makefile.builder&quot;.</span>
</pre></div>
</div>
</div>
<p>Bravo! We have just bootstrapped a builder image that can create new
releases/versions of itself going forward. If anyone else wants to contribute
to this builder image, the only requirement is that they have Docker on their
local/developer machine, rather than requiring extra tools on their machine
(in the case of the initial “bare metal build” steps). Now, to build the actual
“business app” we’ll deploy into our <a class="reference internal" href="glossary.html#term-KIND"><span class="xref std std-term">KIND</span></a> cluster). First, the
<code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>, <code class="docutils literal notranslate"><span class="pre">dockerignore</span></code> file, and <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, along with a slightly
modified version of <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code> that uses the latest builder image release,
<code class="docutils literal notranslate"><span class="pre">0.0.1</span></code> (normally I’d just bump the tag version in <code class="docutils literal notranslate"><span class="pre">iax.sh</span></code>, but I’m
deliberately maintaining different copies of the files so they can be compared
manually, and provided verbatim at a later time as examples for the reader).</p>
<div class="literal-block-wrapper docutils container" id="id98">
<div class="code-block-caption"><span class="caption-number">Listing 46 </span><span class="caption-text">/code/Dockerfile.app</span><a class="headerlink" href="#id98" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c"># System packages.</span>
<span class="lineno"> 4 </span><span class="k">RUN</span> apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno"> 5 </span>    apt install -y <span class="se">\</span>
<span class="lineno"> 6 </span>        python3 <span class="se">\</span>
<span class="lineno"> 7 </span>        python3-pip <span class="se">\</span>
<span class="lineno"> 8 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno"> 9 </span>    apt clean -y
<span class="lineno">10 </span>
<span class="lineno">11 </span><span class="c"># Main app.</span>
<span class="lineno">12 </span><span class="k">ADD</span> entrypoint.sh /
<span class="lineno">13 </span>
<span class="lineno">14 </span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/entrypoint.sh&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id99">
<div class="code-block-caption"><span class="caption-number">Listing 47 </span><span class="caption-text">/code/Dockerfile.app.dockerignore</span><a class="headerlink" href="#id99" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="c"># Ignore everything by default. We can manually add individual files as we</span>
<span class="lineno">2 </span><span class="c"># need them to this permit-list.</span>
<span class="lineno">3 </span>*
<span class="lineno">4 </span>
<span class="lineno">5 </span>!entrypoint.sh
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id100">
<div class="code-block-caption"><span class="caption-number">Listing 48 </span><span class="caption-text">/code/Makefile.app</span><a class="headerlink" href="#id100" title="Permalink to this code">¶</a></div>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="lineno">  1 </span><span class="c">#------------------------------------------------------------------------------#</span>
<span class="lineno">  2 </span><span class="c"># Defaults and global settings.</span>
<span class="lineno">  3 </span><span class="nf">.DEFAULT_GOAL</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno">  4 </span><span class="nv">APP_TAG</span> <span class="o">=</span> docker_app:0.0.0
<span class="lineno">  5 </span>
<span class="lineno">  6 </span><span class="c"># Version of KIND container to use.</span>
<span class="lineno">  7 </span><span class="nv">KIND_IMAGE</span> <span class="o">=</span> kindest/node:v1.21.1@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6
<span class="lineno">  8 </span>
<span class="lineno">  9 </span><span class="c"># Path to KIND config file.</span>
<span class="lineno"> 10 </span><span class="nv">KIND_CONFIG</span> <span class="o">=</span> config.yaml
<span class="lineno"> 11 </span>
<span class="lineno"> 12 </span><span class="c"># How long we&#39;ll wait for the cluster to be ready before aborting (seconds).</span>
<span class="lineno"> 13 </span><span class="nv">KIND_TIMEOUT</span> <span class="o">=</span> 60s
<span class="lineno"> 14 </span>
<span class="lineno"> 15 </span><span class="c"># Name of our cluster. Make this pseudo-random, or it&#39;s possible to (if we run</span>
<span class="lineno"> 16 </span><span class="c"># multiple instances of this script concurrently) have two clusters with the</span>
<span class="lineno"> 17 </span><span class="c"># same name, resulting in name collisions, both clusters breaking, and a lot of</span>
<span class="lineno"> 18 </span><span class="c"># manual cleanup (and possibly restarting the Docker daemon).</span>
<span class="lineno"> 19 </span><span class="c"># MUST match regex: `^[a-z0-9.-]+$`</span>
<span class="lineno"> 20 </span><span class="nv">CLUSTER_NAME</span> <span class="o">:=</span> docker-app-<span class="k">$(</span>shell uuidgen -r<span class="k">)</span>
<span class="lineno"> 21 </span><span class="c">#------------------------------------------------------------------------------#</span>
<span class="lineno"> 22 </span>
<span class="lineno"> 23 </span><span class="c">#------------------------------------------------------------------------------#</span>
<span class="lineno"> 24 </span><span class="c"># Goals/recipes.</span>
<span class="lineno"> 25 </span><span class="c">#------------------------------------------------------------------------------#</span>
<span class="lineno"> 26 </span><span class="c"># Default goal.</span>
<span class="lineno"> 27 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span>
<span class="lineno"> 28 </span><span class="nf">all</span><span class="o">:</span> <span class="n">test_app_in_cluster</span>
<span class="lineno"> 29 </span>	@echo <span class="s2">&quot;Done build.&quot;</span>
<span class="lineno"> 30 </span>
<span class="lineno"> 31 </span><span class="c"># Build Docker image.</span>
<span class="lineno"> 32 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">docker_app</span>
<span class="lineno"> 33 </span><span class="nf">docker_app</span><span class="o">:</span> <span class="n">docker</span>-<span class="n">app</span>.<span class="n">tar</span>
<span class="lineno"> 34 </span><span class="nf">docker-app.tar</span><span class="o">:</span> <span class="n">Dockerfile</span>.<span class="n">app</span> <span class="n">Dockerfile</span>.<span class="n">app</span>.<span class="n">dockerignore</span>
<span class="lineno"> 35 </span><span class="c">	# Build.</span>
<span class="lineno"> 36 </span>	<span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build <span class="se">\</span>
<span class="lineno"> 37 </span>			-t <span class="s2">&quot;</span><span class="k">$(</span>APP_TAG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno"> 38 </span>			--target baseline <span class="se">\</span>
<span class="lineno"> 39 </span>			-f Dockerfile.app<span class="se">\</span>
<span class="lineno"> 40 </span>			.
<span class="lineno"> 41 </span><span class="c">	# Save to tarball.</span>
<span class="lineno"> 42 </span>	docker save <span class="s2">&quot;</span><span class="k">$(</span>APP_TAG<span class="k">)</span><span class="s2">&quot;</span> &gt; <span class="k">$(</span>@<span class="k">)</span>
<span class="lineno"> 43 </span>
<span class="lineno"> 44 </span><span class="c"># Spin-up a KIND cluster and test our &quot;business app&quot; in it.</span>
<span class="lineno"> 45 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">test_app_in_cluster</span>
<span class="lineno"> 46 </span><span class="nf">test_app_in_cluster</span><span class="o">:</span> <span class="n">docker_app</span>
<span class="lineno"> 47 </span>	@echo <span class="s2">&quot;Creating test cluster: </span><span class="k">$(</span>CLUSTER_NAME<span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno"> 48 </span>	@echo <span class="s2">&quot;Using Kindest image: </span><span class="k">$(</span>KIND_IMAGE<span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno"> 49 </span>
<span class="lineno"> 50 </span><span class="c">	# Purge stale kube config.</span>
<span class="lineno"> 51 </span>	rm -rf <span class="s2">&quot;/work/.kube&quot;</span>
<span class="lineno"> 52 </span>
<span class="lineno"> 53 </span><span class="c">	# Setup kubectl.</span>
<span class="lineno"> 54 </span>	<span class="nb">export</span> <span class="nv">KUBE_EDITOR</span><span class="o">=</span><span class="s2">&quot;vim&quot;</span>
<span class="lineno"> 55 </span>	<span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span><span class="s2">&quot;/work/.kube/config&quot;</span>
<span class="lineno"> 56 </span>
<span class="lineno"> 57 </span><span class="c">	# Pull kindest image (kind binary will already pull it, but may as well</span>
<span class="lineno"> 58 </span><span class="c">	# be deliberate, in case we want to swap this out down the road with our</span>
<span class="lineno"> 59 </span><span class="c">	# own private/cached/hardened copy).</span>
<span class="lineno"> 60 </span>	docker pull <span class="s2">&quot;</span><span class="k">$(</span>KIND_IMAGE<span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno"> 61 </span>
<span class="lineno"> 62 </span><span class="c">	# Spin-up the cluster (rootless;</span>
<span class="lineno"> 63 </span><span class="c">	# see https://kind.sigs.k8s.io/docs/user/rootless/).</span>
<span class="lineno"> 64 </span><span class="c">	#export DOCKER_HOST=/var/run/docker.sock</span>
<span class="lineno"> 65 </span>	kind create cluster <span class="se">\</span>
<span class="lineno"> 66 </span>		--name <span class="s2">&quot;</span><span class="k">$(</span>CLUSTER_NAME<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno"> 67 </span>		--image<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>KIND_IMAGE<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno"> 68 </span>		--config<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>KIND_CONFIG<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno"> 69 </span>		--wait<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>KIND_TIMEOUT<span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno"> 70 </span>
<span class="lineno"> 71 </span><span class="c">	# Command to manually purge all clusters. Maybe we shoudl run this</span>
<span class="lineno"> 72 </span><span class="c">	# inside a shell script so we can use an exit TRAP to guarantee we</span>
<span class="lineno"> 73 </span><span class="c">	# clean-up when done (rather than bail out of the build script early on</span>
<span class="lineno"> 74 </span><span class="c">	# the first failure and leave the system in an unknown state).</span>
<span class="lineno"> 75 </span><span class="c">	# (IFS=$&#39;\n&#39;; for i in $(kind get clusters); do echo $i; kind delete clusters $i; done)</span>
<span class="lineno"> 76 </span>
<span class="lineno"> 77 </span><span class="c">	# Show clusters.</span>
<span class="lineno"> 78 </span>	kind get clusters
<span class="lineno"> 79 </span>
<span class="lineno"> 80 </span><span class="c">	# Get cluster info.</span>
<span class="lineno"> 81 </span>	kubectl cluster-info --context kind-<span class="k">$(</span>CLUSTER_NAME<span class="k">)</span>
<span class="lineno"> 82 </span>
<span class="lineno"> 83 </span><span class="c">	# Install an ingress controller (so we can curl/test our app).</span>
<span class="lineno"> 84 </span><span class="c">	# TODO: cache a copy of the chart tarball and the container so we can</span>
<span class="lineno"> 85 </span><span class="c">	# make this run offline and avoid extra bandwith consumption every time</span>
<span class="lineno"> 86 </span><span class="c">	# we would run this.</span>
<span class="lineno"> 87 </span>	kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/kind/deploy.yaml
<span class="lineno"> 88 </span><span class="c">	# Temporary hack: delete validation webhook until issue is resolved.</span>
<span class="lineno"> 89 </span><span class="c">	# https://github.com/kubernetes/ingress-nginx/issues/5401</span>
<span class="lineno"> 90 </span>	kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
<span class="lineno"> 91 </span>
<span class="lineno"> 92 </span><span class="c">	# Load Docker images for business app(s) into cluster.</span>
<span class="lineno"> 93 </span>	kind load <span class="se">\</span>
<span class="lineno"> 94 </span>		image-archive docker-app.tar <span class="se">\</span>
<span class="lineno"> 95 </span>		--name <span class="s2">&quot;</span><span class="k">$(</span>CLUSTER_NAME<span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno"> 96 </span>
<span class="lineno"> 97 </span><span class="c">	# Install Helm chart.</span>
<span class="lineno"> 98 </span>	helm install docker-app charts/docker-app
<span class="lineno"> 99 </span>
<span class="lineno">100 </span><span class="c">	# Wait for app(s) to be ready.</span>
<span class="lineno">101 </span><span class="c">	# Arbitrary sleep (1 min), just so our app chart finishes deploying.</span>
<span class="lineno">102 </span>	sleep <span class="m">60</span>
<span class="lineno">103 </span>
<span class="lineno">104 </span><span class="c">	# Execute some basic tests via curl, kubectl, etc.</span>
<span class="lineno">105 </span>	kubectl get pods -A
<span class="lineno">106 </span>
<span class="lineno">107 </span><span class="c">	# Confirm we can &quot;reach&quot; our pod via the cluster&#39;s IP address, then the</span>
<span class="lineno">108 </span><span class="c">	# ingress controller, then the service object, then the pod object, and</span>
<span class="lineno">109 </span><span class="c">	# finally the application running in our container in our pod (phew,</span>
<span class="lineno">110 </span><span class="c">	# lengthy).</span>
<span class="lineno">111 </span><span class="c">	# 80 is the port our ingress controller is listening on, &quot;/&quot; maps to our</span>
<span class="lineno">112 </span><span class="c">	# docker-app&#39;s ingress rule (should make it something more specific like</span>
<span class="lineno">113 </span><span class="c">	# &quot;/docker-app&quot; in production), and we need to manually specify the host</span>
<span class="lineno">114 </span><span class="c">	# name in the HTTP header (ingress-nginx doesn&#39;t allow wildcarding</span>
<span class="lineno">115 </span><span class="c">	# hostnames at this timel please see</span>
<span class="lineno">116 </span><span class="c">	# https://github.com/kubernetes/kubernetes/issues/41881).</span>
<span class="lineno">117 </span><span class="c">	# Lastly &quot;chart-example.local&quot; is the hostname for the ingress rule</span>
<span class="lineno">118 </span><span class="c">	# which we define in our chart&#39;s &quot;values.yaml&quot; file.</span>
<span class="lineno">119 </span>	curl --header <span class="s2">&quot;Host: chart-example.local&quot;</span> <span class="m">127</span>.0.0.1:80
<span class="lineno">120 </span>
<span class="lineno">121 </span><span class="c">	# Done: clean up.</span>
<span class="lineno">122 </span>	kind delete cluster <span class="se">\</span>
<span class="lineno">123 </span>		--name <span class="s2">&quot;</span><span class="k">$(</span>CLUSTER_NAME<span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno">124 </span>
<span class="lineno">125 </span><span class="c"># Launch Docker container.</span>
<span class="lineno">126 </span><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">run_app</span>
<span class="lineno">127 </span><span class="nf">run_app</span><span class="o">:</span>
<span class="lineno">128 </span>	docker run <span class="se">\</span>
<span class="lineno">129 </span>		--rm -it <span class="se">\</span>
<span class="lineno">130 </span>		<span class="k">$(</span>APP_TAG<span class="k">)</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id101">
<div class="code-block-caption"><span class="caption-number">Listing 49 </span><span class="caption-text">/code/iax_0.0.1.sh</span><a class="headerlink" href="#id101" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/bin/bash</span>
<span class="lineno"> 2 </span><span class="c1">################################################################################</span>
<span class="lineno"> 3 </span><span class="c1"># @brief:       Docker-bootstrap script for building projects via a Docker</span>
<span class="lineno"> 4 </span><span class="c1">#               image.</span>
<span class="lineno"> 5 </span><span class="c1"># @author:      Matthew Giassa.</span>
<span class="lineno"> 6 </span><span class="c1"># @e-mail:      matthew@giassa.net</span>
<span class="lineno"> 7 </span><span class="c1"># @copyright:   Matthew Giassa (IAXES) 2017.</span>
<span class="lineno"> 8 </span><span class="c1">################################################################################</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1"># Docker runtime image to use for building artifacts.</span>
<span class="lineno">11 </span><span class="nv">DOCKER_IMG</span><span class="o">=</span><span class="s2">&quot;docker_builder:0.0.1&quot;</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="c1"># Need to dynamically create a set of &quot;--group-add&quot; statements while iteration</span>
<span class="lineno">14 </span><span class="c1"># across all groups for which we are a member, otherwise a simple</span>
<span class="lineno">15 </span><span class="c1"># &quot;--user=$(id -u):$(id -g)&quot; argument to &quot;docker run&quot; will only capture our</span>
<span class="lineno">16 </span><span class="c1"># primary group ID, and overlook our secondary group IDs (which means we won&#39;t</span>
<span class="lineno">17 </span><span class="c1"># be a member of the &quot;docker&quot; group when executing nested containers as a</span>
<span class="lineno">18 </span><span class="c1"># rootless user, causing headaches).</span>
<span class="lineno">19 </span><span class="nv">MY_GROUPS</span><span class="o">=(</span><span class="s2">&quot;</span><span class="k">$(</span>groups<span class="k">)</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="lineno">20 </span><span class="nv">MY_GROUPS_STR</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="lineno">21 </span><span class="k">for</span> grp in <span class="si">${</span><span class="nv">MY_GROUPS</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
<span class="lineno">22 </span>    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">grp</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="k">$(</span>whoami<span class="k">)</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">23 </span>        <span class="k">continue</span>
<span class="lineno">24 </span>    <span class="k">else</span>
<span class="lineno">25 </span>        <span class="c1"># Need to use GID, not group name.</span>
<span class="lineno">26 </span>        <span class="nv">gid</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>getent group <span class="si">${</span><span class="nv">grp</span><span class="si">}</span><span class="k">)</span> <span class="p">|</span> awk -F <span class="s1">&#39;:&#39;</span> <span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno">27 </span>        <span class="nv">MY_GROUPS_STR</span><span class="o">+=</span><span class="s2">&quot;--group-add </span><span class="si">${</span><span class="nv">gid</span><span class="si">}</span><span class="s2"> &quot;</span>
<span class="lineno">28 </span>    <span class="k">fi</span>
<span class="lineno">29 </span><span class="k">done</span>
<span class="lineno">30 </span>
<span class="lineno">31 </span><span class="c1"># Debug logging.</span>
<span class="lineno">32 </span><span class="c1"># echo &quot;My groups: ${MY_GROUPS[@]}&quot;     &gt;&amp;2</span>
<span class="lineno">33 </span><span class="c1"># echo &quot;Group string: ${MY_GROUPS_STR}&quot; &gt;&amp;2</span>
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="c1"># Launch docker container.</span>
<span class="lineno">36 </span><span class="c1"># * Setup PWD on host to mount to &quot;/work&quot; in the guest/container.</span>
<span class="lineno">37 </span><span class="c1"># * Forward access to SSH agent and host credentials (so container uses same</span>
<span class="lineno">38 </span><span class="c1">#   user/group permissions as current user that launches the script).</span>
<span class="lineno">39 </span><span class="c1"># * Make DIND possible (i.e. expose host Docker Unix domain socket to</span>
<span class="lineno">40 </span><span class="c1">#   guest/container).</span>
<span class="lineno">41 </span><span class="c1"># * Make the home directory be &quot;/work&quot; so that it&#39;s always writeable (allows us</span>
<span class="lineno">42 </span><span class="c1">#   to better handle rootless DIND and KIND).</span>
<span class="lineno">43 </span><span class="c1"># * Use host networking (non-ideal, but necessary for top-level containers to</span>
<span class="lineno">44 </span><span class="c1">#   access certain services like KIND-exposed kubeadm ports redirecting to port</span>
<span class="lineno">45 </span><span class="c1">#   6443 inside a pod without requiring a bridge being setup in advance).</span>
<span class="lineno">46 </span>docker run <span class="se">\</span>
<span class="lineno">47 </span>    --rm -it <span class="se">\</span>
<span class="lineno">48 </span>    --user<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>id -u<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>id -g<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">49 </span>    <span class="si">${</span><span class="nv">MY_GROUPS_STR</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">50 </span>    --volume<span class="o">=</span><span class="s2">&quot;/etc/passwd:/etc/passwd:ro&quot;</span> <span class="se">\</span>
<span class="lineno">51 </span>    --volume<span class="o">=</span><span class="s2">&quot;/etc/group:/etc/group:ro&quot;</span> <span class="se">\</span>
<span class="lineno">52 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f .<span class="k">)</span><span class="s2">:/work:rw&quot;</span> <span class="se">\</span>
<span class="lineno">53 </span>    --workdir<span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">54 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>readlink -f ~/.ssh<span class="k">)</span><span class="s2">:</span><span class="k">$(</span>readlink -f ~/.ssh<span class="k">)</span><span class="s2">:ro&quot;</span> <span class="se">\</span>
<span class="lineno">55 </span>    --volume<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span><span class="k">)</span><span class="s2">:</span><span class="k">$(</span>dirname <span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="lineno">56 </span>    -e <span class="nv">SSH_AUTH_SOCK</span><span class="o">=</span><span class="si">${</span><span class="nv">SSH_AUTH_SOCK</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">57 </span>    --volume<span class="o">=</span><span class="s2">&quot;/var/run/docker.sock:/var/run/docker.sock:rw&quot;</span> <span class="se">\</span>
<span class="lineno">58 </span>    -e <span class="nv">HOME</span><span class="o">=</span><span class="s2">&quot;/work&quot;</span> <span class="se">\</span>
<span class="lineno">59 </span>    --network<span class="o">=</span>host <span class="se">\</span>
<span class="lineno">60 </span>    <span class="si">${</span><span class="nv">DOCKER_IMG</span><span class="si">}</span> <span class="se">\</span>
<span class="lineno">61 </span>    <span class="si">${</span><span class="p">@</span><span class="si">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id102">
<div class="code-block-caption"><span class="caption-number">Listing 50 </span><span class="caption-text">Difference between original and modified iax.sh launcher scripts.</span><a class="headerlink" href="#id102" title="Permalink to this code">¶</a></div>
<div class="highlight-udiff notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="gd">--- /work/examples/build_patterns/kind/iax.sh</span>
<span class="lineno"> 2 </span><span class="gi">+++ /work/examples/build_patterns/kind/iax_0.0.1.sh</span>
<span class="lineno"> 3 </span><span class="gu">@@ -8,7 +8,7 @@</span>
<span class="lineno"> 4 </span> ################################################################################
<span class="lineno"> 5 </span> 
<span class="lineno"> 6 </span> # Docker runtime image to use for building artifacts.
<span class="lineno"> 7 </span><span class="gd">-DOCKER_IMG=&quot;docker_builder:0.0.0&quot;</span>
<span class="lineno"> 8 </span><span class="gi">+DOCKER_IMG=&quot;docker_builder:0.0.1&quot;</span>
<span class="lineno"> 9 </span> 
<span class="lineno">10 </span> # Need to dynamically create a set of &quot;--group-add&quot; statements while iteration
<span class="lineno">11 </span> # across all groups for which we are a member, otherwise a simple
</pre></div>
</div>
</div>
<p>We’ll also include the various additional configuration files and pieces of
Helm chart used to allow us to install our “business app” container to a
cluster (I just created it via <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">create</span> <span class="pre">docker-app</span></code> inside the builder
container invoked by <code class="docutils literal notranslate"><span class="pre">iax_0.0.1.sh</span></code>). Rather than include all the (many)
files verbatim, we’ll settle with knowing that the skeleton chart was created
with <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">v3.6.3</span></code>, and we’ll include the (slightly) modified <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>
file here for reference/completeness.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Helm is a large topic all on its own, so tutorials regarding its use will
not be covered in this book. Readers interested in learning more about this
topic (highly recommended, by the way), are encouraged to learn more about
it <span id="id34">[<a class="reference internal" href="references.html#id40" title="The Helm Authors. Helm - The Package Manager for Kubernetes. \url https://helm.sh/, accessed 2021-08-08.">28</a>]</span>. For now, just think of Helm charts as a means of
packaging <a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> applications for later deployment/installation to a
cluster, similar to using <code class="docutils literal notranslate"><span class="pre">rpm</span></code> files on Fedora and RedHat based distros,
<code class="docutils literal notranslate"><span class="pre">deb</span></code> files on Ubuntu and Debian distros, <code class="docutils literal notranslate"><span class="pre">dmg</span></code> files on Mac <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>,
or <code class="docutils literal notranslate"><span class="pre">setup.exe</span></code> binaries on Windows-based systems. In general, I tend to
just create a skeleton chart via <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">create</span> <span class="pre">some-chart-name</span></code> and
continue working from there. For more details on the <code class="docutils literal notranslate"><span class="pre">config.yaml</span></code> file,
please see <span id="id35">[<a class="reference internal" href="references.html#id42" title="The Kubernetes Authors. kind - Quickstart Guide. \url https://kind.sigs.k8s.io/docs/user/quick-start/, accessed 2021-08-08.">29</a>]</span> <span id="id36">[<a class="reference internal" href="references.html#id41" title="Kevin Sookocheff. Local Kubernetes Development with kind. \url https://sookocheff.com/post/kubernetes/local-kubernetes-development-with-kind/, accessed 2021-08-08.">30</a>]</span>.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id103">
<div class="code-block-caption"><span class="caption-number">Listing 51 </span><span class="caption-text">/code/config.yaml, with ingress controller enabled.</span><a class="headerlink" href="#id103" title="Permalink to this code">¶</a></div>
<div class="highlight-Makefile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c"># Minimal config file/YAML required by KIND.</span>
<span class="lineno"> 2 </span><span class="nf">kind</span><span class="o">:</span> <span class="n">Cluster</span>
<span class="lineno"> 3 </span><span class="nf">apiVersion</span><span class="o">:</span> <span class="n">kind</span>.<span class="n">x</span>-<span class="n">k</span>8<span class="n">s</span>.<span class="n">io</span>/<span class="n">v</span>1<span class="n">alpha</span>4
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="c"># So we can get a working ingress controller in KIND.</span>
<span class="lineno"> 6 </span><span class="nf">nodes</span><span class="o">:</span>
<span class="lineno"> 7 </span><span class="nf">- role</span><span class="o">:</span> <span class="n">control</span>-<span class="n">plane</span>
<span class="lineno"> 8 </span>  kubeadmConfigPatches:
<span class="lineno"> 9 </span>  - <span class="p">|</span>
<span class="lineno">10 </span>    kind: InitConfiguration
<span class="lineno">11 </span>    nodeRegistration:
<span class="lineno">12 </span>      kubeletExtraArgs:
<span class="lineno">13 </span>        node-labels: <span class="s2">&quot;ingress-ready=true&quot;</span>
<span class="lineno">14 </span><span class="c">  # Changing the host ports may break &quot;helm install&quot; operations unless we make</span>
<span class="lineno">15 </span><span class="c">  # additional changes to our overall configuration of KIND.</span>
<span class="lineno">16 </span>  extraPortMappings:
<span class="lineno">17 </span>  - containerPort: <span class="m">80</span>
<span class="lineno">18 </span>    hostPort: <span class="m">80</span>
<span class="lineno">19 </span>    protocol: TCP
<span class="lineno">20 </span>  - containerPort: <span class="m">443</span>
<span class="lineno">21 </span>    hostPort: <span class="m">443</span>
<span class="lineno">22 </span>    protocol: TCP
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id104">
<div class="code-block-caption"><span class="caption-number">Listing 52 </span><span class="caption-text">/code/charts/docker-app/values.yaml</span><a class="headerlink" href="#id104" title="Permalink to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Default values for docker-app.</span>
<span class="lineno"> 2 </span><span class="c1"># This is a YAML-formatted file.</span>
<span class="lineno"> 3 </span><span class="c1"># Declare variables to be passed into your templates.</span>
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="nt">image</span><span class="p">:</span>
<span class="lineno"> 8 </span>  <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker_app</span>
<span class="lineno"> 9 </span>  <span class="nt">pullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<span class="lineno">10 </span>  <span class="c1"># Overrides the image tag whose default is the chart appVersion.</span>
<span class="lineno">11 </span>  <span class="nt">tag</span><span class="p">:</span> <span class="s">&quot;0.0.0&quot;</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="nt">imagePullSecrets</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
<span class="lineno">14 </span><span class="nt">nameOverride</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
<span class="lineno">15 </span><span class="nt">fullnameOverride</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
<span class="lineno">16 </span>
<span class="lineno">17 </span><span class="nt">serviceAccount</span><span class="p">:</span>
<span class="lineno">18 </span>  <span class="c1"># Specifies whether a service account should be created</span>
<span class="lineno">19 </span>  <span class="nt">create</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="lineno">20 </span>  <span class="c1"># Annotations to add to the service account</span>
<span class="lineno">21 </span>  <span class="nt">annotations</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="lineno">22 </span>  <span class="c1"># The name of the service account to use.</span>
<span class="lineno">23 </span>  <span class="c1"># If not set and create is true, a name is generated using the fullname template</span>
<span class="lineno">24 </span>  <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
<span class="lineno">25 </span>
<span class="lineno">26 </span><span class="nt">podAnnotations</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="lineno">27 </span>
<span class="lineno">28 </span><span class="nt">podSecurityContext</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="lineno">29 </span>  <span class="c1"># fsGroup: 2000</span>
<span class="lineno">30 </span>
<span class="lineno">31 </span><span class="nt">securityContext</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="lineno">32 </span>  <span class="c1"># capabilities:</span>
<span class="lineno">33 </span>  <span class="c1">#   drop:</span>
<span class="lineno">34 </span>  <span class="c1">#   - ALL</span>
<span class="lineno">35 </span>  <span class="c1"># readOnlyRootFilesystem: true</span>
<span class="lineno">36 </span>  <span class="c1"># runAsNonRoot: true</span>
<span class="lineno">37 </span>  <span class="c1"># runAsUser: 1000</span>
<span class="lineno">38 </span>
<span class="lineno">39 </span><span class="nt">service</span><span class="p">:</span>
<span class="lineno">40 </span>  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
<span class="lineno">41 </span>  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="lineno">42 </span>
<span class="lineno">43 </span><span class="nt">ingress</span><span class="p">:</span>
<span class="lineno">44 </span>  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="lineno">45 </span>  <span class="nt">className</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
<span class="lineno">46 </span>  <span class="nt">annotations</span><span class="p">:</span>
<span class="lineno">47 </span>    <span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="lineno">48 </span>    <span class="nt">kubernetes.io/tls-acme</span><span class="p">:</span> <span class="s">&quot;true&quot;</span>
<span class="lineno">49 </span>  <span class="nt">hosts</span><span class="p">:</span>
<span class="lineno">50 </span>    <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">chart-example.local</span>
<span class="lineno">51 </span>      <span class="nt">paths</span><span class="p">:</span>
<span class="lineno">52 </span>        <span class="p p-Indicator">-</span> <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="lineno">53 </span>          <span class="nt">pathType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
<span class="lineno">54 </span>  <span class="nt">tls</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
<span class="lineno">55 </span>  <span class="c1">#  - secretName: chart-example-tls</span>
<span class="lineno">56 </span>  <span class="c1">#    hosts:</span>
<span class="lineno">57 </span>  <span class="c1">#      - chart-example.local</span>
<span class="lineno">58 </span>
<span class="lineno">59 </span><span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="lineno">60 </span>  <span class="c1"># We usually recommend not to specify default resources and to leave this as a conscious</span>
<span class="lineno">61 </span>  <span class="c1"># choice for the user. This also increases chances charts run on environments with little</span>
<span class="lineno">62 </span>  <span class="c1"># resources, such as Minikube. If you do want to specify resources, uncomment the following</span>
<span class="lineno">63 </span>  <span class="c1"># lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.</span>
<span class="lineno">64 </span>  <span class="c1"># limits:</span>
<span class="lineno">65 </span>  <span class="c1">#   cpu: 100m</span>
<span class="lineno">66 </span>  <span class="c1">#   memory: 128Mi</span>
<span class="lineno">67 </span>  <span class="c1"># requests:</span>
<span class="lineno">68 </span>  <span class="c1">#   cpu: 100m</span>
<span class="lineno">69 </span>  <span class="c1">#   memory: 128Mi</span>
<span class="lineno">70 </span>
<span class="lineno">71 </span><span class="nt">autoscaling</span><span class="p">:</span>
<span class="lineno">72 </span>  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="lineno">73 </span>  <span class="nt">minReplicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="lineno">74 </span>  <span class="nt">maxReplicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="lineno">75 </span>  <span class="nt">targetCPUUtilizationPercentage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="lineno">76 </span>  <span class="c1"># targetMemoryUtilizationPercentage: 80</span>
<span class="lineno">77 </span>
<span class="lineno">78 </span><span class="nt">nodeSelector</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="lineno">79 </span>
<span class="lineno">80 </span><span class="nt">tolerations</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
<span class="lineno">81 </span>
<span class="lineno">82 </span><span class="nt">affinity</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</pre></div>
</div>
</div>
<p>For reference, the directory listing should look like the following:</p>
<div class="literal-block-wrapper docutils container" id="id105">
<div class="code-block-caption"><span class="caption-number">Listing 53 </span><span class="caption-text">Directory listing for example KIND project. Could use some cleaning up down the road, but for now, we leave all the files in one place for easily re-creating the examples in this section.</span><a class="headerlink" href="#id105" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>  kind/
    charts/docker-app/
      charts/
      templates/
        tests/
          test-connection.yaml
        _helpers.tpl
        deployment.yaml
        hpa.yaml
        ingress.yaml
        NOTES.txt
        service.yaml
        serviceaccount.yaml
      .helmignore
      Chart.yaml
      values.yaml
    config.yaml
    Dockerfile.app
    Dockerfile.app.dockerignore
    Dockerfile.bootstrap_builder.pre
    Dockerfile.bootstrap_builder.pre.dockerignore
    Dockerfile.builder
    Dockerfile.builder.dockerignore
    entrypoint.sh
    iax.sh
    iax_0.0.1.sh
    Makefile.app
    Makefile.bootstrap_builder.pre
    Makefile.builder
</pre></div>
</div>
</div>
<p>Now, to use our latest-and-greatest builder image to build our “app”, create a
Docker image that encapsulates our app, generate a helm chart tarball that
makes our containerized app “<a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> ready”, and finally deploy it to
<a class="reference internal" href="glossary.html#term-KIND"><span class="xref std std-term">KIND</span></a> cluster to make sure it installs and runs as expected in a
cluster. Lots of verbose logging information is about to fly by.</p>
<div class="literal-block-wrapper docutils container" id="id106">
<div class="code-block-caption"><span class="caption-number">Listing 54 </span><span class="caption-text">Launching our KIND builder + tester.</span><a class="headerlink" href="#id106" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span>owner@darkstar:~$ ./iax_0.0.1.sh make -f Makefile.app
<span class="lineno"> 2 </span>...
<span class="lineno"> 3 </span>...
<span class="lineno"> 4 </span>...
<span class="lineno"> 5 </span>... curl --header <span class="s2">&quot;Host: chart-example.local&quot;</span> <span class="m">127</span>.0.0.1:80/
<span class="lineno"> 6 </span>&lt;!DOCTYPE HTML PUBLIC <span class="s2">&quot;-//W3C//DTD HTML 4.01//EN&quot;</span> <span class="s2">&quot;http://www.w3.org/TR/html4/strict.dtd&quot;</span>&gt;
<span class="lineno"> 7 </span>&lt;html&gt;
<span class="lineno"> 8 </span>&lt;head&gt;
<span class="lineno"> 9 </span>&lt;meta http-equiv<span class="o">=</span><span class="s2">&quot;Content-Type&quot;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span>&gt;
<span class="lineno">10 </span>&lt;title&gt;Directory listing <span class="k">for</span> /&lt;/title&gt;
<span class="lineno">11 </span>&lt;/head&gt;
<span class="lineno">12 </span>&lt;body&gt;
<span class="lineno">13 </span>&lt;h1&gt;Directory listing <span class="k">for</span> /&lt;/h1&gt;
<span class="lineno">14 </span>&lt;hr&gt;
<span class="lineno">15 </span>&lt;ul&gt;
<span class="lineno">16 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;bin/&quot;</span>&gt;bin@&lt;/a&gt;&lt;/li&gt;
<span class="lineno">17 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;boot/&quot;</span>&gt;boot/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">18 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;dev/&quot;</span>&gt;dev/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">19 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;entrypoint.sh&quot;</span>&gt;entrypoint.sh&lt;/a&gt;&lt;/li&gt;
<span class="lineno">20 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;etc/&quot;</span>&gt;etc/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">21 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;home/&quot;</span>&gt;home/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">22 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;lib/&quot;</span>&gt;lib@&lt;/a&gt;&lt;/li&gt;
<span class="lineno">23 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;lib32/&quot;</span>&gt;lib32@&lt;/a&gt;&lt;/li&gt;
<span class="lineno">24 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;lib64/&quot;</span>&gt;lib64@&lt;/a&gt;&lt;/li&gt;
<span class="lineno">25 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;libx32/&quot;</span>&gt;libx32@&lt;/a&gt;&lt;/li&gt;
<span class="lineno">26 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;media/&quot;</span>&gt;media/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">27 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;mnt/&quot;</span>&gt;mnt/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">28 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;opt/&quot;</span>&gt;opt/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">29 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;proc/&quot;</span>&gt;proc/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">30 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;root/&quot;</span>&gt;root/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">31 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;run/&quot;</span>&gt;run/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">32 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;sbin/&quot;</span>&gt;sbin@&lt;/a&gt;&lt;/li&gt;
<span class="lineno">33 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;srv/&quot;</span>&gt;srv/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">34 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;sys/&quot;</span>&gt;sys/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">35 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;tmp/&quot;</span>&gt;tmp/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">36 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;usr/&quot;</span>&gt;usr/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">37 </span>&lt;li&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;var/&quot;</span>&gt;var/&lt;/a&gt;&lt;/li&gt;
<span class="lineno">38 </span>&lt;/ul&gt;
<span class="lineno">39 </span>&lt;hr&gt;
<span class="lineno">40 </span>&lt;/body&gt;
<span class="lineno">41 </span>&lt;/html&gt;
</pre></div>
</div>
</div>
<p>Success: we can bootstrap our own Docker builder image, use it to create
containerized applications, wrap them in a Docker container, deploy them to a
<a class="reference internal" href="glossary.html#term-K8S"><span class="xref std std-term">K8S</span></a> (throwaway/ephemeral) cluster, test them, all with a single
invocation of <code class="docutils literal notranslate"><span class="pre">./iax_0.0.1.sh</span> <span class="pre">make</span> <span class="pre">-f</span> <span class="pre">Makefile.app</span></code>. More importantly, the
entire process, from building to running to deploying and testing, is
completely containerized, so we can easily reproduce it in a <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a>
pipeline: fantastic!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Build pattern viability metrics.</p>
<p>Repeatable: very repeatable, but sometimes errors can result in a large
number of stale pods surviving the termination of the top-level tool (KIND)
itself, which either requires manual intervention or carefully crafted
launcher/cleanup scripts to ensure all resources are completely purged
between runs. Also have to take care that all projects use psuedo-random pod
names so there aren’t namespace collisions across jobs running concurrently
on the same piece of build infrastructure. In short, needs to be designed
with multi-tenant capabilities in mind when deploying as part of shared
infrastructure such as a <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a> system.</p>
<p>Reliable: very reliable (when properly configured/designed, as per the notes
above). May take a few rounds of integration attempts to “get it right”.</p>
<p>Scalable: very scalable.</p>
</div>
</div>
</div>
<div class="section" id="best-practises-security-concerns">
<span id="sec-containers-security"></span><h2>Best Practises &amp; Security Concerns<a class="headerlink" href="#best-practises-security-concerns" title="Permalink to this headline">¶</a></h2>
<p>We will conclude this chapter with a somewhat lengthy, but by no means
exhaustive, collection of “best practises” one is advised to employ in the
development of cloud native build patterns (as well as building applications
with Docker in general). I have made every effort to keep this collection
limited to “generally accepted as true” recommendations, and left out topics
that may be construed as opinionated in nature.</p>
<p>It is worth mentioning that there are almost always exceptions to rules,
best-practises, etc.; (earlier notes in the chapter mention the trade-offs of
security versus functionality in using “Docker-in-Docker” via sharing the
Docker socket). I would encourage readers to treat the following best-practises
I describe as “very strong suggestions” as opposed to technical dogma. That
being said, the authors cited below may have differing opinions on these
topics, and I make no claim that my opinions necessarily reflect or otherwise
align with theirs.</p>
<p>With this being said, collections of material (similar to what is presented in
this section) may also be found in <span id="id37">[<a class="reference internal" href="references.html#id21" title="Docker Inc. Best Practises for Writing Dockerfiles. \url https://docs.docker.com/develop/develop-images/dockerfile_best-practices/, accessed 2021-08-08.">31</a>]</span> <span id="id38">[<a class="reference internal" href="references.html#id25" title="Matthew Close. Tutorial- Understanding the Security Risks of Running Docker Containers: Don't Lose Your Sock(et)s. \url https://www.ctl.io/developers/blog/post/tutorial-understanding-the-security-risks-of-running-docker-containers, accessed 2021-08-02.">20</a>]</span>
<span id="id39">[<a class="reference internal" href="references.html#id26" title="Peter Benjamin. Docker Security Best-Practises. \url https://dev.to/pbnj/docker-security-best-practices-45ih, accessed 2021-08-03.">21</a>]</span> <span id="id40">[<a class="reference internal" href="references.html#id27" title="Srdjan Grubor. Top 3 Things to Avoid When Using Containers. \url https://www.conjur.org/blog/top-3-things-to-avoid-when-using-containers/, accessed 2021-08-03.">22</a>]</span> <span id="id41">[<a class="reference internal" href="references.html#id28" title="OWASP Cheat Sheet Series Team. Docker Security Cheat Sheet. \url https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html, accessed 2021-08-03.">23</a>]</span>, to name a few
examples.</p>
<div class="section" id="privileged-containers-rootless-containers">
<h3>Privileged Containers &amp; Rootless Containers<a class="headerlink" href="#privileged-containers-rootless-containers" title="Permalink to this headline">¶</a></h3>
<p>An often conflated topic is the concept of a root-enabled Docker container
versus a privileged Docker container. Let’s explore this in greater detail.</p>
<p>A root-enabled Docker container is simply a container that is invoked with the
<a class="reference internal" href="glossary.html#term-UID"><span class="xref std std-term">UID</span></a> (and associated permissions/access/etc.) of the root user (i.e.
<a class="reference internal" href="glossary.html#term-UID"><span class="xref std std-term">UID</span></a> is zero). For example, if I were to launch a container via
<code class="docutils literal notranslate"><span class="pre">sudo</span></code>, we’ll see that the container is running as the root user.</p>
<div class="literal-block-wrapper docutils container" id="id107">
<div class="code-block-caption"><span class="caption-number">Listing 55 </span><span class="caption-text">Launching Docker as root.</span><a class="headerlink" href="#id107" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span>owner@darkstar$&gt; sudo docker run --rm -it ubuntu:focal
<span class="lineno">2 </span>root@059d5d126fac:/# whoami
<span class="lineno">3 </span>root
<span class="lineno">4 </span>
<span class="lineno">5 </span>root@059d5d126fac:/# id -u
<span class="lineno">6 </span><span class="m">0</span>
</pre></div>
</div>
</div>
<p>OK. Well, what if I launch a container without the use of the <code class="docutils literal notranslate"><span class="pre">sudo</span></code> command?
After all, I added my own account to the <code class="docutils literal notranslate"><span class="pre">docker</span></code> group earlier in this
chapter (i.e. via <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">usermod</span> <span class="pre">-a</span> <span class="pre">-G</span> <span class="pre">docker</span> <span class="pre">$(whoami)</span></code>). Let’s try this
again.</p>
<div class="literal-block-wrapper docutils container" id="id108">
<div class="code-block-caption"><span class="caption-number">Listing 56 </span><span class="caption-text">Launching Docker as a non-root user that’s a member of the docker group.</span><a class="headerlink" href="#id108" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span>owner@darkstar$&gt; docker run --rm -it ubuntu:focal
<span class="lineno">2 </span>root@d17ad08b754e:/# whoami
<span class="lineno">3 </span>root
<span class="lineno">4 </span>
<span class="lineno">5 </span>root@d17ad08b754e:/# id -u
<span class="lineno">6 </span><span class="m">0</span>
</pre></div>
</div>
</div>
<p>Still root. Even though our own user account is a non-root account, Docker (and
the processes/containers it launches) are launched via the root user account
(adding our account to the <code class="docutils literal notranslate"><span class="pre">docker</span></code> group merely grants us access to use
Docker: it doesn’t affect runtime permissions/access; <span id="id42">[<a class="reference internal" href="references.html#id17" title="Docker Inc. Post-installation steps for Linux. \url https://docs.docker.com/engine/install/linux-postinstall/, accessed 2021-08-03.">32</a>]</span>). To
actually launch the container as a non-root user (less important on local
development environments if the container comes from a trusted source, but very
important if the container is being used in a production environment,
especially if it’s part of a user-facing or public deployment), one may either
make use of the <code class="docutils literal notranslate"><span class="pre">--user</span></code> argument to <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code> <span id="id43">[<a class="reference internal" href="references.html#id18" title="Docker Inc. Run the Docker daemon as a non-root user (Rootless mode). \url https://docs.docker.com/engine/security/rootless/, accessed 2021-08-03.">33</a>]</span>, or by
use of the <code class="docutils literal notranslate"><span class="pre">USER</span></code> keyword in the Dockerfile used to build the
Docker image (that is later used to invoke a container).</p>
<p>Now, the other topic of interest: privileged containers. Privileged containers
are simply containers that have been invoked via <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code> (or a similar
<a class="reference internal" href="glossary.html#term-API"><span class="xref std std-term">API</span></a> call) with the <code class="docutils literal notranslate"><span class="pre">--privileged</span></code> flag set. This flag grants the
container access to all devices on the host <a class="reference internal" href="glossary.html#term-OS"><span class="xref std std-term">OS</span></a>, and makes it trivial to
break out of the container (even more trivial than running a container as
root). It should only be used for very specific cases where the container needs
access to specific file systems or hardware, and all users of the system
acknowledge in advance that the container is not at all secured, having full
read/write access to the host system.</p>
<p>Now, with that out of the way: don’t use either of these methods (root-enabled
containers or privileged container) unless there is a <strong>very</strong> good reason for
doing so, and all stakeholders are well aware of the potential consequences of
using containers with these features enabled.</p>
</div>
<div class="section" id="using-dockerignore-for-security-and-image-size-reduction">
<h3>Using dockerignore for Security and Image Size Reduction<a class="headerlink" href="#using-dockerignore-for-security-and-image-size-reduction" title="Permalink to this headline">¶</a></h3>
<p>Earlier in this chapter, the reader may recall mention of the use of the
<code class="docutils literal notranslate"><span class="pre">DOCKER_BUILDKIT</span></code> environment variable when executing <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code>
operations, along with the recommendation of the use of <code class="docutils literal notranslate"><span class="pre">.dockerignore</span></code>
files (<a class="reference internal" href="#ssec-single-container"><span class="std std-ref">Single Container with Docker</span></a>). It’s an important-enough topic to merit a
second mention, as it can help reduce the size of the final Docker image built,
as well as preventing cases where privileged information (i.e. <a class="reference internal" href="glossary.html#term-SSH"><span class="xref std std-term">SSH</span></a>
keys, signing certificates, user credentials, etc.) could accidentally be
bundled into the image as well (a terrible practise in general, and
catastrophic if the image is published and made accessible to a broad audience;
even more so if publicly released). Rather than reproduce a lengthy tutorial on
the topic here, the reader is encouraged to review <span id="id44">[<a class="reference internal" href="references.html#id33" title="Docker Inc. Build images with BuildKit. \url https://docs.docker.com/develop/develop-images/build_enhancements/, accessed 2021-08-03.">13</a>]</span>
<span id="id45">[<a class="reference internal" href="references.html#id34" title="Docker Inc. Dockerfile Reference. \url https://docs.docker.com/engine/reference/builder/, accessed 2021-08-03.">14</a>]</span> <span id="id46">[<a class="reference internal" href="references.html#id35" title="Tristan Zajonc, The Docker Maintainers. Add support for specifying .dockerignore file with -i/–ignore #12886. \url https://github.com/moby/moby/issues/12886#issuecomment-480575928, accessed 2021-08-03.">15</a>]</span> <span id="id47">[<a class="reference internal" href="references.html#id36" title="Alexei Ledenev. Do not ignore .dockerignore (it’s expensive and potentially dangerous). \url https://codefresh.io/docker-tutorial/not-ignore-dockerignore-2/, accessed 2021-08-03.">16</a>]</span>.</p>
</div>
<div class="section" id="reducing-image-size-and-number-of-layers-with-apt">
<h3>Reducing Image Size and Number of Layers with apt<a class="headerlink" href="#reducing-image-size-and-number-of-layers-with-apt" title="Permalink to this headline">¶</a></h3>
<p>The reader may have noticed a common pattern in Dockerfiles throughout this
chapter (example below).</p>
<div class="literal-block-wrapper docutils container" id="id109">
<div class="code-block-caption"><span class="caption-number">Listing 57 </span><span class="caption-text">Dockerfile that extends Ubuntu.</span><a class="headerlink" href="#id109" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno">2 </span>
<span class="lineno">3 </span><span class="c"># System packages.</span>
<span class="lineno">4 </span><span class="k">RUN</span> apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">5 </span>    apt install -y <span class="se">\</span>
<span class="lineno">6 </span>        make <span class="se">\</span>
<span class="lineno">7 </span>        gcc <span class="se">\</span>
<span class="lineno">8 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">9 </span>    apt clean -y
</pre></div>
</div>
</div>
<p>Why cram so many commands (separated with the <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code> functionality our shell
provides) into a single Dockerfile <code class="docutils literal notranslate"><span class="pre">RUN</span></code> statement? Why not do something more
“clean” like so:</p>
<div class="literal-block-wrapper docutils container" id="id110">
<div class="code-block-caption"><span class="caption-number">Listing 58 </span><span class="caption-text">Dockerfile that extends Ubuntu.</span><a class="headerlink" href="#id110" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno">2 </span>
<span class="lineno">3 </span><span class="c"># System packages.</span>
<span class="lineno">4 </span><span class="k">RUN</span> apt update -y
<span class="lineno">5 </span><span class="k">RUN</span> apt install -y make
<span class="lineno">6 </span><span class="k">RUN</span> apt install -y gcc
<span class="lineno">7 </span><span class="k">RUN</span> apt clean -y
</pre></div>
</div>
</div>
<p>Well, there are a few reasons for this. For starters, each <code class="docutils literal notranslate"><span class="pre">RUN</span></code> statement
effectively results in an additional layer being created in our overall Docker
image <span id="id48">[<a class="reference internal" href="references.html#id20" title="Docker Inc. About storage drivers. \url https://docs.docker.com/storage/storagedriver/, accessed 2021-08-08.">34</a>]</span>: something we generally try to minimize wherever
possible. Additionally, Dockerfiles will often have (especially in the case of
“builder” images used for compiling/building projects, like we’re covering in
this chapter) several dozen packages (possibly hundreds, depending on how many
additional dependencies <code class="docutils literal notranslate"><span class="pre">apt</span></code> pulls in). Therefore, the general practise is
to have all the <code class="docutils literal notranslate"><span class="pre">apt</span></code>-supplied packages stuffed into a single layer, rather
than attempting to have more granular control over it. Also, if we’re
installing numerous packages that have common/shared dependencies, a granular
approach would be inconsistent at best when trying to force specific
dependencies into a specific layer. So, at a minimum, our “optimal” Dockerfile
should at least look a bit like so:</p>
<div class="literal-block-wrapper docutils container" id="id111">
<div class="code-block-caption"><span class="caption-number">Listing 59 </span><span class="caption-text">Dockerfile that extends Ubuntu.</span><a class="headerlink" href="#id111" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno">2 </span>
<span class="lineno">3 </span><span class="c"># System packages.</span>
<span class="lineno">4 </span><span class="k">RUN</span> apt update -y
<span class="lineno">5 </span><span class="k">RUN</span> apt install -y make <span class="se">\</span>
<span class="lineno">6 </span>                   gcc
<span class="lineno">7 </span><span class="k">RUN</span> apt clean -y
</pre></div>
</div>
</div>
<p>We could always put <code class="docutils literal notranslate"><span class="pre">make</span></code> and <code class="docutils literal notranslate"><span class="pre">gcc</span></code> on the same line, but, at least in my
own opinion, it’s a lot more readable this way (especially when dozens of
packages are listed). So, what about the <code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">clean</span></code>
steps? Why also cram those in to the same <code class="docutils literal notranslate"><span class="pre">RUN</span></code> statement as the <code class="docutils literal notranslate"><span class="pre">apt</span>
<span class="pre">install</span></code> step? As mentioned earlier, every <code class="docutils literal notranslate"><span class="pre">RUN</span></code> statement will result in a
new layer. Furthermore, if we add a file to our image in one stage of our
Dockerfile, and remove the same file in a later stage, <strong>the file is still in
our overall Docker image!</strong> This means that the image size is still adversely
impacted by this file, but the file isn’t (easily) accessibly. This also has
security implications that are covered in the subsequent sub-section.</p>
<p>In the case of installing packages via <code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">install</span></code>, by condensing these
various commands into a single <code class="docutils literal notranslate"><span class="pre">RUN</span></code> statement, we’re able to effectively get
a list of the latest packages available, install them, and clean up the <code class="docutils literal notranslate"><span class="pre">apt</span></code>
cache (and copy of the package listing) in a single step, avoiding a plethora
of intermediate (and completely unneeded) files from being bundled into our
overall image. Hence, we arrive at our original example again:</p>
<div class="literal-block-wrapper docutils container" id="id112">
<div class="code-block-caption"><span class="caption-number">Listing 60 </span><span class="caption-text">Dockerfile that extends Ubuntu.</span><a class="headerlink" href="#id112" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno">2 </span>
<span class="lineno">3 </span><span class="c"># System packages.</span>
<span class="lineno">4 </span><span class="k">RUN</span> apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">5 </span>    apt install -y <span class="se">\</span>
<span class="lineno">6 </span>        make <span class="se">\</span>
<span class="lineno">7 </span>        gcc <span class="se">\</span>
<span class="lineno">8 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">9 </span>    apt clean -y
</pre></div>
</div>
</div>
<p>Current, official versions of <code class="docutils literal notranslate"><span class="pre">apt</span></code> automatically execute the equivalent of
<code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">clean</span></code> (i.e. cache isn’t preserved after installation completes), so the
<code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">clean</span></code> step is less relevant on something current like Ubuntu 20.04
“Focal”. However, for completeness, we’ll present a couple of example
Dockerfiles and demonstrate that there is indeed a difference in overall image
size and the number of layers due to whether-or-not condensed <code class="docutils literal notranslate"><span class="pre">RUN</span></code>
statements are used.</p>
<div class="literal-block-wrapper docutils container" id="id113">
<div class="code-block-caption"><span class="caption-number">Listing 61 </span><span class="caption-text">Dockerfile example: no “squashing”.</span><a class="headerlink" href="#id113" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span>FROM ubuntu:trusty as baseline
<span class="lineno">2 </span><span class="c1"># System packages.</span>
<span class="lineno">3 </span>RUN apt-get update -y
<span class="lineno">4 </span>RUN apt-get install -y make
<span class="lineno">5 </span>RUN apt-get install -y gcc
<span class="lineno">6 </span>RUN apt-get clean -y
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id114">
<div class="code-block-caption"><span class="caption-number">Listing 62 </span><span class="caption-text">Sample run: no-squashing Dockerfile example.</span><a class="headerlink" href="#id114" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span>owner@darkstar$&gt; docker build . -t my_docker_builder:local
<span class="lineno"> 2 </span>Sending build context to Docker daemon  <span class="m">35</span>.33kB
<span class="lineno"> 3 </span>Step <span class="m">1</span>/5 : FROM ubuntu:trusty as baseline
<span class="lineno"> 4 </span> ---&gt; 13b66b487594
<span class="lineno"> 5 </span>Step <span class="m">2</span>/5 : RUN apt-get update -y
<span class="lineno"> 6 </span> ---&gt; Using cache
<span class="lineno"> 7 </span> ---&gt; e4173983516e
<span class="lineno"> 8 </span>Step <span class="m">3</span>/5 : RUN apt-get install -y make
<span class="lineno"> 9 </span> ---&gt; Using cache
<span class="lineno">10 </span> ---&gt; 1ec3953ddcc5
<span class="lineno">11 </span>Step <span class="m">4</span>/5 : RUN apt-get install -y gcc
<span class="lineno">12 </span> ---&gt; Using cache
<span class="lineno">13 </span> ---&gt; dc9f68dcdfd4
<span class="lineno">14 </span>Step <span class="m">5</span>/5 : RUN apt-get clean -y
<span class="lineno">15 </span> ---&gt; Using cache
<span class="lineno">16 </span> ---&gt; 9fc945253a98
<span class="lineno">17 </span>Successfully built 9fc945253a98
<span class="lineno">18 </span>Successfully tagged my_docker_builder:local
<span class="lineno">19 </span>
<span class="lineno">20 </span>owner@darkstar$&gt; docker image ls <span class="p">|</span> grep my_docker_builder.*local
<span class="lineno">21 </span>my_docker_builder                 <span class="nb">local</span>     9fc945253a98   <span class="m">7</span> minutes ago    285MB
<span class="lineno">22 </span>
<span class="lineno">23 </span>owner@darkstar$&gt; <span class="nb">echo</span> <span class="s2">&quot;Number of layers: </span><span class="k">$((</span> <span class="k">$(</span>docker <span class="nb">history</span> --no-trunc my_docker_builder:local <span class="p">|</span> wc -l<span class="k">)</span> <span class="o">-</span> <span class="m">1</span> <span class="k">))</span><span class="s2">&quot;</span>
<span class="lineno">24 </span>Number of layers: <span class="m">9</span>
</pre></div>
</div>
</div>
<p>Now let’s repeat this experiment with “squashing” (i.e. condensing of commands
passed to a <code class="docutils literal notranslate"><span class="pre">RUN</span></code> statement).</p>
<div class="literal-block-wrapper docutils container" id="id115">
<div class="code-block-caption"><span class="caption-number">Listing 63 </span><span class="caption-text">Dockerfile example: with “squashing”.</span><a class="headerlink" href="#id115" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span>FROM ubuntu:trusty as baseline
<span class="lineno">2 </span>RUN apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">3 </span>    apt install -y <span class="se">\</span>
<span class="lineno">4 </span>        make <span class="se">\</span>
<span class="lineno">5 </span>        gcc <span class="se">\</span>
<span class="lineno">6 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">7 </span>    apt clean -y
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id116">
<div class="code-block-caption"><span class="caption-number">Listing 64 </span><span class="caption-text">Sample run: squashing Dockerfile example.</span><a class="headerlink" href="#id116" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span>owner@darkstar$&gt; docker build . -t my_docker_builder:local
<span class="lineno"> 2 </span>Sending build context to Docker daemon  <span class="m">35</span>.33kB
<span class="lineno"> 3 </span>Step <span class="m">1</span>/2 : FROM ubuntu:trusty as baseline
<span class="lineno"> 4 </span>---&gt; 13b66b487594
<span class="lineno"> 5 </span>Step <span class="m">2</span>/2 : RUN apt-get update -y <span class="o">&amp;&amp;</span>     apt-get install -y         make
<span class="lineno"> 6 </span>gcc     <span class="o">&amp;&amp;</span>     apt-get clean -y
<span class="lineno"> 7 </span>---&gt; Using cache
<span class="lineno"> 8 </span>---&gt; 655083adb0ef
<span class="lineno"> 9 </span>Successfully built 655083adb0ef
<span class="lineno">10 </span>Successfully tagged my_docker_builder:local
<span class="lineno">11 </span>
<span class="lineno">12 </span>owner@darkstar$&gt; docker image ls <span class="p">|</span> grep my_docker_builder.*local
<span class="lineno">13 </span>my_docker_builder                 <span class="nb">local</span>     655083adb0ef   <span class="m">9</span> minutes ago 282MB
<span class="lineno">14 </span>
<span class="lineno">15 </span>PWD: ~/code/repos/iaxes/pronk8s-src/examples/build_patterns/dind_example
<span class="lineno">16 </span><span class="o">[</span><span class="m">09</span>:44:37<span class="o">]</span>: owner@darkstar$&gt; <span class="nb">echo</span> <span class="s2">&quot;Number of layers: </span><span class="k">$((</span> <span class="k">$(</span>docker <span class="nb">history</span> --no-trunc my_docker_builder:local <span class="p">|</span> wc -l<span class="k">)</span> <span class="o">-</span> <span class="m">1</span> <span class="k">))</span><span class="s2">&quot;</span>
<span class="lineno">17 </span>Number of layers: <span class="m">6</span>
</pre></div>
</div>
</div>
<p>So, we’re able to reduce the image size and number of layers, and this will
also play an important part in the following sub-section on credential leaks.</p>
</div>
<div class="section" id="credential-leaks-don-t-embed-credentials">
<h3>Credential Leaks - Don’t Embed Credentials<a class="headerlink" href="#credential-leaks-don-t-embed-credentials" title="Permalink to this headline">¶</a></h3>
<p>Follow hot on the heels of the previous sub-section, we cover another reason to
make use of <code class="docutils literal notranslate"><span class="pre">dockerignore</span></code> files and be cautious about what files get pulled
in during <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code> operations: credential leaks. This happens when
privileged information (i.e. signing certificates, <a class="reference internal" href="glossary.html#term-SSH"><span class="xref std std-term">SSH</span></a> keys,
usernames/passwords, <a class="reference internal" href="glossary.html#term-API"><span class="xref std std-term">API</span></a> keys, etc.; are accidentally made public or
available to unauthorized parties). Sometimes this can be due to a plain text
file containing credentials being created during automated <a class="reference internal" href="glossary.html#term-CI-CD"><span class="xref std std-term">CI/CD</span></a>
builds. Masked environment variables are preferable, as covered in
<a class="reference internal" href="cicd.html#sec-cicd"><span class="std std-ref">Continous Integration &amp; Continuous Delivery</span></a>, as it avoids having to rely on things like <code class="docutils literal notranslate"><span class="pre">dockerignore</span></code>
files being the last (or only) line of defense against bundling credentials
into images, or having to zero-fill persistent storage devices out of concern
mission-critical credentials are scattered, unencrypted on disk drives
throughout your build infrastructure.</p>
<p>In any case, we’ll cover a simple example where credentials are deliberately
“baked in” to a Docker image, with the intent (by the hapless user) of only
having them available “temporarily”, due to them being needed for some
intermediate build operation to run successfully.</p>
<div class="literal-block-wrapper docutils container" id="id117">
<div class="code-block-caption"><span class="caption-number">Listing 65 </span><span class="caption-text">Dockerfile for “silly secrets” example.</span><a class="headerlink" href="#id117" title="Permalink to this code">¶</a></div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="k">FROM</span><span class="s"> ubuntu:focal as baseline</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c"># Add our super secret file. Some intermediate part of the build needs to know</span>
<span class="lineno"> 4 </span><span class="c"># this information to complete.</span>
<span class="lineno"> 5 </span><span class="k">ADD</span> super_secret.txt /
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="c"># System packages.</span>
<span class="lineno"> 8 </span><span class="k">RUN</span> apt update -y <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno"> 9 </span>    apt install -y <span class="se">\</span>
<span class="lineno">10 </span>        cowsay <span class="se">\</span>
<span class="lineno">11 </span>    <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="lineno">12 </span>    apt clean -y
<span class="lineno">13 </span>
<span class="lineno">14 </span><span class="c"># Remove our secret so we&#39;re all safe and no secrets get leaked. Right?</span>
<span class="lineno">15 </span><span class="k">RUN</span> rm /super_secret.txt
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id118">
<div class="code-block-caption"><span class="caption-number">Listing 66 </span><span class="caption-text">Mock credentials for “silly secrets” example.</span><a class="headerlink" href="#id118" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span>One, if by land, and two, if by sea.
</pre></div>
</div>
</div>
<p>Now, let’s build this image, and see how “secure” it really is.</p>
<div class="literal-block-wrapper docutils container" id="id119">
<div class="code-block-caption"><span class="caption-number">Listing 67 </span><span class="caption-text">Silly secrets example: recovering “deleted” files from a Docker image.</span><a class="headerlink" href="#id119" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># Build our image.</span>
<span class="lineno"> 2 </span>owner@darkstar$&gt; docker build . -t silly_secrets:local
<span class="lineno"> 3 </span>Sending build context to Docker daemon  <span class="m">3</span>.072kB
<span class="lineno"> 4 </span>Step <span class="m">1</span>/4 : FROM ubuntu:focal as baseline
<span class="lineno"> 5 </span> ---&gt; 1318b700e415
<span class="lineno"> 6 </span>Step <span class="m">2</span>/4 : ADD super_secret.txt /
<span class="lineno"> 7 </span> ---&gt; 0df172df41b1
<span class="lineno"> 8 </span>Step <span class="m">3</span>/4 : RUN apt update -y <span class="o">&amp;&amp;</span>     apt install -y         cowsay     <span class="o">&amp;&amp;</span>     apt clean -y
<span class="lineno"> 9 </span> ---&gt; Running in 4b8d868e2866
<span class="lineno">10 </span>...
<span class="lineno">11 </span>...
<span class="lineno">12 </span>Step <span class="m">4</span>/4 : RUN rm /super_secret.txt
<span class="lineno">13 </span> ---&gt; Running in 9814d6c45b09
<span class="lineno">14 </span>Removing intermediate container 9814d6c45b09
<span class="lineno">15 </span> ---&gt; 092e3a86d509
<span class="lineno">16 </span>Successfully built 092e3a86d509
<span class="lineno">17 </span>Successfully tagged silly_secrets:local
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="c1"># Image built. Let&#39;s run it and see if our secret file is visible.</span>
<span class="lineno">20 </span>owner@darkstar$&gt; docker run --rm -it silly_secrets:local ls -a /
<span class="lineno">21 </span>.   .dockerenv  boot  etc   lib    lib64   media  opt   root  sbin  sys  usr
<span class="lineno">22 </span>..  bin         dev   home  lib32  libx32  mnt    proc  run   srv   tmp  var
<span class="lineno">23 </span>
<span class="lineno">24 </span><span class="c1"># Hmm, looks like our file isn&#39;t in the final image. Let&#39;s dive deeper and</span>
<span class="lineno">25 </span><span class="c1"># inspect the individual layers.</span>
<span class="lineno">26 </span>owner@darkstar$&gt; docker <span class="nb">history</span> --no-trunc silly_secrets:local
<span class="lineno">27 </span>IMAGE                                                                     CREATED              CREATED BY                                                                                          SIZE      COMMENT
<span class="lineno">28 </span>sha256:092e3a86d50915fb48b4278716574b46cc2514bae8eaa48d6a2051cf59fd1a9b   About a minute ago   /bin/sh -c rm /super_secret.txt                                                                     0B
<span class="lineno">29 </span>sha256:db6b071129a483ca39a6b8e367ea7a2af63ff057acfcdc5a70e5bad8c00be768   About a minute ago   /bin/sh -c apt update -y <span class="o">&amp;&amp;</span>     apt install -y         cowsay     <span class="o">&amp;&amp;</span>     apt clean -y               <span class="m">75</span>.6MB
<span class="lineno">30 </span>sha256:0df172df41b168cd1ec523591c0b2e603210ced2f85a427247b093e87c377be8   About a minute ago   /bin/sh -c <span class="c1">#(nop) ADD file:8401e4e245be4f0e09057e36a6ef99968758e9152fb5acbcb66fcadf5f2cc224 in /    38B</span>
<span class="lineno">31 </span>sha256:1318b700e415001198d1bf66d260b07f67ca8a552b61b0da02b3832c778f221b   <span class="m">12</span> days ago          /bin/sh -c <span class="c1">#(nop)  CMD [&quot;bash&quot;]                                                                     0B</span>
<span class="lineno">32 </span>&lt;missing&gt;                                                                 <span class="m">12</span> days ago          /bin/sh -c <span class="c1">#(nop) ADD file:524e8d93ad65f08a0cb0d144268350186e36f508006b05b8faf2e1289499b59f in /    72.8MB</span>
<span class="lineno">33 </span>
<span class="lineno">34 </span><span class="c1"># Well: that looks interesting: some stage of the build is deleting a</span>
<span class="lineno">35 </span><span class="c1"># &quot;secret&quot; file? Let&#39;s try running the intermediate container (i.e. just</span>
<span class="lineno">36 </span><span class="c1"># before the deletion step).</span>
<span class="lineno">37 </span>owner@darkstar$&gt; docker run --rm -it db6b071129a483ca39a6b8e367ea7a2af63ff057acfcdc5a70e5bad8c00be768 ls -a /
<span class="lineno">38 </span>.           bin   etc   lib32   media  proc  sbin              sys  var
<span class="lineno">39 </span>..          boot  home  lib64   mnt    root  srv               tmp
<span class="lineno">40 </span>.dockerenv  dev   lib   libx32  opt    run   super_secret.txt  usr
<span class="lineno">41 </span>
<span class="lineno">42 </span><span class="c1"># This bodes poorly for the developer.</span>
<span class="lineno">43 </span>owner@darkstar$&gt; docker run --rm -it db6b071129a483ca39a6b8e367ea7a2af63ff057acfcdc5a70e5bad8c00be768 cat /super_secret.txt
<span class="lineno">44 </span>One, <span class="k">if</span> by land, and two, <span class="k">if</span> by sea.
<span class="lineno">45 </span>
<span class="lineno">46 </span><span class="c1"># Oh dear: deleting the already-included file is just shy of useless in terms</span>
<span class="lineno">47 </span><span class="c1"># of security.</span>
</pre></div>
</div>
</div>
<p>In summary, avoid having credential files anywhere near your build jobs, employ
the use of masked credentials or more sophisticated techniques when supplying
credentials/tokens/keys to automated build jobs, and always keep in mind that
the concept of “deleting files from containers” is a misnomer.</p>
</div>
<div class="section" id="verify-downloaded-packages-via-checksums">
<h3>Verify Downloaded Packages via Checksums<a class="headerlink" href="#verify-downloaded-packages-via-checksums" title="Permalink to this headline">¶</a></h3>
<p>I’ve encountered numerous online examples (among the few times I won’t provide
a citation, out of courtesy primarily) where packages (some secure, legitimate,
and safe to use; some not quite so much) are provided online in the form of a
tarball or pre-compiled binary, and the author encourages the end-user to
simply install it via something like so:</p>
<div class="literal-block-wrapper docutils container" id="id120">
<div class="code-block-caption"><span class="caption-number">Listing 68 </span><span class="caption-text">Example of how <strong>not</strong> to safely install software.</span><a class="headerlink" href="#id120" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span>wget http://this***-site-is-safe-i-promise.xyz/totally_not_a_virus.tar.gz
<span class="lineno">2 </span>tar -zxf totally_not_a_virus.tar.gz
<span class="lineno">3 </span>make
<span class="lineno">4 </span>sudo make install
</pre></div>
</div>
</div>
<p>Yeah: don’t do this. Even if we trust the author, there’s always the chance an
attacker has potentially compromised some piece of the chain of communication
between where that file is hosted, and us (man-in-the-middle attack, hosting
provider has been compromised, supply chain attack results in malware being
embedded in the tarball, etc.). If we’re going to pull a file off the internet
an embed it into our Docker image as part of an automated build, we should at
least do a minimal security assessment of the payload (i.e. tarball) via
checksum analysis.</p>
<div class="literal-block-wrapper docutils container" id="id121">
<div class="code-block-caption"><span class="caption-number">Listing 69 </span><span class="caption-text">Download Go binaries for x64 - the safe way.</span><a class="headerlink" href="#id121" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="c1"># URL of the file we want to download.</span>
<span class="lineno"> 2 </span><span class="nv">PAYLOAD_URL</span><span class="o">=</span><span class="s2">&quot;https://golang.org/dl/go1.16.7.linux-amd64.tar.gz&quot;</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1"># sha256sum (don&#39;t use older checksums like Md5) of the package, as provided</span>
<span class="lineno"> 5 </span><span class="c1"># by the maintainer. We accessed these value via HTTPS with no security</span>
<span class="lineno"> 6 </span><span class="c1"># warnings, we&#39;re reasonably certain the maintainer is reliable and has a</span>
<span class="lineno"> 7 </span><span class="c1"># secure infrastructure, etc.</span>
<span class="lineno"> 8 </span><span class="nv">PAYLOAD_SUM</span><span class="o">=</span><span class="s2">&quot;7fe7a73f55ba3e2285da36f8b085e5c0159e9564ef5f63ee0ed6b818ade8ef04&quot;</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1"># Pull the payload.</span>
<span class="lineno">11 </span>wget <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PAYLOAD_URL</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="c1"># Validate the checksums (of type SHA256).</span>
<span class="lineno">14 </span><span class="c1"># There are better ways to templatize, prettify, automated, etc.; this step.</span>
<span class="lineno">15 </span><span class="c1"># This is just to provide a minimal, readable example.</span>
<span class="lineno">16 </span><span class="nv">DOWNLOADED_SUM</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>sha256sum go1.16.7.linux-amd64.tar.gz <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f1<span class="k">)</span><span class="s2">&quot;</span>
<span class="lineno">17 </span>
<span class="lineno">18 </span><span class="c1"># Compare, and proceed if the checksum we calculated matches what we</span>
<span class="lineno">19 </span><span class="c1"># expected.</span>
<span class="lineno">20 </span><span class="nb">echo</span> <span class="s2">&quot;Expected checksum: </span><span class="si">${</span><span class="nv">PAYLOAD_SUM</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">21 </span><span class="nb">echo</span> <span class="s2">&quot;Received checksum: </span><span class="si">${</span><span class="nv">DOWNLOADED_SUM</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">22 </span><span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PAYLOAD_SUM</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">DOWNLOADED_SUM</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">23 </span>    <span class="nb">echo</span> <span class="s2">&quot;Checksums match. Proceed with build job.&quot;</span>
<span class="lineno">24 </span><span class="k">else</span>
<span class="lineno">25 </span>    <span class="nb">echo</span> <span class="s2">&quot;Checksum failure: aborting build job.&quot;</span>
<span class="lineno">26 </span>    <span class="nb">exit</span> <span class="m">1</span>
<span class="lineno">27 </span><span class="k">fi</span>
</pre></div>
</div>
</div>
<p>This is an important concept to keep in mind: even if we completely trust the
maintainer and provider of an external package, there are numerous venues for
an attacker to take advantage of that trust and put a “mine in the pipeline” if
care is not taken for all dependencies pulled into your images (e.g.
supply-chain attacks in this particular case).</p>
<p>One final note: <strong>don’t run these checks in a</strong> <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>, <strong>run them in a
pre-build script or a</strong> <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> <strong>first</strong>. I’ve seen a number of examples
online where such operations are executed in a <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>, and it’s just
increasing the overall size of the image (and number of layers) drastically for
no reason at all. Prepare all your artifacts in advance, add them to a
permit-list in the form of a <code class="docutils literal notranslate"><span class="pre">.dockerignore</span></code> file, and <strong>then</strong> run your
<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code> operation against your <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>. The performance metric
gains alone will be their own reward.</p>
</div>
<div class="section" id="additional-reading">
<h3>Additional Reading<a class="headerlink" href="#additional-reading" title="Permalink to this headline">¶</a></h3>
<p>I would encourage the reader to start with <span id="id49">[<a class="reference internal" href="references.html#id29" title="Sven Vetsch et al., OWASP Foundation. OWASP Container Security Verification Standard. \url https://owasp.org/www-project-container-security-verification-standard/migrated_content, accessed 2021-08-08.">35</a>]</span> and <span id="id50">[<a class="reference internal" href="references.html#id30" title="Dirk Wetter et al., OWASP Foundation. OWASP Docker Top 10. \url https://owasp.org/www-project-docker-top-10/, accessed 2021-08-08.">36</a>]</span>,
and from there, broaden one’s research independently. The materials referenced
in the aforementioned citations also contain a plethora of relevant security
knowledge, and also merit the attention of the reader. From that point, I leave
it to the reader to begin their own foray into security research on the topics
of Docker, containers, and cloud native development.</p>
<p>Additionally, I encourage readers to visit the Reproducible Builds community
<span id="id51">[<a class="reference internal" href="references.html#id43" title="The Reproducible Builds Team. Reproducible Builds. \url https://reproducible-builds.org/, accessed 2021-08-23.">37</a>]</span>, as there is considerable overlap (in my own opinion)
between the material presented in this chapter, and the methods and goals
presented by the aforementioned.</p>
<p>Lastly, I encourage those engaged in researching and learning about cloud
native security to consider reaching out to the members of the <a class="reference internal" href="glossary.html#term-CNCF"><span class="xref std std-term">CNCF</span></a>
Security Technical Advisory Group, “<a class="reference internal" href="glossary.html#term-TAG"><span class="xref std std-term">TAG</span></a> Security” <span id="id52">[<a class="reference internal" href="references.html#id37" title="Cloud Native Computing Foundation. Cloud Native Security). \url https://github.com/cncf/tag-security, accessed 2021-08-03.">38</a>]</span>
via their Slack channel. (disclaimer: I volunteer with this group). I have
found it to be a courteous and knowledgable community, and when initially
joining the team’s Slack channel years back, I was able to get help from
community members in “knowing where to look” for answers to security-related
technical questions.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="architecture.html" class="btn btn-neutral float-right" title="Architecture Design Patterns" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="config_mgmt.html" class="btn btn-neutral float-left" title="Configuration Management &amp; Infrastructure as Code" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Matthew Giassa.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>